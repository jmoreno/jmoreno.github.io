<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Javi Moreno]]></title>
  <link href="http://javimoreno.me/atom.xml" rel="self"/>
  <link href="http://javimoreno.me/"/>
  <updated>2014-04-06T23:57:51+00:00</updated>
  <id>http://javimoreno.me/</id>
  <author>
    <name><![CDATA[Javi Moreno]]></name>
    <email><![CDATA[javi@javimoreno.me]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
	<entry>
	  
		<title type="html"><![CDATA[Octoberry Pi]]></title>
		<link href="http://javimoreno.me/blog/2014/04/07/octoberry-pi/"/>
		
	  <updated>2014-04-07T09:30:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2014/04/07/octoberry-pi</id>
	  
	  <content type="html"><![CDATA[<p>Octopress mola pero tambi√©n tiene sus limitaciones. No es que yo sea un gran comunicador que est√° publicando art√≠culos continuamente pero a veces he echado de menos no poder publicar algo m√°s r√°pidamente o a una hora concreta. <br/>
Octopress es un blog est√°tico que se genera mediante unos scripts desarrollados en Ruby y que usa git para publicar en GitHub Pages, Heroku o sitios similares. Por eso normalmente se necesita un PC/mac.  <br/>
Quiz√° haya que ser muy friky para preferir hacer todo lo que voy a contar ahora y no usar wordpress pero, como dijo Steve McQueen en Los Siete Magn√≠ficos:</p>

<blockquote><p>Lo nuestro es el plomo.</p></blockquote>


<p>Claro, que un poco m√°s adelante, en la misma pel√≠cula tambi√©n dijo:</p>

<blockquote><p>En aquel momento parec√≠a una buena idea.</p></blockquote>




<!--more-->


<p>Este a√±o, los Reyes Magos me trajeron una Raspberry Pi. Si ya se que ya no est√° tan de moda pero despu√©s de una conversaci√≥n con <a href="http://twitter.com/jdortiz">Jorge Ortiz</a> all√° por Octubre me pic√≥ el gusanillo de usar este dispositivo para hacer pruebas de configuraci√≥n de un servidor Rails. Despu√©s, pensando en lo poco que consume, que puede estar siempre encendido, que soporta ssh,‚Ä¶ pens√© que a lo mejor esta era la forma de poder publicar cosas en el blog cuando no estuviera en casa.</p>

<h2>Organizaci√≥n: Borradores y Blog.</h2>

<p>Supongo que ya lo sabr√©is pero Octopress se apoya mucho en git. Inicialmente pens√© en tener toda la carpeta del proyecto en Dropbox para que estuviera sincronizado el contenido tanto en la Raspberry, como en el Mac, el iPhone o el iPad. Si esto funcionaba, lo √∫nico que tendr√≠a que hacer cuando hubiera terminado de escribir algo ser√≠a entrar en la RPi y hacer el <strong>deploy</strong> desde all√≠.  <br/>
No fue una buena idea, primero porque la RPi no es el m√°s r√°pido de los dispositivos y segundo porque la carpeta de un proyecto Octopress con la rama <strong>source</strong> tiene un n√∫mero de ficheros que tiende a infinito y Dropbox es genial excepto cuando tienes un n√∫mero muy grande de ficheros.  <br/>
El plan B fue tener una carpeta en Dropbox para los borradores, tener el repositorio del blog sincronizado tambi√©n con la Raspberry y mover los <strong>borradores</strong> al proyecto cuando fuera a publicar algo.</p>

<h2>Crear una carpeta de borradores en Dropbox.</h2>

<p>Pr√°cticamente todos los editores markdown que hay tanto para iPhone, como para iPad como para Mac permiten guardar en Dropbox. En mi caso particular uso iA Writer en el iPhone, Editorial en el iPad y nvAlt, iA Writer o Textmate en el Mac (seg√∫n me de). En todos estos editores puedo escribir los art√≠culos, en el iPad y en el Mac adem√°s puedo hacer la <strong>postproduci√≥n</strong> del post, es decir la maquetaci√≥n y uso de los plugins que aporta Octopress para que las entradas queden m√°s vitaminadas. Adem√°s, el tener todo en Dropbox me permite empezar a escribir en el Mac, seguir escribiendo en el iPhone mientras voy en el Metro y terminar de maquetar en el iPad (porque mola mucho usar Editorial).</p>

<p>Para poder usar Dropbox en la Raspberry me bas√© en <a href="http://raspi.tv/2013/how-to-use-dropbox-with-raspberry-pi">esta entrada</a>. Es importante destacar que Dropbox en la Raspberry todav√≠a no funciona (y no se si alg√∫n d√≠a funcionar√°) como funciona en nuestros dispositivos habituales: no hay sincronizaci√≥n. <a href="https://github.com/andreafabrizi/Dropbox-Uploader">Dropbox Uploader</a> lo que permite es descargar, subir, borrar, crear directorios y dem√°s historias pero la sincronizaci√≥n es algo que, si lo quieres, te lo tienes que currar tu. En mi caso, con la descarga de Dropbox a la Raspberry es suficiente.</p>

<h2>GitHub, Bitbucket y ramas remotas.</h2>

<p>Aunque este blog est√° hospedado en GitHub, el repositorio completo (Octopress consta de dos ramas: <strong>master</strong> y <strong>source</strong>) est√° alojado en Bitbucket. No es que tenga nada que ocultar, simplemente que tengo cosas a medio escribir que no me apetece que se vean hasta que est√©n terminadas.
Para poder usar Octopress en la Raspberry Pi si ya tienes el blog en alg√∫n repositorio remoto, lo √∫nico que hay que hacer es crear una clave ssh en la Raspberry (<a href="https://help.github.com/articles/generating-ssh-keys">en GitHub tienen muy buenos tutoriales de como hacerlo</a>), vincular esta clave tanto al repositorio de Bitbucket como al de GitHub y disfrutar: ya podemos clonar, hacer pull, hacer push y todas esas cosas que hacen que Octopress mole tanto. Como a todos los efectos es una nueva instalaci√≥n. Cuando clonamos el proyecto tenemos que hacer el &#8220;bundle install&#8221; y volver a configurar el sistema de despliegue. Con las <a href="http://octopress.org/docs/deploying/">instrucciones del sitio de Octopress</a> es m√°s que suficiente.</p>

<h2>El proceso de publicaci√≥n.</h2>

<p>Creo que todav√≠a no lo hab√≠a dicho pero en todo momento he estado accediendo a la Raspberry v√≠a ssh. Si usas git y octopress no deber√≠as tenerle ning√∫n miedo al terminal por lo que acceder v√≠a ssh al dispositivo no ser√° tampoco un problema. Para facilitarme un poco la tarea me he creado una serie de scripts para las situaciones que me puedo encontrar con m√°s frecuencia:</p>

<ol>
<li>Descargar los borradores y previsualizar</li>
<li>Publicar lo que haya en la Raspberry</li>
<li>Descargar los borradores y publicar</li>
<li>Descargar el repositorio y previsualizar</li>
<li>Descargar el repositorio y publicar</li>
</ol>


<p>En todos los casos, despu√©s de publicar se hace commit en el repositorio y se suben los cambios a los servidores remotos.</p>

<figure class='code'><figcaption><span>quickpost.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./Dropbox-Uploader/dropbox_uploader.sh download ./drafts/
</span><span class='line'>mv ./drafts/*.markdown ./blog/source/_posts
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'><span class="nb">cd </span>blog
</span><span class='line'>rake generate
</span><span class='line'>rake deploy
</span><span class='line'>git add .
</span><span class='line'>git commit -m <span class="s2">&quot;Nuevo publicaci√≥n con quickpost.sh&quot;</span>
</span><span class='line'>git push origin <span class="nb">source</span>
</span></code></pre></td></tr></table></div></figure>


<p>El script anterior descarga los ficheros que est√©n en la carpeta de <em>borradores</em>. A continuaci√≥n, mueve los ficheros con extensi√≥n <em>markdown</em> a la carpeta donde se guardan los art√≠culos en Octopress. Acto seguido genera la nueva versi√≥n del blog y lo publica. Para que los cambios sean accesibles desde cualquier lugar hace <code>commit</code>en la rama source y la sube al repositorio remoto. Por supuesto, cualquiera de estos pasos puede fallar. Si eso sucede el script se detiene y aqu√≠ no ha pasado nada.</p>

<p>El resto de scripts, giran sobre la misma idea, en algunos casos se detienen en la generaci√≥n y hacen un preview, en otros casos lo que hacen es hacer un <code>pulo</code> al repositorio remoto,‚Ä¶</p>

<figure class='code'><figcaption><span>gitpost.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">set</span> -e
</span><span class='line'><span class="nb">cd </span>blog
</span><span class='line'>git pull origin <span class="nb">source</span>
</span><span class='line'>rake generate
</span><span class='line'>rake deploy
</span><span class='line'>git add .
</span><span class='line'>git commit -m <span class="err">&quot;</span>Nuevo publicaci√≥n con gitpost.sh‚Äù
</span><span class='line'>git push origin <span class="nb">source</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>quickpreview.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">set</span> -e
</span><span class='line'>./Dropbox-Uploader/dropbox_uploader.sh download ./drafts/
</span><span class='line'>mv ./drafts/*.markdown ./blog/source/_posts
</span><span class='line'><span class="nb">cd </span>blog
</span><span class='line'>rake generate
</span><span class='line'>rake preview
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>quickdeploy.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">set</span> -e
</span><span class='line'><span class="nb">cd </span>blog
</span><span class='line'>rake generate
</span><span class='line'>rake deploy
</span><span class='line'>git add .
</span><span class='line'>git commit -m <span class="s2">&quot;Nuevo publicaci√≥n con quickdeploy.sh&quot;</span>
</span><span class='line'>git push origin <span class="nb">source</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>gitpreview.sh </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">set</span> -e
</span><span class='line'><span class="nb">cd </span>blog
</span><span class='line'>git pull origin <span class="nb">source</span>
</span><span class='line'>rake generate
</span><span class='line'>rake preview
</span></code></pre></td></tr></table></div></figure>


<h2>Wherever I may roam</h2>

<p>Y aqu√≠ llega el punto por el que decid√≠ montar todo este tinglado: tenemos el repositorio del blog clonado en la Raspberry Pi, hemos creado una serie de scripts para facilitar el proceso de descarga y publicaci√≥n. Para poder publicar en cualquier momento y all√° donde nos encontremos solo nos faltan dos cosas: poder acceder a la Raspberry desde fuera de la red local y tener una aplicaci√≥n en el iPhone o en el iPad que permitan hacer un ssh.</p>

<p>Lo primero lo he resuelto con <a href="http://www.noip.com">no-ip</a> un servicio gratuito que mediante la instalaci√≥n de un paquete en la Raspberry y la configuraci√≥n de una cuenta nos permite acceder a nuestra red como si de un servicio web se tratara. Ya no recuerdo cual es el tutorial que us√© yo para configurarlo pero cualquiera que aparece al buscar ‚Äúno-ip raspberry‚Äù en Google valdr√°. Es algo extremadamente sencillo.</p>

<p>Y para lo segundo, hac√≠a ya bastante tiempo que le hab√≠a echado el ojo a <a href="https://itunes.apple.com/es/app/prompt/id421507115?mt=8">Prompt</a> de la gente de <a href="http://www.panic.com">Panic</a>. Quiz√° sea una aplicaci√≥n cara (cuesta 7‚Ç¨) pero cumple su cometido a la perfecci√≥n.</p>

<h2>Conclusi√≥n.</h2>

<p>Puede parecer una soluci√≥n muy rebuscada pero cualquiera que se anime a repetir mis pasos encontrar√° que el proceso es muy sencillo.  <br/>
Sobre el exceso de ‚Äúingenier√≠a‚Äù para publicar el blog, la √∫nica disculpa que puedo poner es que Octopress/Jekyll me gusta mucho y quiero que sea mi sistema de blogging durante mucho tiempo. No le hago ascos a otros sistemas como Tumblr (y alg√∫n proyecto tengo por ah√≠ que saldr√° mediante ese servicio) o Medium (bastante de moda ahora) pero Octopress sigue siendo mi favorito. Adem√°s, llevo tiempo pensado en darle un giro al blog y tener una manera de publicar art√≠culos est√© donde est√© o de forma ‚Äúprogramada‚Äù mediante <code>crontab</code> me dar√≠a mucha agilidad.</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Tweets autom√°ticos con Octopress]]></title>
		<link href="http://javimoreno.me/blog/2014/04/04/tweets-automaticos-con-octopress/"/>
		
	  <updated>2014-04-04T01:21:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2014/04/04/tweets-automaticos-con-octopress</id>
	  
	  <content type="html"><![CDATA[<p>Ultimamente estoy dedicando mi tiempo libre (cada d√≠a m√°s escaso) a automatizar ciertas tareas que Octopress, por su naturaleza est√°tica, no permite realizar. En este post explico como acabar con una de mis mayores frustraciones: poner un tweet autom√°ticamente cada vez que publico un art√≠culo usando Karmacracy como acortador.</p>

<!--more-->


<p>A mi me gusta mucho Karmacracy. No es que tenga una especial fijaci√≥n por controlar el n√∫mero de clicks que se hacen a los enlaces que comparto pero si se trata de enlaces a este blog me gusta tener un &#8220;peque√±o control&#8221; del n√∫mero de clicks.</p>

<p>Hasta ahora lo que hac√≠a era compartir mediante el bot√≥n de Karmacracy la entrada que acababa de publicar. Me ha estado funcionando muy bien todo este tiempo pero llevo dandole vueltas a una automatizaci√≥n del proceso de publicaci√≥n y estar pendiente para darle a un bot√≥n no es lo m√°s autom√°tico del mundo.</p>

<p>Empec√© a estudiar otras posibilidades como IFTTT que automatizan la publicaci√≥n de un tweet cuando detectan cambios en un rss. Eso habr√≠a estado fant√°stico si IFTTT permitiera configurar que &#8220;acortador&#8221; quieres usar pero los enlaces compartidos de esta manera ya est√°n acortados por IFTTT&#8230; una pena.</p>

<p>Finalmente, despu√©s de dar muchas vueltas he decidido tirar por la via dura y crear una tarea en el <code>rakefile</code> de Octopress que se encargue de la publicaci√≥n del tweet. Para no publicar un tweet por cada post cada vez que desplegaba el blog a√±ado a un <code>hash</code> cada enlace que se ha publicado.</p>

<figure class='code'><figcaption><span>Task para compartir un enlace por Twitter </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">La</span> <span class="n">primera</span> <span class="n">versi</span><span class="err">√≥</span><span class="n">n</span> <span class="n">de</span> <span class="n">esta</span> <span class="n">tarea</span> <span class="n">es</span> <span class="n">la</span> <span class="ss">siguiente</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;set permalinks, get the short url from karmacracy and share it with Twitter&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:share_with_twitter</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Twitter config (for tweeting posts)</span>
</span><span class='line'>  <span class="n">client</span> <span class="o">=</span> <span class="ss">Twitter</span><span class="p">:</span><span class="ss">:REST</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">consumer_key</span>        <span class="o">=</span> <span class="s2">&quot;TU_CONSUMER_KEY&quot;</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">consumer_secret</span>     <span class="o">=</span> <span class="s2">&quot;TU_CONSUMER_SECRET&quot;</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">access_token</span>        <span class="o">=</span> <span class="s2">&quot;TU_ACCESS_TOKEN&quot;</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">access_token_secret</span> <span class="o">=</span> <span class="s2">&quot;TU_ACCESS_TOKEN_SECRET&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">source_dir</span><span class="si">}</span><span class="s2">/tweets.info&quot;</span>
</span><span class='line'>    <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">source_dir</span><span class="si">}</span><span class="s2">/tweets.info&quot;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="vi">@tweets</span> <span class="o">=</span> <span class="ss">Marshal</span><span class="p">:</span><span class="ss">:load</span><span class="p">(</span><span class="n">f</span><span class="p">)}</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="vi">@tweets</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="vi">@tweets</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">source_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">posts_dir</span><span class="si">}</span><span class="s2">/**&quot;</span> <span class="p">)</span><span class="o">.</span><span class="n">each</span><span class="p">{</span> <span class="o">|</span><span class="n">post</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">tweet_posted</span> <span class="o">=</span> <span class="vi">@tweets</span><span class="o">.</span><span class="n">detect</span> <span class="p">{</span><span class="o">|</span><span class="n">tweet</span><span class="o">|</span> <span class="n">tweet</span><span class="o">[</span><span class="s2">&quot;post&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="n">post</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">tweet_posted</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">#get frontmatter</span>
</span><span class='line'>      <span class="n">stream</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span> <span class="n">post</span> <span class="p">)</span>
</span><span class='line'>      <span class="n">frontmatter</span> <span class="o">=</span> <span class="ss">YAML</span><span class="p">:</span><span class="ss">:load</span><span class="p">(</span> <span class="n">stream</span> <span class="p">)</span>
</span><span class='line'>      <span class="n">stream</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">#get permalink</span>
</span><span class='line'>      <span class="n">post_time_frontmatter</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">_strptime</span><span class="p">(</span><span class="n">frontmatter</span><span class="o">[</span><span class="s2">&quot;date&quot;</span><span class="o">]</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-%d %H:%M&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">post_time</span> <span class="o">=</span> <span class="no">Date</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">post_time_frontmatter</span><span class="o">[</span><span class="ss">:year</span><span class="o">]</span><span class="p">,</span><span class="n">post_time_frontmatter</span><span class="o">[</span><span class="ss">:mon</span><span class="o">]</span><span class="p">,</span><span class="n">post_time_frontmatter</span><span class="o">[</span><span class="ss">:mday</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="n">post_title</span> <span class="o">=</span> <span class="n">frontmatter</span><span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="n">post_link</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\d{4}-\d{2}-\d{2}-/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;.markdown&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">source_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">posts_dir</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">permalink</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">blog_url</span><span class="si">}</span><span class="s2">blog/</span><span class="si">#{</span><span class="n">post_time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/%d&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">post_title</span><span class="o">.</span><span class="n">to_url</span><span class="si">}</span><span class="s2">/&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">#short permalink with karmacracy</span>
</span><span class='line'>      <span class="n">kcyshorter</span> <span class="o">=</span> <span class="s2">&quot;http://kcy.me/api/?u=TU_USUARIO_DE_KARMACRACY78&amp;key=TU_KEY_DE_KARMACRACY&amp;url=</span><span class="si">#{</span><span class="no">CGI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">permalink</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">result</span> <span class="o">=</span> <span class="ss">Net</span><span class="p">:</span><span class="ss">:HTTP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">kcyshorter</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Tweet</span>
</span><span class='line'>      <span class="n">tweet_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s2">&quot;He escrito </span><span class="se">\&quot;</span><span class="si">#{</span><span class="n">post_title</span><span class="si">}</span><span class="se">\&quot;</span><span class="s2">: </span><span class="si">#{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">#</span>
</span><span class='line'>      <span class="n">tweet</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;post&quot;</span> <span class="o">=&gt;</span> <span class="n">post</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span> <span class="o">=&gt;</span> <span class="n">post_title</span><span class="p">,</span> <span class="s2">&quot;klink&quot;</span> <span class="o">=&gt;</span> <span class="n">result</span><span class="p">,</span> <span class="s2">&quot;tweet&quot;</span> <span class="o">=&gt;</span> <span class="n">tweet_response</span><span class="o">[</span><span class="s2">&quot;uri&quot;</span><span class="o">]</span><span class="p">}</span>
</span><span class='line'>      <span class="vi">@tweets</span> <span class="o">&lt;&lt;</span> <span class="n">tweet</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">source_dir</span><span class="si">}</span><span class="s2">/tweets.info&quot;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="vi">@tweets</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Si queremos que esta tarea se ejecuta cada vez que desplegamos el blog, lo √∫nico que hay que hacer es incluir al final de la tarea <code>:deploy</code> lo siguiente:</p>

<figure class='code'><figcaption><span>[] </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="ss">:share_with_twitter</span><span class="o">].</span><span class="n">execute</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y ya est√°, si todo ha funcionado perfectamente, al publicar esta entrada autom√°ticamente se ha publicado tambi√©n un tweet. ;-)</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[&rarr; Pow!! es poderoso!]]></title>
		<link href="http://pow.cx"/>
		
	  <updated>2014-02-25T02:13:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2014/02/25/pow-es-poderoso</id>
	  
	  <content type="html"><![CDATA[<p>Pow!! es la t√≠pica cosa que nunca has necesitado pero que una vez la has probado ya no puedes vivir sin ella. No hay nada malo en escribir http://localhost seguido del puerto por donde sirve tu aplicaci√≥n pero&#8230; ¬øa qu√© ser√≠a todo m√°s f√°cil si pudieras llamar a tus proyectos web tambi√©n por su nombre en tu m√°quina local? Pues bien, Pow!! se encarga de eso.</p>

<!--more-->


<p>La instalaci√≥n es super sencilla: <code>$ curl get.pow.cx | sh</code> en tu terminal y ya esta listo para funcionar. A continuaci√≥n entras en el directorio de pow con <code>$ cd ~/.pow</code> y generas un enlace simbolico a la carpeta donde se encuentra tu aplicaci√≥n: <code>$ ln -s /path/to/myapp</code>. A partir de este momento ya podr√°s acceder a tu aplicaci√≥n simplemente escribiendo <code>http://myapp.dev</code> en tu navegador.</p>

<p>Funciona sin problemas con Rails, Sinatra o Padrino. Con Octopress tienes que tener la precauci√≥n de regenerar los contenidos cada vez que haces alg√∫n cambio pero por lo dem√°s va estupendamente.</p>

<p>Eso s√≠, no te dejes enga√±ar por su aparente sencillez, Pow!! tiene muchisimas opciones que seguro cubrir√°n tu necesidad.</p>
<a rel="full-article" href="http://javimoreno.me/blog/2014/02/25/pow-es-poderoso/">&#9823; Permalink</a>]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[&rarr; Jugando a ser John Gruber]]></title>
		<link href="http://octopress.org/docs/blogging/linklog/"/>
		
	  <updated>2014-02-25T01:30:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2014/02/25/jugando-a-ser-john-gruber</id>
	  
	  <content type="html"><![CDATA[<p>En el fondo, una parte de mi desea ser un guru. Por eso estoy haciendo experimentos con Octopress para poder publicar enlaces al m√°s puro estilo <a href="http://www.marco.org">Marco Arment</a> o <a href="http://daringfireball.net">Daring Fireball</a>.  <br/>
Mi √∫nica duda es si usar un signo de infinito, una estrella negra de cinco puntas o un caracter emoji para los permalinks. Creo que ese simbolo debe representar el tipo de contenido que genera el autor. üòú</p>
<a rel="full-article" href="http://javimoreno.me/blog/2014/02/25/jugando-a-ser-john-gruber/">&#9823; Permalink</a>]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Workflows de Editorial para Octopress]]></title>
		<link href="http://javimoreno.me/blog/2014/01/26/workflows-de-editorial-para-octopress/"/>
		
	  <updated>2014-01-26T00:59:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2014/01/26/workflows-de-editorial-para-octopress</id>
	  
	  <content type="html"><![CDATA[<p>He estado creando una serie de workflows en <a href="https://itunes.apple.com/es/app/editorial/id673907758?mt=8">Editorial</a> que creo ser√°n de gran ayuda a todos los que usen esta fant√°stica herramienta de edici√≥n para iPad al escribir las entradas de su blog Octopress.</p>

<!--more-->


<p>Aunque Octopress se basta y se sobra con textos en markdown, tiene una serie de plugins muy potentes que son de gran ayuda para insertar citas, v√≠deos, im√°genes, tweets embebidos o c√≥digo fuente.  <br/>
Yo me he centrado en lo que me hac√≠an falta para los <em>posts</em> que suelo escribir pero como podr√©is ver, una vez hecho el primero, el resto son sota, caballo y rey.</p>

<p>Os dejo los enlaces por s√≠ les quer√©is echar un ojo.</p>

<ul>
<li><a href="http://editorial-app.appspot.com/workflow/5252485694357504/5M7iTYKP5ak">Creacion de fichero <em>octopress</em> a partir de fichero <em>markdown</em></a></li>
<li><a href="http://editorial-app.appspot.com/workflow/5309436960702464/jobUl19TzXk">Marca de continuaci√≥n. (&#8220;Seguir leyendo&#8221;)</a></li>
<li><a href="http://editorial-app.appspot.com/workflow/6341637861015552/zFyzbnTW9QY">Texto seleccionado como cita</a></li>
<li><a href="http://editorial-app.appspot.com/workflow/5269098627858432/7jGKDINoyJQ">Texto seleccionado como c√≥digo fuente</a></li>
<li><a href="http://editorial-app.appspot.com/workflow/5877028700028928/9eyEep5t6f4">Texto seleccionado como gist embebido</a></li>
<li><a href="http://editorial-app.appspot.com/workflow/5795046364282880/fc1_oaplErs">URL seleccionada como tweet embebido</a></li>
</ul>


<h2>¬øC√≥mo se usan?</h2>

<p>Pues para empezar, hay que escribir todo el post en markdown en un fichero sin extensi√≥n cuyo nombre sea el t√≠tulo que va a tener el post. ¬øUn poco cutre? Es mi workflow, ¬øqu√© pasa?
Si se hace de esta forma, el primer workflow creara un fichero octopress a la primera.</p>

<p>El segundo workflow no tiene mucho misterio, inserta el <em>excerp</em> donde le digamos.</p>

<p>El resto transforma esto:</p>

<p>Las rosas son rosas, el cielo es azul y t√∫ eres t√∫.</p>

<p>puts &#8220;Hello, world!&#8221;</p>

<p>5467313</p>

<p>https://twitter.com/jmoreno78/statuses/427223495794520064</p>

<p>En esto otro:</p>

<blockquote><p>Las rosas son rosas, el cielo es azul y t√∫ eres t√∫.</p><footer><strong>Un poeta urbano</strong></footer></blockquote>




<figure class='code'><figcaption><span>Hola mundo en COBOL.   </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Hello, world!&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<div><script src='https://gist.github.com/5467313.js'></script>
<noscript><pre><code>&lt;html&gt;&lt;body&gt;You are being &lt;a href=&quot;https://github.com/gist/5467313&quot;&gt;redirected&lt;/a&gt;.&lt;/body&gt;&lt;/html&gt;</code></pre></noscript></div>




<div class='embed tweet'><blockquote class="twitter-tweet"><p>Despu√©s de llevar un tiempo en el dique seco, creo que la semana que viene voy a publicar bastantes posts. Delirios todo, por supuesto. üòÑ</p>&mdash; Javi Moreno (@jmoreno78) <a href="https://twitter.com/jmoreno78/statuses/427223495794520064">January 25, 2014</a></blockquote>
<script async src="http://javimoreno.me//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>Mola, ¬øeh?</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Padrinos y vacunas]]></title>
		<link href="http://javimoreno.me/blog/2013/11/11/padrinos-y-vacunas/"/>
		
	  <updated>2013-11-11T01:31:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/11/11/padrinos-y-vacunas</id>
	  
	  <content type="html"><![CDATA[<blockquote><p>Le har√© una oferta que no podr√° rechazar.</p><footer><strong>Vito Corleone</strong> <cite>El Padrino</cite></footer></blockquote>


<p>En la misma pel√≠cula de la que he sacado esta cita se dice que los italianos piensan que el mundo es tan duro que hay que tener dos padres y por eso todos tienen un padrino. Quiz√° esto es lo que pensaron los desarrolladores del nuevo framework del que me he hecho fan, Padrino, por que el nombre le viene que ni pintado.</p>

<!--more-->


<p>Creo que mi b√∫squeda del backend perfecto empieza a ser preocupante y enfermiza. Vaya por delante que lo que yo busco es algo que me sirva para aplicaciones m√≥viles, que pueda tener una peque√±a interfaz web y que me deje ver la base de datos, que a mi me gusta mucho el SQL, para que nos vamos a enga√±ar.</p>

<p>Ruby on Rails siempre me ha parecido una buena opci√≥n ya que es relativamente sencillo y con pocos pasos puedes tener mucho del desarrollo hecho. Si a eso le a√±ades la versatilidad que tiene para mostrar los datos en HTML, XML o json tienes un gran complemento para dispositivos m√≥viles. Sin embargo reconozco que para devolver un peque√±o json no es necesario montar el pifostio que se monta con Rails.</p>

<p>En el otro extremo est√° Sinatra. Es sencillo, mucho m√°s orientado a montar API&#8217;s pero tambi√©n te permite crear interfaces. La principal ventaja es que reduce a la m√≠nima expresi√≥n lo que hay que escribir para que un servicio funcione. Sin embargo, puede llegar un momento en el que te canses de tanta sencillez y manualidad.</p>

<p>Padrino est√° justo en el medio de Rails y Sinatra. Esta construido sobre Sinatra pero incorpora utilidades que hacen m√°s eficiente el desarrollo. S√≥lo una curiosidad, este post hacia bastante tiempo que pensaba escribirlo. Incialmente iba a hacerlo en Rails (hace a√±o y pico), luego pens√© en hacerlo en Sinatra (hace meses). Descubr√≠ Padrino la semana pasada y aqu√≠ esta terminado. De la noche a la ma√±ana he encontrado el framework que mejor se adapta a mis necesidades particulares.</p>

<p>Bueno, despu√©s del co√±azo que he soltado vamos a ver si hacemos algo m√°s interesante como, por ejemplo, resolver uno de los problemas m√°s graves de la paternidad: saber que vacuna le toca a tu hijo/a en la pr√≥xima revisi√≥n.</p>

<h2>Calendario de vacunaciones.</h2>

<p>Por s√≠ no lo sab√©is, el calendario de vacunaci√≥n infantil se basa en recomendaciones de la OMS que el Ministerio de Sanidad en colaboraci√≥n con la Asociaci√≥n Nacional de Pediatr√≠a estudia y presenta para que, posteriormente, las consejer√≠as de sanidad de cada comunidad aut√≥noma organicen como les de la gana. Esto hace que en Espa√±a haya 19 calendarios diferentes que, adem√°s, suelen cambiar cada tres cuatro a√±os.</p>

<p>El objetivo de nuestra aplicaci√≥n web ser√° devolver un json con los 19 calendarios actualizados. Para ellos, nuestra aplicaci√≥n necesitar√° de un panel de administraci√≥n con el que actualiz√°remos las cinco tablas que forman el modelo de datos.</p>

<p><img src="http://javimoreno.me/images/photos/2013/diagram.png"></p>

<p>No voy a entrar en muchos detalles sobre el modelo. La primera tabla es la de pa√≠ses, inicialmente solo esta Espa√±a pero creo que el modelo es extensible a cualquier pa√≠s. Un pa√≠s puede tener varios calendarios&#8230; como en Espa√±a, que es una locura. Cada calendario tendr√° una serie de eventos y cada evento tendr√°, entre otros datos, una edad, una vacuna. Edades y Vacunas tambi√©n son entidades del modelo de datos.</p>

<h3>Creaci√≥n del proyecto</h3>

<p>Siguiendo la estela de Rails, Padrino tiene generadores que nos vendr√°n muy bien en diferentes fases del desarrollo. El primero que utilizaremos es el que permite crear el proyecto.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>padrino g project VacScheduler -t shoulda -e haml -c sass -s jquery -d activerecord -b
</span></code></pre></td></tr></table></div></figure>


<p>La mejor forma de saber que significan todos estos t√©rminos es mirar la <a href="http://www.padrinorb.com/guides/generators">documentaci√≥n de Padrino sobre los generadores</a>. Yo he puesto todo esto, no porque sea un listillo, sino porque para hacer est√° aplicaci√≥n me he fusilado el <a href="http://www.padrinorb.com/guides/blog-tutorial">tutorial sobre como hacer un blog</a>.  <br/>
Basicamente, hemos creado un proyecto llamado VacScheduler que usa shoulda para el testing, haml para el renderizado de las p√°ginas, sass para los estilos, jquery para la parte de scripting y activerecord para el orm. Adem√°s, cuando termine la creaci√≥n del proyecto, forzaremos una instalaci√≥n de las gemas que nos faltan con Bundle.</p>

<h3>Creaci√≥n del panel de administraci√≥n (esto har√° las delicias de m√°s de uno)</h3>

<p>Una gran diferencia con respecto a Rails es que, en Padrino han pensado que la existencia de un grupo de usuarios encargados de mantener las tablas que forman el modelo de la aplicaci√≥n es un escenario lo suficientemente habitual como para crear una funcionalidad de Administraci√≥n. A nosotros esto nos viene genial porque lo que queremos es tener una aplicaci√≥n que devuelva una versi√≥n actualizada de los diferentes calendarios de vacunaci√≥n y para actualizar esos datos tendremos a un usuario responsable de dicho mantenimiento. Las instrucciones para crear el panel de administraci√≥n son las siguientes:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>padrino g admin --theme warehouse
</span><span class='line'><span class="nv">$ </span>bundle install
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>padrino rake ar:create
</span><span class='line'><span class="nv">$ </span>padrino rake ar:migrate
</span><span class='line'><span class="nv">$ </span>padrino rake seed
</span></code></pre></td></tr></table></div></figure>


<p>Este √∫ltimo paso nos pedir√° un correo electr√≥nico y una contrase√±a para poder acceder al panel de administraci√≥n. Si despu√©s de hacer esto, arrancamos la aplicaci√≥n podremos ver el bonito panel de administraci√≥n.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>padrino start
</span></code></pre></td></tr></table></div></figure>


<h3>Creaci√≥n de los modelos</h3>

<p>Si estuvi√©ramos en Rails, generar√≠amos un scaffold. Padrino no tiene scaffold&#8230; o si? igual nos llevamos una sorpresa m√°s adelante.  <br/>
De momento vamos a crear los modelos de las cinco tablas que forman nuestro modelo de datos.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>padrino g model age short_name:string name:string months:integer -a app
</span><span class='line'><span class="nv">$ </span>padrino g model calendar name:string country_id:integer -a app
</span><span class='line'><span class="nv">$ </span>padrino g model country name:string -a app
</span><span class='line'><span class="nv">$ </span>padrino g model event notes:text calendar_id:integer age_id:integer vaccine_id:integer -a app
</span><span class='line'><span class="nv">$ </span>padrino g model vaccine short_name:string name:string description:text link_info:string -a app
</span></code></pre></td></tr></table></div></figure>


<p>y hacemos la migraci√≥n correspondiente para crear las entidades en la base de datos:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>padrino rake ar:migrate
</span></code></pre></td></tr></table></div></figure>


<h3>Modificaci√≥n de los modelos para incluir las relaciones y validaciones</h3>

<p>Sobre los modelos que nos ha creado Padrino, hacemos las modificaciones oportunas para indicar las relaciones entre las entidades as√≠ como los campos que son obligatorios:</p>

<figure class='code'><figcaption><span>Age.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Age</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>    <span class="n">has_many</span> <span class="ss">:events</span>
</span><span class='line'>    <span class="n">validates_presence_of</span> <span class="ss">:short_name</span>
</span><span class='line'>    <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'>    <span class="n">validates_presence_of</span> <span class="ss">:months</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Calendar.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Calendar</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>    <span class="n">has_many</span> <span class="ss">:events</span>
</span><span class='line'>    <span class="n">belongs_to</span> <span class="ss">:country</span>
</span><span class='line'>    <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Country.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Country</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>    <span class="n">has_many</span> <span class="ss">:calendars</span>
</span><span class='line'>    <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Event.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Event</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>    <span class="n">belongs_to</span> <span class="ss">:calendar</span>
</span><span class='line'>    <span class="n">belongs_to</span> <span class="ss">:age</span>
</span><span class='line'>    <span class="n">belongs_to</span> <span class="ss">:vaccine</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Vaccine.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Vaccine</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>    <span class="n">has_many</span> <span class="ss">:events</span>
</span><span class='line'>    <span class="n">validates_presence_of</span> <span class="ss">:short_name</span>
</span><span class='line'>    <span class="n">validates_presence_of</span> <span class="ss">:name</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Creaci√≥n de los paneles de administraci√≥n de cada uno de los modelos anteriores</h3>

<p>Esto es lo que me ha ganado de Padrino. Las admin_page son unas pantallas de mantenimiento de datos semejantes a las creadas al hacer un scaffold de Rails pero vinculadas al panel de administraci√≥n. Es decir, que solo ser√°n visibles si est√°s autenticado en el sistema. Parece una chorrada, pero para hacer esto en Rails hay que picar un poquito.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>padrino g admin_page age
</span><span class='line'><span class="nv">$ </span>padrino g admin_page calendar
</span><span class='line'><span class="nv">$ </span>padrino g admin_page country
</span><span class='line'><span class="nv">$ </span>padrino g admin_page event
</span><span class='line'><span class="nv">$ </span>padrino g admin_page vaccine
</span></code></pre></td></tr></table></div></figure>


<p>Cuando refresquemos, veremos algo tan bonito como esto:</p>

<p><img src="http://javimoreno.me/images/photos/2013/padrino-admin-1.png"></p>

<p><img src="http://javimoreno.me/images/photos/2013/padrino-admin-2.png"></p>

<p><img src="http://javimoreno.me/images/photos/2013/padrino-admin-3.png"></p>

<h3>Un JSON con todos los calendarios.</h3>

<p>El objetivo de la aplicaci√≥n es enviar un JSON con la versi√≥n m√°s actual de todos y cada uno de los calendarios para que una aplicaci√≥n m√≥vil refresque su base de datos y pueda informar a sus usuarios de cuales son las pr√≥ximas vacunas que tienen que poner a sus criaturas. <br/>
Ahora es cuando nos aprovechamos de que Padrino est√° montado sobre Sinatra y escribimos el siguiente trozo de c√≥digo en app.rb:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">get</span> <span class="s2">&quot;/&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Country</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="ss">:include</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:calendars</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                            <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:events</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                                <span class="ss">:include</span> <span class="o">=&gt;</span> <span class="o">[</span>
</span><span class='line'>                                    <span class="p">{</span> <span class="ss">:vaccine</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:short_name</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:link_info</span><span class="o">]</span><span class="p">}},</span>
</span><span class='line'>                                    <span class="p">{</span> <span class="ss">:age</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:months</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:short_name</span><span class="o">]</span><span class="p">}}</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>                                <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="ss">:notes</span><span class="p">}},</span>
</span><span class='line'>                            <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="o">]</span> <span class="p">}},</span>
</span><span class='line'>                        <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y listo, con este <em>sencillo</em> fragmento de c√≥digo toda la funcionalidad <em>publica</em> de nuestra aplicaci√≥n web est√° construida. Ya podemos llamar desde la aplicaci√≥n.</p>

<p>Si quer√©is echar un vistazo, en Heroku (como no) est√° instalada est√° misma aplicaci√≥n: <a href="http://vacscheduler.herokuapp.com">VacScheduler</a>. He tenido algunos problemitas con la codificaci√≥n en la base de datos as√≠ que, si no lo he arreglado antes, ver√©is algunos <em>c√≥digo extra√±os</em> donde deber√≠a haber tildes.</p>

<p>El c√≥digo fuente de dicha aplicaci√≥n lo pod√©is ver en <a href="https://github.com/jmoreno/VacScheduler">GitHub</a>.</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Adios Keynote, hola reveal.js]]></title>
		<link href="http://javimoreno.me/blog/2013/10/05/adios-keynote/"/>
		
	  <updated>2013-10-05T03:07:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/10/05/adios-keynote</id>
	  
	  <content type="html"><![CDATA[<p>El d√≠a que empec√© a preparar la presentaci√≥n <a href="http://slides.helios.javimoreno.me">Helios y su integraci√≥n en iOS</a> me pregunt√© si habr√≠a alguna forma de utilizar markdown con Keynote. Iban a ser unas cuantas diapositivas de texto y manejar t√≠tulos, negritas, cursivas, listas, links,&#8230; con markdown me parec√≠a triunfal. Despu√©s de una b√∫squeda r√°pida en Google y ver un par de enlaces descubr√≠ <a href="https://github.com/hakimel/reveal.js">reveal.js</a>&#8230; y decid√≠ no volver a abrir Keynote nunca m√°s.</p>

<!--more-->


<p>La <a href="http://lab.hakim.se/reveal-js/#/">presentaci√≥n de ejemplo</a> ya te da una idea general de toda la potencia de este framework. Inicialmente, a mi me bastaba con poder reutilizar un fichero en markdown en la presentaci√≥n y al ver que dentro de cada <code>section</code>, que es como se identifican las <em>slides</em>, se pod√≠a introducir texto en markdown me daba por satisfecho. Luego segu√≠ navegando y vi que, en realidad, pod√≠a utilizar un texto entero en markdown ya que con una ser√≠e de convenciones en la escritura y arrancando reveal.js como una aplicaci√≥n node.js, esta aplicaci√≥n se encargaba de generar la presentaci√≥n completa&#8230; reveal.js FTW!</p>

<h2>Atajos de teclado</h2>

<p>Un poco m√°s adelante explicar√© como hacer que reveal.js lea de un fichero <code>.md</code> pero antes quiero destacar la funcionalidad de reveal.js accesible a trav√©s de teclado.</p>

<ul>
<li>Avance de diapositivas. Una caracter√≠stica muy llamativa de reveal.js es que las presentaciones tienen dos dimensiones. Estamos acostumbrados a avanzar y a retroceder pero con este framework tambi√©n podemos subir y bajar. Esto, desde mi punto de vista, es muy √∫til cuando quieres ampliar la informaci√≥n de una diapositiva en varias diapositivas m√°s. En el eje horizontal (avance-retroceso) estar√≠an las diapositivas principales y algunas de ellas podr√≠an tener un eje vertical (arriba-abajo). La navegaci√≥n se controla con las teclas de cursor pero si la presentaci√≥n se visualiza en un dispositivo t√°ctil el control de la navegaci√≥n se hace con el dedo. Impresionante, no?</li>
<li>Vistazo general. Pulsando la tecla <em>escape</em> se hace un zoom y puedes ver todas las diapositivas en miniatura lo que te permite navegar m√°s r√°pidamente a una en concreto. Adem√°s, en caso de que tengas secciones de diapositivas (grupos en vertical) puedes ver la diapositiva que se mostrar√≠a en un flujo de navegaci√≥n horizontal.</li>
<li>Modo Pausa. Pulsando la tecla &#8220;b&#8221; se hace un fundido a negro, de esta forma puedes forzar al p√∫blico a centrar su atenci√≥n en ti en lugar de hacerlo sobre la presentaci√≥n. Para salir de la <em>pausa</em> hay que volver a pulsar la &#8220;b&#8221;.</li>
<li>Pantalla completa. Pulsando la tecla &#8220;f&#8221;</li>
</ul>


<p>Nada que envidiar a los programas t√≠picos de presentaciones como Powerpoint (perd√≥n por ponerlo en primer lugar) o Keynote.</p>

<h2>Funcionalidad avanzada</h2>

<p>Tener reveal.js dentro de una aplicaci√≥n node.js tambi√©n te permite visualizar las notas del presentador y alguna otra funcionalidad m√°s sofisticada como sincronizar la presentaci√≥n con todos los que la est√©n viendo al mismo tiempo que tu en sus dispositivos, actualizar el contenido de las diapositivas en tiempo real, etc..
La verdad es que toda esas funcionalidades pintan muy bien pero yo lo √∫nico que quer√≠a era:</p>

<h2>¬°Una presentaci√≥n hecha con markdown!</h2>

<p>Hay que destacar que, al combinar reveal.js con un fichero .md donde est√°n recogidas todas las diapositivas no se explota toda la potencia del framework como las diferentes transiciones, enlaces internos, colores de fondo diferentes, im√°genes de fondo diferentes, vistas fragmentadas, etc. En mi humilde opini√≥n, abusar de las transiciones, cambios de colores o de im√°genes suele cargar bastante una presentaci√≥n, pero vamos, que eso es cuesti√≥n de gustos. <br/>
Si que ech√© de menos el no poder hacer vistas fragmentadas. Espero que en alguna pr√≥xima versi√≥n den con la forma de hacerlo. Al menos la agrupaci√≥n de diapositivas y las notas si que est√° disponibles y eso es para m√≠ algo digno de menci√≥n. Para que os hag√°is una idea, este es el coraz√≥n de mi presentaci√≥n: el fichero <a href="https://github.com/jmoreno/HeliosTalk/blob/master/presentation.md">presentation.md</a>.</p>

<h2>¬øC√≥mo hice mi presentaci√≥n?</h2>

<p>Lo primero que hice fue clonar el repositorio original de <a href="https://github.com/hakimel/reveal.js">reveal.js</a> y cambiar el fichero index.html. La mayor parte de la presentaci√≥n estar√≠a en el fichero markdown pero en la primera diapositiva quer√≠a usar una vista fragmentada (de esas en las que las frases o las palabras van apareciendo poco a poco). Debido a esto, el c√≥digo de mi presentaci√≥n quedar√≠a as√≠:</p>

<figure class='code'><figcaption><span>Fragmento HTML para definir la presentaci√≥n</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;reveal&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c">&lt;!-- Any section element inside of this container is displayed as a slide --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;slides&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;section&gt;</span>
</span><span class='line'>            <span class="nt">&lt;h1&gt;</span>Helios<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>            <span class="nt">&lt;h2&gt;</span>y su integraci√≥n en iOS<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>            <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">&quot;fragment fade-in&quot;</span><span class="nt">&gt;</span>¬øEs <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://twitter.com/mattt&quot;</span><span class="nt">&gt;</span>@mattt<span class="nt">&lt;/a&gt;&lt;/small&gt;</span> una persona o una legi√≥n?<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>            <span class="nt">&lt;p&gt;</span>
</span><span class='line'>                <span class="nt">&lt;small&gt;</span>Created by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://javimoreno.me&quot;</span><span class="nt">&gt;</span>Javier Moreno<span class="nt">&lt;/a&gt;</span> / <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://twitter.com/jmoreno78&quot;</span><span class="nt">&gt;</span>@jmoreno78<span class="nt">&lt;/a&gt;&lt;/small&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/p&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/section&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;section</span> <span class="na">data-markdown=</span><span class="s">&quot;presentation.md&quot;</span> <span class="na">data-separator=</span><span class="s">&quot;^\n\n\n&quot;</span> <span class="na">data-vertical=</span><span class="s">&quot;^\n\n&quot;</span> <span class="na">data-notes=</span><span class="s">&quot;^Note:&quot;</span> <span class="na">data-charset=</span><span class="s">&quot;UTF-8&quot;</span><span class="nt">&gt;&lt;/section&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;section&gt;</span>
</span><span class='line'>            <span class="nt">&lt;h1&gt;</span>THE END<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>            <span class="nt">&lt;h3&gt;</span>BY Javier Moreno / javimoreno.me<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>            <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">&quot;fragment fade-in&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                <span class="nt">&lt;small&gt;</span>Created by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://javimoreno.me&quot;</span><span class="nt">&gt;</span>Javier Moreno<span class="nt">&lt;/a&gt;</span> / <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://twitter.com/jmoreno78&quot;</span><span class="nt">&gt;</span>@jmoreno<span class="nt">&lt;/a&gt;&lt;/small&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/p&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/section&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Eso es todo, aparentemente tres diapositivas. La secci√≥n que se nutre de un fichero markdown tiene los siguientes atributos:</p>

<ul>
<li><code>data-markdown</code>: La ubicaci√≥n del fichero</li>
<li><code>data-separator</code>: Lo que vaya a identificar la separaci√≥n entre diapositivas horizontales. En mi caso, tres l√≠neas en blanco.</li>
<li><code>data-vertical</code>: Lo que vaya a identificar la separaci√≥n entre diapositivas verticales. En mi caso, dos l√≠neas en blanco.</li>
<li><code>data-notes</code>: Lo que identifique que el texto a continuaci√≥n no es parte visual de la diapositivas si no de las notas.</li>
<li><code>data-charset</code>: Muy importante para nosotros, que usamos muchos caracteres especiales como tildes, e√±es, signos de interrogaci√≥n y admiraci√≥n el poner UTF-8.</li>
</ul>


<p>Y eso es todo, si ech√°is un vistazo al fichero <a href="https://github.com/jmoreno/HeliosTalk/blob/master/presentation.md">presentation.md</a> comprobar√©is lo que acabo de comentar.</p>

<p>Una vez hecho esto, para probarlo en local hay que tener instalado <a href="http://nodejs.org">node.js</a> y <a href="http://gruntjs.com/getting-started#installing-the-cli">grunt</a>. Si ya tenemos estos servicios instalados lo √∫nico que hay que hacer es ir hasta la carpeta donde est√° reveal, instalar las dependencias con <code>$ npm install</code> y arrancar la presentaci√≥n con <code>$ grunt serve</code>. La presentaci√≥n se ver√° en <a href="http://localhost:8000">http://localhost:8000</a>.</p>

<h2>Despliegue en Heroku.</h2>

<p>Si hacer lo anterior me llevo un rato de nada, conseguir desplegar en Heroku me llev√≥ un mes: sub√≠ con √©xito el martes y la presentaci√≥n a los asistentes de la NSCoderMAD fue el mi√©rcoles.  <br/>
Lo primero que prob√© fue desplegar tal y como estaba la aplicaci√≥n: fue un fracaso. Por lo visto <em>grunt</em> est√° muy bien para entornos de desarrollo pero los hosting de node.js prefieren otras cosas. B√∫squedas en Google hablan de versiones diferentes de la Heroku Toolbet para desplegar aplicaciones node.js con grub pero a mi no me funcion√≥ ninguna de las recomendaciones que encontr√©.</p>

<p>A √∫ltima hora encontr√© este <a href="https://github.com/willy-vvu/reveal.js">fork de reveal.js</a> que se pod√≠a previsualizar en Heroku y de ah√≠ tom√© las configuraciones que necesitaba para que funcionar√° mi presentaci√≥n en Heroku.</p>

<p>Lo primero fue crear un fichero llamado <code>server.js</code> con el siguiente contenido:</p>

<figure class='code'><figcaption><span>Fichero server.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span>
</span><span class='line'>  <span class="p">,</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">,</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">,</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">,</span><span class="nx">mime</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mime&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="o">||</span><span class="mi">5000</span><span class="p">);</span>
</span><span class='line'><span class="kd">function</span> <span class="nx">handler</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">pathname</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="nx">uri</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">uri</span><span class="o">=</span><span class="s1">&#39;/index.html&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">uri</span><span class="o">=</span><span class="nx">uri</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/%20/g</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">uri</span><span class="p">)</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="nx">uri</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span>
</span><span class='line'>      <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;Error loading file...&#39;</span><span class="p">);</span>            
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-type&#39;</span><span class="p">,</span><span class="nx">mime</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">uri</span><span class="p">));</span>
</span><span class='line'>      <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>  <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Este fichero contiene la informaci√≥n m√≠nima que node.js necesita para arrancar la aplicaci√≥n. Para que lea de este fichero, hubo que modificar el fichero <code>Procfile</code></p>

<figure class='code'><figcaption><span>Fichero Procfile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>web: node server.js
</span></code></pre></td></tr></table></div></figure>


<p>Y por √∫ltimo, cambiar el fichero de dependencias <code>package.json</code>:</p>

<figure class='code'><figcaption><span>Fichero package.json</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;author&quot;</span><span class="p">:</span> <span class="s2">&quot;Javi Moreno featuring (reveal.js by Hakim El Hattab)&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;revealjs&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Helios y su integraci√≥n con iOS&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;2.5.1&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;repository&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;git&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;git@github.com:jmoreno/HeliosTalk.git&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;engines&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;node&quot;</span><span class="p">:</span> <span class="s2">&quot;0.8.x&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="nt">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;mime&quot;</span><span class="p">:</span><span class="s2">&quot;1.2.7&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;npm&quot;</span><span class="p">:</span><span class="s2">&quot;1.2.x&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ya solo quedaba hacer commit y seguir los pasos para desplegar en Heroku:</p>

<ol>
<li><code>$ heroku create</code></li>
<li><code>$ git push heroku master</code></li>
<li><code>$ heroku open</code></li>
</ol>


<p>No os pod√©is hacer a la idea de la alegr√≠a que me llev√©.</p>

<h2>Para acabar</h2>

<p>Creo que, en su momento, este tweet no se entendi√≥:</p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p>Si no me falla el valor, la presentaci√≥n que estoy haciendo para la <a href="https://twitter.com/nscoder_mad">@nscoder_mad</a> se podr√° ver en slideshare, Github y Heroku‚Ä¶</p>&mdash; Javi Moreno (@jmoreno78) <a href="https://twitter.com/jmoreno78/statuses/377465465054191616">September 10, 2013</a></blockquote>
<script async src="http://javimoreno.me//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>Como al final no me falt√≥ el valor, ah√≠ est√° la presentaci√≥n: en <a href="http://www.slideshare.net/jmoreno78/helios-y-su-integracin-en-i-os">slideshare</a>, <a href="https://github.com/jmoreno/HeliosTalk">Github</a> y <a href="http://slides.helios.javimoreno.me/#/">Heroku</a>. \o/</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Markdown]]></title>
		<link href="http://javimoreno.me/blog/2013/07/06/markdown/"/>
		
	  <updated>2013-07-06T16:10:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/07/06/markdown</id>
	  
	  <content type="html"><![CDATA[<p>Hay dos cosas que recomendar√≠a a todo el mundo que tuviera que escribir <em>frecuentemente</em> en un ordenador:</p>

<ol>
<li>Aprender mecanograf√≠a.</li>
<li>Aprender <a href="http://daringfireball.net/projects/markdown/">markdown</a>.</li>
</ol>


<!--more-->


<p>Yo aprend√≠ mecanograf√≠a con 18 o 19 a√±os‚Ä¶ cuando empec√© con memorias, pr√°cticas y otros trabajos universitarios. Markdown lo aprend√≠ hace poco, con 34 a√±os, y creo que no he aprendido nada que me ayude a ganar tanto tiempo en mi d√≠a a d√≠a entre medias. Markdown te permite confeccionar un documento con t√≠tulos, negritas, cursivas, listas, listas num√©ricas, tablas, citas, hiperv√≠nculos,‚Ä¶ sin levantar las manos del teclado para ir al trackpad (o al rat√≥n, el que lo use ;-P).</p>

<p>Principalmente lo utilizo en cuatro escenarios.</p>

<ol>
<li>En el trabajo. Los documentos funcionales, inventarios, y otros documentos que har√≠a con un procesador de texto los hago en markdown.</li>
<li>En este blog. Todas las entradas de este blog est√°n escritas en markdown.</li>
<li>En los proyectos de desarrollo <em>caseros</em>. Intento siempre tener un readme.md tanto si voy a colgar el proyecto en Github como si no.</li>
<li>En mis notas. Cualquier nota, Tanto si es para acordarme de como se hace un enlace simb√≥lico como si es para tener un inventario de cuentas y tarjetas las escribo en markdown.</li>
</ol>


<p>Desde mi punto de vista, para utilizar markdown solo necesitas dos cosas: un editor de texto y un programa que transforme markdown en formato enriquecido para ver cual ser√° el resultado final.</p>

<p>En el trabajo, donde tengo que lidiar con Windows, uso <a href="http://markdownpad.com">MarkdownPad</a>, un programa que tiene dos ventanas: una para escribir en markdown y otra para visualizar lo que estas escribiendo en formato enriquecido.</p>

<p>En casa tengo algo m√°s de l√≠o. Inicialmente, todo lo hac√≠a con <a href="http://www.sublimetext.com">Sublime Text</a>. Cuando empece a preocuparme por previsualizar los documentos descubr√≠ Mou, un programa muy semejante a MarkdownPad pero para Mac. Con <a href="http://mouapp.com">Mou</a> me empece a interesar por la previsualizaci√≥n y as√≠ es como descubr√≠ <a href="http://markedapp.com">Marked</a>, un programa dedicado a la previsualizaci√≥n de documentos en markdown y con utilidades para la exportaci√≥n a HTML, RTF, pdf, etc.</p>

<p>Siguiendo el rastro a Marked, descubr√≠ que su desarrollador tambi√©n ten√≠a un programita para escribir en markdown basado en <a href="http://notational.net">Notational Velocity</a> (un programa del que hab√≠a o√≠do maravillas en 85% Cocoa): <a href="http://brettterpstra.com/projects/nvalt/">nvALT</a>. La integraci√≥n de nvALT con Marked fue lo que me anim√≥ a probarlo. nvALT trae su propio visualizador (bastante bueno y configurable, por cierto) pero yo prefiero usar Marked (no solo porque lo haya comprado, es que es realmente bueno).</p>

<p>Cualquiera que me conozca sabr√° que no me canso de probar herramientas y aunque la combinaci√≥n nvALT + Marked sigue siendo para mi la mejor, ahora estoy usando tambi√©n <a href="http://www.iawriter.com/mac/">iA Writer</a>. Aunque iA Writer tiene su propio visualizador (nvALT tambi√©n tiene el suyo), con automator y preferencias de teclado se puede hacer que el documento se previsualice en Marked (algo que, como ya he dejado claro antes, para mi es imprescindible).</p>

<p>Tanto las notas, como las entradas del blog, son documentos que quiero tener disponibles cuando estoy en casa y tambi√©n en el iPhone y en el iPad. Si tienes iA Writer para iOS y para Mac puedes beneficiarte de la sincronizaci√≥n con iCloud aunque existiendo Dropbox y los enlaces simb√≥licos cualquier aplicaci√≥n es v√°lida.</p>

<h2>Bueno, con tanta herramienta, ¬øcu√°l es mi forma de trabajar?</h2>

<p>Actualmente, las notas las escribo en nvALT. Tengo todas las notas metidas en la misma carpeta porque la b√∫squeda de este programa es genial y adem√°s las etiquetas me permiten clasificar las notas. Esta carpeta es un enlace simb√≥lico a la carpeta de iCloud de iA Writer. De esta forma, puedo consultar y editar las notas en la versi√≥n para iOS que tengo en el iPhone y en el iPad de esta aplicaci√≥n. nvALT soporta sincronizaci√≥n con Simplenote por lo que s√≠ activas esta opci√≥n podr√°s tener la sincronizaci√≥n con iPhone y iPad sin tener que comprar iA Writer.  Si la carpeta donde nvALT va a buscar las notas est√° en Dropbox tambi√©n&#8230; mejor que mejor.</p>

<p>Las entradas del blog y los readme de los proyectos tambi√©n las sol√≠a escribir con nvALT cuando estaba en casa pero ahora estoy usando iA Writer. La experiencia de escribir es mucho mejor en iA Writer ya que da la sensaci√≥n de que estas solo con tu teclado frente a una hoja en blanco pero nvALT tiene unos atajos de teclado mucho m√°s √∫tiles, creo yo, sobre todo para dar formato al texto.    <br/>
Cuando termino de escribir los readme, copio el texto y lo pego en el fichero correspondiente. A partir de ah√≠, la edici√≥n la har√© desde el editor o IDE que toque en funci√≥n del proyecto: Sublime, Xcode o RubyMine.</p>

<p>Las entradas del blog las termino de editar en Sublime. El motivo es que Octopress tiene unas convenciones propias para im√°genes o c√≥digo fuente embebido que no me gusta como se previsualizan as√≠ que prefiero dejar esa edici√≥n para el momento previo a la publicaci√≥n.</p>

<p>Y ya esta, llamadme enrevesado pero esta es la forma m√°s c√≥moda que tengo de trabajar. ;-)</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Helios III. Piratas y bucaneros.]]></title>
		<link href="http://javimoreno.me/blog/2013/05/22/helios-iii-piratas-y-bucaneros/"/>
		
	  <updated>2013-05-22T06:54:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/05/22/helios-iii-piratas-y-bucaneros</id>
	  
	  <content type="html"><![CDATA[<blockquote><p>El puerto espacial de Mos Eisley. No encontrar√°s nunca un lugar como √©ste tan lleno de maldad y vileza. Debemos cuidarnos.</p><footer><strong>Star Wars</strong> <cite>Ben Kenobi Llegando a Mos Eisley Con Luke Skywalker</cite></footer></blockquote>


<p>Para esta tercera entrega volvemos a basarnos en unos art√≠culos de Rafa Aguilar (aka <a href="http://twitter.com/rais38">@rais38</a>), recien publicados en <a href="http://objective-c.es">Objective-C.es</a>, donde primero nos explica las <a href="http://objective-c.es/in-app-purchases-en-ios-parte-1/">categor√≠as y tipos de In-App Purchases</a> y despu√©s <a href="http://objective-c.es/in-app-purchases-en-ios-parte-2/">nos ense√±a con un ejemplo</a> lo sencillo que es incorporar a una aplicaci√≥n esta excelente fuente de ingresos.    <br/>
Nosotros aqu√≠ vamos a ver como simplifica CargoBay el uso de IAP en nuestras aplicaciones y tambi√©n a verificar si la compra se ha realizado correctamente por el m√©todo m√°s seguro: un servidor con Helios.</p>

<!--more-->


<p>He de reconocer que a medida que he ido avanzando en el an√°lisis de Helios he ido apreciando la bien que esta planteado y lo que puede suponer para un desarrollador que se quiera aventurar en la creaci√≥n de su propio backend. Cierto es que la primera parte, la que replica el modelo Core Data en el servidor me parece que est√° todav√≠a un poco floja, as√≠ como la sincronizaci√≥n entre los dispositivos y el backend. El soporte para notificaciones push est√° bien, todav√≠a le queda camino que recorrer pero es un buen punto de partida si quieres tener tu propio gestor de notificaciones. Pero con CargoBay y Venice, la gesti√≥n de las compras dentro de la aplicaci√≥n se simplifican una barbaridad.</p>

<p>CargoBay es una peque√±a librer√≠a de Mattt Thompson (del que no hemos hablado pr√°cticamente nada en este blog) que facilita la gesti√≥n de estas transacciones al reducir a unos pocos m√©todos con bloques la recuperaci√≥n de productos, comprobaci√≥n del estado de la compra as√≠ como la verificaci√≥n del recibo siguiendo las recomendaciones de Apple para evitar los fraudes en este tipo de compras.</p>

<p>Venice, es la gema que incluye Helios para realizar la verificaci√≥n del recibo en servidor (otra recomendaci√≥n de Apple para evitar fraudes). La otra funcionalidad que ofrece esta gema es devolver un listado de identificadores de IAP, esto ser√° muy √∫til cuando queramos cambiar la oferta de productos en nuestra aplicaci√≥n sin tener que actualizar la aplicaci√≥n v√≠a iTunes Connect. Para poder utilizar esta funcionalidad, nuestra aplicaci√≥n debe estar preparada para trabajar con todos los productos que le vayan a llegar por este servicio.</p>

<p>Con todo lo que ya sabemos gracias a Rafa, vamos a crear una aplicaci√≥n que nos permita contratar los servicios de los piratas y cazarecompensas que habitan Mos Eisley. Sabemos que nadie es de fiar en este lugar as√≠ que mejor que incluyamos un sistema de verificaci√≥n de las compras o nuestro jefe nos terminar√° dando de comer a un sarlacc (algo muy doloroso ya que recordemos que su digesti√≥n dura m√°s de mil a√±os).</p>

<p>Para probar algunas bondades de CargoBay vamos a hacer lo siguiente: En iTunes Connect vamos a crear las siguientes IAP tal y como nos ha <a href="">contado Rafa</a>:</p>

<table>
<thead>
<tr>
<th>Producto          </th>
<th> Identificador                             </th>
</tr>
</thead>
<tbody>
<tr>
<td>Han Solo          </td>
<td> com.cytdevteam.MosEisley.HanSolo</td>
</tr>
<tr>
<td>Chewbacca         </td>
<td> com.cytdevteam.MosEisley.Chewbacca</td>
</tr>
<tr>
<td>Millennium Falcon </td>
<td> com.cytdevteam.MosEisley.MillenniumFalcon</td>
</tr>
<tr>
<td>Modal Nodes       </td>
<td> com.cytdevteam.MosEisley.ModalNodes          </td>
</tr>
</tbody>
</table>


<p>En nuestro repositorio de productos de Helios vamos a crear estos cuatro productos y dos m√°s:</p>

<table>
<thead>
<tr>
<th>Producto          </th>
<th> Identificador                             </th>
</tr>
</thead>
<tbody>
<tr>
<td>Han Solo          </td>
<td> com.cytdevteam.MosEisley.HanSolo</td>
</tr>
<tr>
<td>Chewbacca         </td>
<td> com.cytdevteam.MosEisley.Chewbacca</td>
</tr>
<tr>
<td>Millennium Falcon </td>
<td> com.cytdevteam.MosEisley.MillenniumFalcon</td>
</tr>
<tr>
<td>Modal Nodes       </td>
<td> com.cytdevteam.MosEisley.ModalNodes</td>
</tr>
<tr>
<td>Greedo            </td>
<td> com.cytdevteam.MosEisley.Greedo</td>
</tr>
<tr>
<td>Boba Fett         </td>
<td> com.cytdevteam.MosEisley.BobaFett         </td>
</tr>
</tbody>
</table>


<p>Si echamos un vistazo a la documentaci√≥n de Helios, veremos que los √∫nicos m√©todos que ofrece para In-App Purchases son un GET de productos y un POST para comprobar recibos&#8230; ¬øC√≥mo grabamos entonces los productos en la tabla? pues como graban los hombres, con SQL directamente sobre la base de datos.</p>

<p>Creamos un nuevo fichero <em>HeliosTasks.rake</em> en nuestro proyecto para poder lanzarlo tanto en local como en servidor de forma manual y escribimos lo siguiente:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:HeliosTasks</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;TODO&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:loadIdentifiers</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">require</span> <span class="s1">&#39;pg&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
</span><span class='line'>      <span class="no">PGconn</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">5432</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">populate_products</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span><span class='line'>      <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM in_app_purchase_products;  -- empty contents of table</span>
</span><span class='line'><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</span><span class='line'><span class="s2">                           VALUES (1, &#39;com.cytdevteam.MosEisley.HanSolo&#39;, &#39;Consumable&#39;, &#39;Han Solo&#39;, &#39;Han Solo The One And Only&#39;, 0.99, &#39;USD&#39;, &#39;t&#39;);</span>
</span><span class='line'><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</span><span class='line'><span class="s2">                           VALUES (2, &#39;com.cytdevteam.MosEisley.Chewbacca&#39;, &#39;Consumable&#39;, &#39;Chewbacca&#39;, &#39;Chewbacca&#39;, 0.99, &#39;USD&#39;, &#39;t&#39;);</span>
</span><span class='line'><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</span><span class='line'><span class="s2">                           VALUES (3, &#39;com.cytdevteam.MosEisley.MillenniumFalcon&#39;, &#39;Consumable&#39;, &#39;Millennium Falcon&#39;, &#39;Millennium Falcon&#39;, 4.99, &#39;USD&#39;, &#39;t&#39;);</span>
</span><span class='line'><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</span><span class='line'><span class="s2">                           VALUES (4, &#39;com.cytdevteam.MosEisley.ModalNodes&#39;, &#39;Consumable&#39;, &#39;Modal Nodes&#39;, &#39;A real Modal Nodes` gig&#39;, 4.99, &#39;USD&#39;, &#39;t&#39;);</span>
</span><span class='line'><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</span><span class='line'><span class="s2">                           VALUES (5, &#39;com.cytdevteam.MosEisley.Greedo&#39;, &#39;Consumable&#39;, &#39;Greedo&#39;, &#39;A coward that shot first&#39;, 4.99, &#39;USD&#39;, &#39;t&#39;);</span>
</span><span class='line'><span class="s2">             INSERT INTO in_app_purchase_products (id, product_identifier, type, title, description, price, price_locale, is_enabled) </span>
</span><span class='line'><span class="s2">                           VALUES (6, &#39;com.cytdevteam.MosEisley.BobaFett&#39;, &#39;Consumable&#39;, &#39;Boba Fett&#39;, &#39;He is no good to me dead&#39;, 4.99, &#39;USD&#39;, &#39;t&#39;);&quot;</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">begin</span>
</span><span class='line'>      <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="s1">&#39;databaseName&#39;</span><span class="p">,</span><span class="s1">&#39;username&#39;</span><span class="p">,</span><span class="s1">&#39;password&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Connected to </span><span class="si">#{</span><span class="n">conn</span><span class="o">.</span><span class="n">db</span><span class="si">}</span><span class="s2"> at </span><span class="si">#{</span><span class="n">conn</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">populate_products</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="no">PGError</span><span class="o">=&gt;</span><span class="n">e</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Oh Oh!&quot;</span><span class="p">,</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">ensure</span>
</span><span class='line'>      <span class="n">conn</span><span class="o">.</span><span class="n">close</span> <span class="k">unless</span> <span class="n">conn</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Connection closed&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>No creo que os cueste mucho ver lo que hace: establece una conexi√≥n con la base de datos y a continuaci√≥n borra e inserta seis registros. Si hubiera alg√∫n error saldr√≠a por la consola.</p>

<p>Si ahora escribimos en un navegador <a href="http://localhost:3000/products/identifiers">http://localhost:3000/products/identifiers</a></p>

<p>ver√≠amos algo como esto:</p>

<p><img src="http://javimoreno.me/images/photos/2013/jsonResponse.png"></p>

<p>Ya hemos creado todas las IAP en iTunes Connect (que co√±azo) y hemos insertado los productos que vamos a ofrecer en nuestro servidor. Es el momento de liarnos la manta a la cabeza con la aplicaci√≥n.</p>

<p>Nos vamos a basar en la plantilla de Master-Detail con ARC, Storyboards y Core Data. La primera lista ser√°n las compras que hayamos realizado. En Storyboard a√±adiremos un nuevo navigation controller con un UITableViewController donde mostraremos los productos que se pueden comprar a trav√©s del App Store.</p>

<p>Si a estas alturas todav√≠a no usas CocoaPods deber√≠as hacerlo, es la forma m√°s f√°cil de gestionar las librer√≠as de terceros que usas en tus aplicaciones. En este caso, nuestro podfile incluir√° AFNetworking, CargoBay y NSData+Base64:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>platform :ios, '5.0'
</span><span class='line'>pod 'AFNetworking', '~> 1.2'
</span><span class='line'>pod 'CargoBay', '~> 0.3.2'
</span><span class='line'>pod 'NSData+Base64', '~> 1.0.0'</span></code></pre></td></tr></table></div></figure>


<h2>Un peque√±o expositor.</h2>

<p>Ya sabemos que lo primero que hay que hacer es comprobar si nuestra aplicaci√≥n tiene permiso para hacer compras dentro de la aplicaci√≥n. En caso afirmativo podremos acceder a nuestros servidores para recuperar la informaci√≥n de los productos que tenemos a la venta:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">viewDidLoad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">super</span> <span class="n">viewDidLoad</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Comprobamos si hay alguna restricci√≥n configurada en el device respecto a las In-App Purchases.</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="n">SKPaymentQueue</span> <span class="n">canMakePayments</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Puedo hacer pagos In-App&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="n">getProductsInStoreKitDirectlyFromHelios</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Control parental activado&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Para cargar el UITableView del viewController de productos necesitamos un array de productos. Toda la informaci√≥n del producto tal y como est√° en iTunes Connect la podemos obtener a trav√©s de StoreKit pero CargoBay nos proporciona unos m√©todos con bloques que recuperan est√° informaci√≥n. Podemos hacerlo de dos formas: recuperando primero la lista de identificadores y despu√©s pas√°ndole esta lista al m√©todo correspondiente:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getProductsIdentifiersInHelios</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://localhost:3000/products/identifiers/&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span><span class="n">url</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">AFJSONRequestOperation</span> <span class="nl">JSONRequestOperationWithRequest:</span><span class="n">request</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="n">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="kt">id</span> <span class="n">JSON</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">getProductsInStoreKitFromArray:</span><span class="n">JSON</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="n">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="kt">id</span> <span class="n">JSON</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">description</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getProductsInStoreKitFromArray:</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nv">array</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="nl">productsWithIdentifiers:</span><span class="p">[</span><span class="n">NSSet</span> <span class="nl">setWithArray:</span><span class="n">array</span><span class="p">]</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">products</span><span class="p">,</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">invalidIdentifiers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_productsArray</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">_productsArray</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableArray</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithCapacity:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Products: %@&quot;</span><span class="p">,</span> <span class="n">products</span><span class="p">);</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Invalid Identifiers: %@&quot;</span><span class="p">,</span> <span class="n">invalidIdentifiers</span><span class="p">);</span>
</span><span class='line'>        <span class="n">_productsArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nl">arrayWithArray:</span><span class="n">products</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>O bien, si tenemos la certeza que el servicio ya nos devuelve los datos en una array √∫nicamente con los identificadores (que es como espera CargoBay que se lo pasemos), podemos hacerlo todo en un √∫nico m√©todo:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">getProductsInStoreKitDirectlyFromHelios</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://localhost:3000/products/identifiers/&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLRequest</span> <span class="nl">requestWithURL:</span><span class="n">url</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="nl">productsWithRequest:</span><span class="n">request</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="n">products</span><span class="p">,</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">invalidIdentifiers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Products: %@&quot;</span><span class="p">,</span> <span class="n">products</span><span class="p">);</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Invalid Identifiers: %@&quot;</span><span class="p">,</span> <span class="n">invalidIdentifiers</span><span class="p">);</span>
</span><span class='line'>        <span class="n">_productsArray</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableArray</span> <span class="nl">arrayWithArray:</span><span class="n">products</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">tableView</span> <span class="n">reloadData</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error: %@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">description</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>En cualquiera de los dos casos, el resultado del log ser√° el siguiente:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>2013-05-15 16:14:48.275 MosEisley[3242:c07] Products: (
</span><span class='line'>    "&lt;SKProduct: 0x77ad230>",
</span><span class='line'>    "&lt;SKProduct: 0x82a5ab0>",
</span><span class='line'>    "&lt;SKProduct: 0x8267f70>",
</span><span class='line'>    "&lt;SKProduct: 0x8263400>"
</span><span class='line'>)
</span><span class='line'>2013-05-15 16:14:48.275 MosEisley[3242:c07] Invalid Identifiers: (
</span><span class='line'>    "com.cytdevteam.MosEisley.Greedo",
</span><span class='line'>    "com.cytdevteam.MosEisley.BobaFett"
</span><span class='line'>)</span></code></pre></td></tr></table></div></figure>


<p>Es decir, hemos recuperado seis registros de nuestro servidor de los cuales cuatro son productos correctos en iTunes Connect y dos no lo son. Solo mostraremos los productos correctos:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#pragma mark - Table view data source</span>
</span><span class='line'>
</span><span class='line'> <span class="o">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nl">numberOfSectionsInTableView:</span><span class="p">(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="c1">// Return the number of sections.</span>
</span><span class='line'>     <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="o">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nl">tableView:</span><span class="p">(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span> <span class="nl">numberOfRowsInSection:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="n">section</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="c1">// Return the number of rows in the section.</span>
</span><span class='line'>     <span class="k">return</span> <span class="p">[</span><span class="n">_productsArray</span> <span class="n">count</span><span class="p">];</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="o">-</span> <span class="p">(</span><span class="n">UITableViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nl">tableView:</span><span class="p">(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span> <span class="nl">cellForRowAtIndexPath:</span><span class="p">(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="n">indexPath</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">CellIdentifier</span> <span class="o">=</span> <span class="s">@&quot;Cell&quot;</span><span class="p">;</span>
</span><span class='line'>     <span class="n">UITableViewCell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">tableView</span> <span class="nl">dequeueReusableCellWithIdentifier:</span><span class="n">CellIdentifier</span> <span class="nl">forIndexPath:</span><span class="n">indexPath</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>     <span class="c1">// Configure the cell...</span>
</span><span class='line'>     <span class="n">SKProduct</span> <span class="o">*</span><span class="n">product</span> <span class="o">=</span> <span class="p">[</span><span class="n">_productsArray</span> <span class="nl">objectAtIndex:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">cell</span><span class="p">.</span><span class="n">textLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="p">.</span><span class="n">localizedTitle</span><span class="p">;</span>
</span><span class='line'>     <span class="n">cell</span><span class="p">.</span><span class="n">detailTextLabel</span><span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">product</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">;</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">cell</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Esta ser√°, m√°s o menos, la imagen de nuestro expositor:</p>

<p><img src="http://javimoreno.me/images/photos/2013/productsViewController.png"></p>

<p>Para realizar las compras, CargoBay no tiene ninguna utilidad desarrollada por el momento, la √∫nica diferencia con el tutorial de Rafa es que el observer no es necesario incluirlo aqu√≠ ya que lo vamos a hacer en el <code>(BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions</code> para que gestiones no solo estas compras si no tambi√©n las compras que pudieran haber quedado pendientes al cerrar la aplicaci√≥n:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#pragma mark - Table view delegate</span>
</span><span class='line'>
</span><span class='line'> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">tableView:</span><span class="p">(</span><span class="n">UITableView</span> <span class="o">*</span><span class="p">)</span><span class="n">tableView</span> <span class="nl">didSelectRowAtIndexPath:</span><span class="p">(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="n">indexPath</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="c1">// A√±adimos el producto que recibimos en el m√©todo delegado productsRequest:didReceiveResponse:</span>
</span><span class='line'>     <span class="n">SKPayment</span> <span class="o">*</span><span class="n">pago</span> <span class="o">=</span> <span class="p">[</span><span class="n">SKPayment</span> <span class="nl">paymentWithProduct:</span><span class="p">[</span><span class="n">_productsArray</span> <span class="nl">objectAtIndex:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">]];</span>
</span><span class='line'>     <span class="c1">// Nos a√±adimos a nosotros mismos como observadores de la transacci√≥n.</span>
</span><span class='line'> <span class="c1">//    [[SKPaymentQueue defaultQueue] addTransactionObserver:self];</span>
</span><span class='line'>     <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">addPayment:</span><span class="n">pago</span><span class="p">];</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Que no se pierda ni un recibo.</h2>

<p>Tal y como acabamos de comentar, el <em>observer</em> de la cola de pagos lo vamos a incluir en <code>(BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions</code> para que no se pierda ni una sola operaci√≥n. Adem√°s incluimos el bloque que se llamar√° cada vez que haya alguna actualizaci√≥n de una transacci√≥n:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didFinishLaunchingWithOptions:</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="nv">launchOptions</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Payment Queue Observation with CargoBay</span>
</span><span class='line'>    <span class="p">[[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="nl">setPaymentQueueUpdatedTransactionsBlock:</span><span class="o">^</span><span class="p">(</span><span class="n">SKPaymentQueue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="n">NSArray</span> <span class="o">*</span><span class="n">transactions</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Updated Transactions: %@&quot;</span><span class="p">,</span> <span class="n">transactions</span><span class="p">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">SKPaymentTransaction</span> <span class="o">*</span><span class="n">transaction</span> <span class="k">in</span> <span class="n">transactions</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">switch</span> <span class="p">(</span><span class="n">transaction</span><span class="p">.</span><span class="n">transactionState</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="k">case</span> <span class="nl">SKPaymentTransactionStatePurchased:</span>
</span><span class='line'>                    <span class="p">[</span><span class="n">self</span> <span class="nl">oneStepVerification:</span><span class="n">transaction</span><span class="p">];</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="k">case</span> <span class="nl">SKPaymentTransactionStateFailed:</span>
</span><span class='line'>                         <span class="c1">// TODO</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="k">case</span> <span class="nl">SKPaymentTransactionStateRestored:</span>
</span><span class='line'>                         <span class="c1">// TODO</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>                <span class="k">default</span><span class="o">:</span>
</span><span class='line'>                    <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">addTransactionObserver:</span><span class="p">[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Override point for customization after application launch.</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cuando la transacci√≥n pase a un estado de <em>purchased</em> es cuando deberemos realizar las acciones derivadas de la compra, antes de hacer nada es cuando deber√≠amos asegurarnos de que el recibo es verdadero. Las dos opciones que tenemos son verificar dentro de la propia aplicaci√≥n accediendo a un servicio de Apple o llamar a un servicio nuestro que realice ese mismo acceso. Para el primer caso, CargoBay ya nos proporciona un m√©todo que realiza esa verificaci√≥n:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">oneStepVerification:</span><span class="p">(</span><span class="n">SKPaymentTransaction</span> <span class="o">*</span><span class="p">)</span><span class="nv">transaction</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[[</span><span class="n">CargoBay</span> <span class="n">sharedManager</span><span class="p">]</span> <span class="nl">verifyTransaction:</span><span class="n">transaction</span> <span class="nl">password:</span><span class="nb">nil</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="n">receipt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Receipt: %@&quot;</span><span class="p">,</span> <span class="n">receipt</span><span class="p">);</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span> <span class="nl">serverSideVerification:</span><span class="n">transaction</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Error %d (%@)&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">error</span> <span class="n">code</span><span class="p">],</span> <span class="p">[</span><span class="n">error</span> <span class="n">localizedDescription</span><span class="p">]);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Es de sobra conocido que tanto las IAP son f√°cilmente <em>pirateables</em> y aunque la verificaci√≥n desde la propia aplicaci√≥n aumenta la seguridad de nuestras ventas, tambi√©n son conocidos los casos en los que esta verificaci√≥n tambi√©n ha sido <em>hackeada</em>. La otra utilidad de Venice es la realizaci√≥n de esta misma verificaci√≥n en nuestro servidor:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">serverSideVerification:</span><span class="p">(</span><span class="n">SKPaymentTransaction</span> <span class="o">*</span><span class="p">)</span><span class="nv">transaction</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://localhost:3000/receipts/verify&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSMutableURLRequest</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableURLRequest</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithURL:</span><span class="n">url</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">request</span> <span class="nl">setHTTPMethod:</span><span class="s">@&quot;POST&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSArray</span> <span class="o">*</span><span class="n">paths</span> <span class="o">=</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="n">YES</span><span class="p">);</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">documentsDirectory</span> <span class="o">=</span> <span class="p">[</span><span class="n">paths</span> <span class="nl">objectAtIndex:</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">appFile</span> <span class="o">=</span> <span class="p">[</span><span class="n">documentsDirectory</span> <span class="nl">stringByAppendingPathComponent:</span><span class="s">@&quot;TransactionReceipt&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">transaction</span><span class="p">.</span><span class="n">transactionReceipt</span> <span class="nl">writeToFile:</span><span class="n">appFile</span> <span class="nl">atomically:</span><span class="n">YES</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;receipt-data=%@&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">transaction</span><span class="p">.</span><span class="n">transactionReceipt</span> <span class="n">base64EncodedString</span><span class="p">]];</span>
</span><span class='line'>    <span class="n">NSData</span> <span class="o">*</span><span class="n">httpBody</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span> <span class="nl">dataUsingEncoding:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">request</span> <span class="nl">setHTTPBody:</span><span class="n">httpBody</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">NSURLConnection</span> <span class="nl">sendAsynchronousRequest:</span><span class="n">request</span> <span class="nl">queue:</span><span class="p">[</span><span class="n">NSOperationQueue</span> <span class="n">mainQueue</span><span class="p">]</span> <span class="nl">completionHandler:</span><span class="o">^</span><span class="p">(</span><span class="n">NSURLResponse</span> <span class="o">*</span><span class="n">response</span><span class="p">,</span> <span class="n">NSData</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSHTTPURLResponse</span> <span class="o">*</span><span class="n">httpResponse</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSHTTPURLResponse</span> <span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">httpResponse</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">==</span> <span class="mi">200</span> <span class="o">||</span> <span class="n">httpResponse</span><span class="p">.</span><span class="n">statusCode</span> <span class="o">==</span> <span class="mi">203</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="kt">id</span> <span class="n">receipt</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">JSONObjectWithData:</span><span class="n">data</span>
</span><span class='line'>                                                         <span class="nl">options:</span><span class="mi">0</span>
</span><span class='line'>                                                           <span class="nl">error:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Received receipt: %@&quot;</span><span class="p">,</span> <span class="n">receipt</span><span class="p">);</span>
</span><span class='line'>            <span class="p">[[</span><span class="n">SKPaymentQueue</span> <span class="n">defaultQueue</span><span class="p">]</span> <span class="nl">finishTransaction:</span> <span class="n">transaction</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Body: %@&quot;</span><span class="p">,</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData:</span><span class="n">data</span> <span class="nl">encoding:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]);</span>
</span><span class='line'>            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;ERROR: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>En el ejemplo de nuestra aplicaci√≥n realizamos primero la verificaci√≥n desde nuestra aplicaci√≥n y posteriormente nos aseguramos repitiendo la verificaci√≥n en nuestro servidor. Quiz√° ser√≠a m√°s pr√°ctico hacerlo al rev√©s: primero en nuestro servidor y si, por alg√∫n motivo, no hemos podido realizar la verificaci√≥n hacerla desde nuestra aplicaci√≥n como segunda opci√≥n.</p>

<p>Ah, podemos dormir tranquilos. La verificaci√≥n desde nuestro servidor deja registro para que podamos hacernos una idea del volumen de nuestras compras&#8230; y a lo mejor sorprender a alg√∫n tunante:</p>

<p><img src="http://javimoreno.me/images/photos/2013/helios-panel-admin.png"></p>

<p>A partir de aqu√≠, si la compra ha sido correcta, podemos insertar el registro en nuestra base de datos que le informa a la aplicaci√≥n que la compra ha sido registrada con √©xito. En el ejemplo de Rafa, en este momento habr√≠a que descargar la canci√≥n.</p>

<p>Por esta vez nada m√°s, si hab√©is le√≠do los anteriores notar√©is que esta vez estoy m√°s entusiasmado con la funcionalidad de Helios. No me he pegado mucho con StoreKit, tan solo con la versi√≥n pro de una aplicaci√≥n, pero la verdad es que ahora si que tengo claro que usar√© CargoBay y con toda seguridad har√© la verificaci√≥n en servidor con Venice&#8230; aunque haya que tocar algo el c√≥digo base.</p>

<blockquote><p>Ojito con las dependencias. No se que versi√≥n de Helios, CargoBay y AFNetworking estar√©is utilizando pero se nota que estos frameworks se est√°n tocando bastante estos d√≠as. Yo he tenido alg√∫n problemita que otro a la hora de preparar esta entrada. Nada que un par de horas de cabezazos en la pared no solucionen&#8230; ;-)</p></blockquote>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Mam√°, salgo en un podcast!]]></title>
		<link href="http://javimoreno.me/blog/2013/05/21/mama-salgo-en-un-podcast/"/>
		
	  <updated>2013-05-21T19:24:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/05/21/mama-salgo-en-un-podcast</id>
	  
	  <content type="html"><![CDATA[<p>Aunque el COBOL no est√© dentro de la tem√°tica habitual de este blog, si hab√©is leido mi entrada sobre mis diez a√±os como programador, sabr√©is que los proyectos a los que me dedico durante el d√≠a tienen a ese <em>maravilloso</em> lenguaje como base para el desarrollo. Por este motivo, cada vez que se habla de COBOL salto como un resorte y en <a href="https://twitter.com/jmoreno78/statuses/274461772721827840">uno de esos saltos</a>, <a href="http://twitter.com/jablanco">Jose Antonio Blanco</a> cometi√≥ la locura de dejarme participar en el podcast <a href="http://wedevelopers.com">We.Developers</a>.    <br/>
Supongo que la audiencia le bajar√° estrepitosamente. Si quer√©is echar un vistazo al gui√≥n que prepar√©, es el cuerpo principal de este post.</p>

<!--more-->


<h2>Citas relacionadas con COBOL</h2>

<p>No hay muchas, la verdad. Las mejores son las que hacen un poco de le√±a con el lenguaje, como la de Dijktstra. Son un <em>poco</em> ofensivas pero la verdad es que son graciosas. Echale un vistazo a estas a ver que te parecen:</p>

<blockquote><p>The use of COBOL cripples the mind; its teaching should, therefore, be regarded as a criminal offence.  <br/>
‚Äî Edsger Dijkstra</p>

<p>Cobol has almost no fervent enthusiasts. As a programming tool, it has roughly the sex appeal of a wrench.  <br/>
‚Äî Charles Petzold</p>

<p>A computer without COBOL and FORTRAN is like a piece of chocolate cake without ketchup or mustard.  <br/>
‚Äî John Krueger</p>

<p>The tree large enough that a stake capable of killing COBOL could be fashioned from its trunk has not yet grown anywhere upon the face of this verdant planet.   <br/>
‚Äî Dan Martinez</p></blockquote>

<p>Como puedes ver, las tres primeras son bastante jocosas con el lenguaje&#8230; la √∫ltima es bastante real y es la que no buscar herir el lenguaje. Vendr√≠a a traducirse a algo as√≠ como:</p>

<blockquote><p>El √°rbol lo suficientemente largo como para que una estaca capaz de matar al COBOL pudiera sacarse de su tronco todav√≠a no ha crecido lo suficiente en ning√∫n lugar de este verde planeta.  <br/>
- Dan Martinez</p></blockquote>

<h2>Historia</h2>

<p>A finales de los a√±os 50, con la aparici√≥n de las primeras m√°quinas <em>comerciales</em> los usuarios empazaban a reclamar a los fabricantes una convergencia en los lenguajes de programaci√≥n ya que por aquel entonces lo habitual era que cada fabricante tuviera su propio lenguaje para comunicarse con sus m√°quinas.  <br/>
Una comisi√≥n formada por fabricantes de ordenadores, usuarios, trabajadores de la Universidad de Pennsylvania y el Departamento de Defensa de los Estados Unidos fue la que, despu√©s de tan solo seis meses de trabajo, defini√≥ el lenguaje COBOL, siglas de COmmon Bussines Oriented Language. <br/>
Un par de a√±os antes, Grace Hopper hab√≠a desarrollado FLOW-MATIC, un lenguaje pionero ya que empleaba instrucciones en ingles para comunicarse con la m√°quina. Precisamente para poder transformar estas instrucciones en lenguaje m√°quina, Grace Hopper cre√≥ el primer compilador. Este lenguaje FLOW-MATIC fue en el que m√°s se bas√≥ la comisi√≥n por lo que, a modo de atribuci√≥n, se llama a Grace Hopper la madre de COBOL ya que en realidad no tuvo un papel tan preponderante en la comisi√≥n.</p>

<p>Despu√©s de la primera definici√≥n del lenguaje en el a√±o 59, se realizaron varias revisiones mayores: en el 68, 74, 85 y 2002. La m√°s frecuente suele ser una mejora del a√±o 89 sobre la del 85. La del a√±o 2002 es la que introduce muchos m√°s cambios como orientaci√≥n a objetos, soporte a mucho m√°s tipos de variables, generaci√≥n y parseo de XML pero no est√° muy implementada.</p>

<h2>Caracter√≠sticas</h2>

<p>La principal caracter√≠stica del COBOL est√° en su propio nombre: es un lenguaje totalmente orientado a la automatizaci√≥n de procesos de negocio. Quiz√° ese y no otro sea el principal motivo por el que sigue tan vigente. La mayor√≠a de los lenguajes de programaci√≥n de los que hablamos hoy en d√≠a (C, Java, C++, Objective-C, PHP, Javascript, Python, Ruby, etc) sirven para hacer cualquier tipo de programa. Obviamente est√°n orientados a unas determinadas tecnolog√≠as o nichos de mercado: juegos, desarrollo web, drivers, aplicaciones de escritorio, aplicaciones m√≥viles, etc pero no hay ninguno que sirva espec√≠ficamente para hacer un CRM. COBOL fue dise√±ado espec√≠ficamente para dar respuestas a una serie de necesidades que ten√≠an las empresas para automatizar sus procesos. Todos quer√≠an un √∫nico lenguaje que les permitiera hacer eso, automatizaron sus procesos, procesos que en su mayor√≠a no han cambiado en los √∫ltimos 50 o 60 a√±os: emisi√≥n de recibos, listados de inventario, contrataci√≥n de productos, control de actividad de procesos, etc.</p>

<p>Otra caracter√≠stica novedosa para la √©poca era que soportaba nombres de variables y de m√©todos de hasta 32 caracteres. Por esto se habla a veces de la <em>verbosidad</em> del COBOL. El c√≥digo es muy legible y casi autodocumentado. Una de las cosas que tuvo muy en cuenta la comisi√≥n para el dise√±o del lenguaje es que un Gerente sin formaci√≥n t√©cnica pudiera leer el c√≥digo fuente de un programa y entender que es lo que estaba pasando (luego llego el GOTO y acabo con este sue√±o dorado). Todos los lenguajes de programaci√≥n tienen una fuerte influencia de la lengua inglesa pero con pocos tienes la sensaci√≥n de estar hablando con la m√°quina como con COBOL: Como programador, escribir i++ y que la variable i aumente su valor en una unidad es una sensaci√≥n de poder. Para un usuario, leer ADD 1 TO INDEX no deja lugar a dudas.
Eso no quita para que no haya que poner comentarios: la duda que nos surgir√° cuando leamos la instrucci√≥n anterior en cualquier lenguaje es: ¬øpor qu√© cojones aumenta el indice?</p>

<p>Es un lenguaje de tipado d√©bil. Solo hay dos tipos de variables: num√©ricas y alfanum√©ricas. Dentro de las num√©ricas hay bastantes tipos de empaquetamientos: binario, hexadecimal, decimal comprimido, sin comprimir, editados&#8230; un lenguaje dedicado al mundo empresarial tiene que tener una buena gesti√≥n de variables num√©ricas. Es importante destacar que en la definici√≥n de la variable se indica expl√≠citamente su longitud, es decir, el n√∫mero de bytes que necesita. Tambi√©n pueden contruirse arrays.</p>

<p>Las variables pueden agruparse dentro de otras variables (una especie de estructuras de C&#8230; pero solo una especie) identificandose la pertenencia a un grupo mediante la indentaci√≥n por c√≥digo de nivel. Un ejemplo ser√≠a una cuenta corriente: A nivel 01 estar√≠a la variable CUENTA-CORRIENTE, a nivel 05 tendr√≠amos CODIGO-BANCO, CODIGO-SUCURSAL, PRIMER-DIGITO-CONTROL, SEGUNDO-DIGITO-CONTROL y NUMERO-CUENTA. Si utilizamos num√©ricos de base decimal solo ocupar√≠amos 20 bytes, es decir, los 20 bytes estar√≠an divididos en cinco bloques de 4, 4, 1, 1 y 10 bytes.</p>

<pre><code>01  CUENTA-CORRIENTE
    05  CODIGO-BANCO           PIC 9(4).
    05  CODIGO-SUCURSAL        PIC 9(4).
    05  PRIMER-DIGITO-CONTROL  PIC 9.
    05  SEGUNDO-DIGITO-CONTROL PIC 9(1).
    05  NUMERO-CUENTA          PIC 9(10).
</code></pre>

<p>No es necesario definir el tipo y la longitud de la variable de primer nivel. Siempre ser√° alfanum√©rica y ocupara los mismos bytes que las variables que agrupa. En este caso, si queremos tratarla como num√©rica tendr√≠amos que redefinirla como num√©rica. Esto se hace con la instrucci√≥n REDEFINES.</p>

<pre><code>01 CUENTA-CORRIENTE-NUMERICA   PIC 9(20).
01 CUENTA-CORRIENTE REDEFINES CUENTA-CORRIENTE-NUMERICA.
</code></pre>

<p>No hay variables de tipo booleano, se construyen mediante niveles especiales de indentaci√≥n pero en realidad se parecen mas a un <em>enum</em>. La diferencia con los enum es que podemos evaluar variables num√©ricas y alfanum√©ricas.</p>

<p>La estructura de un programa COBOL es muy r√≠gida: Consta de cuatro partes aunque no todas son obligatorias:
- Una primera de encabezado (IDENTIFICATION DIVISION), donde se pone el nombre del programa, el autor, las fecha de compilaci√≥n, etc.
- Una segunda de configuraci√≥n del entorno (ENVIRONMENT DIVISION), cuando el programa accede a ficheros esta es la secci√≥n donde se informan las caracter√≠sticas de dicho fichero, si en lugar de trabajar con punto como separador decimal se utilizase la coma se indicar√≠a en esta secci√≥n.
- Una tercera para los datos (DATA DIVISION) donde se definen todas las variables que va a utilizar el programa, se aporta algo m√°s de informaci√≥n sobre los ficheros que se hubieran definido en la secci√≥n anterior, etc.
- Una cuarta para las instrucciones (PROCEDURE DIVISION) que ser√≠a lo que actualmente entendemos por programa. Es donde se tira el c√≥digo.</p>

<p>Adem√°s de la rigidez de la secciones, el n√∫mero de columna donde se escribe tambi√©n es muy importante: los seis primero caracteres est√°n reservados, el s√©ptimo solo se utiliza para comentar o descomentar el c√≥digo. Del 8 al 11 est√°n reservados para la identificaci√≥n de las divisiones y las secciones, los niveles 01 de variables y las definiciones de los ficheros. Esto es lo que se conoce como zona A. De la 12 a la 72 es la zona normal para codificar y se conoce como zona B. De la columna 72 a la 80 tampoco se debe escribir ya que el compilador no va a leer lo que ah√≠ escribamos. Esta estructura procede de la forma original de programa en COBOL. Al principio no hab√≠a IDE¬¥s si no que se usaban fichas de programaci√≥n. Estas fichas se introduc√≠an en los compiladores y si todo era correcto se generaban las tarjetas perforadas con las que funcionaban los mainframes. Aunque ya no haya tarjetas perforadas y se utilicen IDE¬¥s para la codificaci√≥n, estas restricciones se mantienen en los compiladores actuales.</p>

<h2>Plataformas y Variantes</h2>

<p>Aunque la plataforma habitual son los Mainframes se pueden encontrar programas para ordenadores personales. En este punto puedo meter la pata porque el entorno que yo conozco es el mainframe. Aunque el lenguaje COBOL es el mismo, a la versi√≥n del lenguaje que se utiliza para desarrollar aplicaciones que luego van a correr en sistemas operativos de ordenadores personales se la llama RM-COBOL. Hay empresas actuales que comercializan productos para seguir desarrollando y manteniendo estos programas como MicroFocus.</p>

<p>En entorno mainframe la versi√≥n m√°s extendida es la del a√±o 85 revisada en el 89. En algunos lugares se puede encontrar una versi√≥n denominada ENTERPRISE que adem√°s se actualiza con m√°s frecuencia. Cuando me han hablado de ella, lo que m√°s me han destacado es que permite trabajar con variables num√©ricas de mayor tama√±o por lo que se usa en entidades financieras en las que los importes son muy elevados y existe riesgo de perder cifras significativas.</p>

<p>La versi√≥n de 2002 &#8220;oficializa&#8221; algunos desarrollos de terceros existentes que permiten embeber c√≥digo COBOL en servicios .NET, Java, etc. Yo no he conocido a nadie que haya hecho algo de esto. No se si ser√° m√°s habitual en otros tipos de clientes, en otros pa√≠ses o si ser√° algo menos frecuente como los programas RM-COBOL.</p>

<h3>Entornos de desarrollo</h3>

<p>Aunque se puede programar en cualquier editor de notas. He conocido gente que escrib√≠an los programas en Ultra-Edit, otros que lo hac√≠an en SPFPC, un programa MS-DOS con el que se puede escribir un programa, compilarlo, ejecutarlo, etc.</p>

<p>IBM, que es la reina indiscutible en este baile, tiene herramientas de desarrollo COBOL sobre Rational por lo que los programadores de COBOL no tendr√≠amos nada que envidiar a los de Java, aun as√≠, creo que lo m√°s normal si se trabaja en entorno mainframe es usar el IDE que provee el sistema operativo del mainframe o alg√∫n otro IDE de terceros que se instale en el mainframe.</p>

<p>El sistema operativo Z/OS, es el que actualmente traen los ainframes de IBM. Este sistema operativo incluye las funcionalidades originales del MVS pero se le ha agregado compatibilidad con UNIX, soporte para espacios de memoria virtual lo que hace que los mainframe no solo sirvan para tener las funciones cl√°sicas. Entre las caracter√≠sticas que tiene este sistema operativo se encuentra la de traer de serie un entorno de desarrollo en el que crear, compilar y ejecutar programas contra el propio mainframe&#8230; y desde el propio mainframe. Porque no hemos de olvidar que el acceso a este bicharraco se hace siempre desde terminales tontos. En este entorno de desarrollo, cada usuario puede tener su configuraci√≥n,&#8230; el sistema operativo es multiusuario y multitarea. Yo puedo conectarme en mi pc de Madrid al Host de mi empresa, desde un port√°til en el AVE Madrid-Barcelona, en el equipo de un compa√±ero en la oficina de Barcelona&#8230; y si lo hago con mi usuario y contrase√±a siempre estar√© viendo mi configuraci√≥n, mis programas, mis librer√≠as y mis permisos. Esto es as√≠ desde los a√±os 70&#8230; ¬øCuantos a√±os lleva Linode ofreciendo estas ventajas a los desarrolladores? Si, no se puede comparar lo que puede desarrollarse en un mainframe con lo que podemos hacer desde una virtualizaci√≥n de Linode pero la reflexi√≥n que yo siempre me hago es que los ciclos tambi√©n llegan a la tecnolog√≠a.</p>

<p>Como en cualquier otro lenguaje, COBOL no ser√≠a nada si no fuera por otras tecnolog√≠as que est√°n a su alrededor. Igual que PHP casi siempre va acompa√±ado de MySQL y de un servidor Apache, el COBOL siempre va rodeado de una serie de t√©rminos (tecnolog√≠as) que suelen verse en ofertas de empleo. Se suelen buscar expertos en COBOL-CICS-DB2 con conocimientos de JCL, VSAM, IMS, SORTFD o cosas as√≠. Salvando las distancias y pidiendo perd√≥n de antemano a los compa√±eros del PHP por las confianzas que me estoy tomando, COBOL-CICS-DB2 es el LAMP, MAMP o WAMP del PHP:</p>

<p>CICS es el nombre del terminal de teleproceso que incluyen los mainframes y que son los que permiten las conexiones on-line al sistema desde cualquier terminal tonto o emulador de terminal tonto. Es tambi√©n el encargado de servir informaci√≥n a los servicios web (estos ya desarrollados en cualquier lenguaje aunque Java es un habitual) que se conectan al CICS a trav√©s de alg√∫n Gateway. No requiere unos conocimientos adicionales al lenguaje, solo que hay una serie de instrucciones en el lenguaje que solo sirven cuando el programa se va a utilizar en una instalaci√≥n CICS.</p>

<p>DB2 es una base de datos relacional, igual que MySQL, SQL Server, Oracle, etc. Es un producto de IBM que se puede instalar en distribuido y en mainframe. Al igual que el CICS, el √∫nico conocimiento adicional que se requiere es el de saber SQL, ya que es como se accede a la base de datos desde un programa COBOL.</p>

<p>IMS es un gestor de bases de datos jer√°rquicas, no es lo m√°s actual pero todav√≠a se sigue usando en alg√∫n sitio.</p>

<p>VSAM es un sistema de almacenamiento indexado. Aunque tambi√©n esta muy desfasado, todav√≠a es posible encontrar instalaciones que los usan. Los ficheros de tipo VSAM se usan para hacer la persistencia del DB2 as√≠ que para IBM siguen siendo de gran importancia.</p>

<p>JCL es el sistema que se utiliza para ejecutar un proceso Batch. No sirve solo para procesos COBOL sino tambi√©n para lanzar muchas utilidades que vienen en el Sistema Operativo de los mainframes: utilidades del DB2, procesos de ordenamiento de ficheros planos con SORTFD. Es como un fichero de configuraci√≥n o mejor, como una plantilla en la que se le dice al sistema operativo el entorno en el que se quiere ejecutar el programa, que programa es el que se va a ejecutar, quien es el usuario que lo lanza para ver si tiene permisos, donde est√°n los ficheros, que estructura tienen, que tama√±o se les ha definido, etc. Quiz√° es a la hora de preparar un JCL cuando mayor es la sensaci√≥n de estar trabajando con una tecnolog√≠a con m√°s de 50 a√±os de historia: se habla de fichas, cilindros, pistas, cintas&#8230;</p>

<h2>Para que se usa hoy en d√≠a</h2>

<p>Hoy en d√≠a el COBOL est√° presente en multitud de situaciones cotidianas. Casi todos los sistemas bancarios est√°n desarrollados en COBOL: ordenes de transferencia, venta de acciones, de valores, conciliaciones bancarias, procesos de facturaci√≥n de grandes compa√±√≠as telef√≥nicas, o de grandes cadenas de supermercados. Aplicaciones completas de gesti√≥n de compa√±√≠as de seguros, procesos de control de centrales el√©ctricas, aplicaciones de inventario de almac√©n&#8230; y as√≠ hasta el infinito.
Cuando se habla de la longevidad del COBOL no es porque queden muchos procesos antiguos que nadie se atreve a migrar, es que como esos desarrollos no est√°n aislados, se sigue haciendo nuevo desarrollo en esta plataforma.</p>

<p>Quiz√° no somos conscientes porque la capa de presentaci√≥n que vemos nosotros es una aplicaci√≥n de escritorio tipo Windows, o una p√°gina web pero el COBOL est√° ah√≠, por debajo. Incluso en alguna aplicaci√≥n de un dispositivo m√≥vil, los datos son extra√≠dos por un programa COBOL.</p>

<p>Si alguien se ha fijado alguna vez en unos ordenadores todo-en-uno que suele haber en El Corte Ingles en los que te buscan si un articulo est√° agotado o si lo puedes encontrar en otro centro a trav√©s de una pantalla negra en la que van tecleando y pulsando las teclas de funci√≥n para moverse por las pantallas habr√° visto un terminal CICS. La agencia de viajes y los seguros de El Corte Ingles tambi√©n se contratan con un terminal CICS.</p>

<p>Para mal o para bien, procesos muy cr√≠ticos para compa√±√≠as que mueven un gran volumen de dinero est√°n desarrollados en COBOL, podr√≠an haberse desarrollado en cualquier otro lenguaje m√°s moderno y con m√°s prestaciones pero se desarrollaron en COBOL. A d√≠a de hoy, plantearse una refactorizaci√≥n completa de esos programas a otro lenguaje no solo requiere mucho tiempo si no tambi√©n una gran valent√≠a, y en realidad hay que plantearse tambi√©n si compensa el cambio.</p>

<p>Esta claro que IBM tiene bien agarrados a los departamentos de sistemas que tienen un mainframe&#8230; pero tambi√©n hay que entender que no todas las empresas son como Facebook o Twitter que pueden plantearse un gran cambio de tecnolog√≠a. Aunque parezca mentira, en esas grandes entidades financieras, compa√±√≠as telef√≥nicas, cadenas de alimentaci√≥n hay departamentos de Sistemas que no son muy grandes y que tienen que hacer frente a desarrollos nuevos y a   mantenimientos muy fuertes por lo que no es de extra√±ar que sigan apostando por conservar esa tecnolog√≠a. Una tecnolog√≠a que no est√° dando ning√∫n problema, por otro lado, ¬øhay que cambiarla simplemente porque sea vieja o no haya muchos programadores?</p>

<p>Sobre el n√∫mero de programadores y su cotizaci√≥n tambi√©n hay que aclarar algunas cosas. Lo primero es una triste noticia: la cotizaci√≥n de un programador COBOL no est√° unida a un sueldo alto. Gana como cualquier otro programador experimentado en Java, .Net o lo que sea. Aunque no hay una necesidad tan alta de programadores COBOL como hubo en los a√±os del efecto 2000 o del cambio de la peseta al euro, se siguen haciendo muchos mantenimientos y nuevos desarrollos que requieren programadores COBOL y estoy convencido de que la demanda no disminuir√° en los pr√≥ximos a√±os.</p>

<h2>Futuro</h2>

<p>Hay una frase que se le atribuye a Bill Gates que dice: &#8220;no se que lenguajes de programaci√≥n habr√° en el futuro pero COBOL estar√° all√≠&#8221;. Yo estoy totalmente de acuerdo.</p>

<p>Como ya he comentado en el apartado anterior, el COBOL est√° presente en procesos de vital importancia para empresas que mueven much√≠simo dinero y adem√°s est√° presente en los procesos que garantizan que esas empresas sigan ganando dinero. Mientras IBM siga sirviendo Series Z estos procesos habr√° que seguir manteni√©ndolos. Adem√°s, a medida que van apareciendo nuevas tecnolog√≠as, estas empresas no optan por sustituir los procesos COBOL por procesos codificados en lenguajes m√°s modernos si no que buscan formas para que los procesos COBOL sigan funcionando: es posible enviar un email desde un  JCL, perfectamente podr√≠a enviarse un SMS, hacer una notificaci√≥n PUSH o lo que venga a continuaci√≥n.</p>

<p>Est√° claro que el COBOL no se va a utilizar para programar la pr√≥xima Red Social, o para hacer el Backend de un whatsapp, pero las empresas que mantienen procesos COBOL tambi√©n utilizan tecnolog√≠as actuales que se han podido integrar as√≠ que a medida que sigan apareciendo nuevas tecnolog√≠as y estas se puedan seguir integrando, el COBOL seguir√°.</p>

<p>A veces aparecen corrientes a favor de la desaparici√≥n del COBOL, o que auguran el final de IBM&#8230; hay hueco para todos y lo seguir√° habiendo.</p>

<h2>¬øComo se puede aprender COBOL?</h2>

<p>Los programadores COBOL son como los Sith, siempre van juntos maestro y aprendiz&#8230; es una tradici√≥n oral que va pasando de generaci√≥n en generaci√≥n y de la que nunca queda constancia escrita&#8230; o casi.</p>

<p>Ahora m√°s en serio, por hacer caso a Dijkstra, las universidades no ense√±an COBOL, tampoco ense√±an Objective-C&#8230; las universidades son as√≠.
Yo aprend√≠ a programar en COBOL en una academia, a trav√©s de una oferta de trabajo para gente que no tuviera experiencia en programaci√≥n o muy poca experiencia. No se anuncian tanto como las que te ense√±an a programar en Java o a hacer aplicaciones para iOS o Android pero buscando un poco se pueden encontrar. En IBM los tienen pero son bastante caros.
Actualmente, como para cualquier lenguaje, se puede aprender a programar en COBOL a trav√©s de internet: habr√° que buscar un emulador de un Host, una licencia de MicroFocus y buscar alg√∫n tutorial. Si que es cierto que conseguir un mainframe no es algo que pueda hacerse a trav√©s de ebay por lo que algunas de las caracter√≠sticas del lenguaje m√°s relacionadas con esta arquitectura se tendr√°n que programar en alguna academia buena o directamente en el centro de trabajo.</p>

<h2>Enlaces de interes:</h2>

<p><a href="http://en.wikipedia.org/wiki/COBOL">Su historia, en la wikipedia</a><br/>
<a href="http://alt1040.com/2011/12/historia-de-la-tecnologia-el-lenguaje-cobol">Su historia, en Alt1040</a>  <br/>
<a href="http://www.escobol.com/">Foro de cobol en castellano</a>  <br/>
<a href="http://www.microfocus.com/products/micro-focus-developer/rm-cobol/">Empresa comercializador de RM/COBOL</a>  <br/>
<a href="http://www.carlospinan.com/2012/09/21/iniciando-con-cobol-en-windows-7/">Curiosidad, el blog de alguien que quiere aprender COBOL en 2012</a>  <br/>
<a href="http://pic.dhe.ibm.com/infocenter/pdthelp/v1r1/index.jsp?topic=%2Fcom.ibm.entcobol.doc_4.2%2FPGandLR%2Fpgtitlemvs.htm">La Biblioteca de Alejandr√≠a: La documentaci√≥n de IBM</a>  <br/>
<a href="http://www.codinghorror.com/blog/2009/08/cobol-everywhere-and-nowhere.html">Hasta Jeff Atwood habla de √©l</a></p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Sobre Memori√≥n]]></title>
		<link href="http://javimoreno.me/blog/2013/05/17/sobre-memorion/"/>
		
	  <updated>2013-05-17T23:04:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/05/17/sobre-memorion</id>
	  
	  <content type="html"><![CDATA[<p>Hablando un d√≠a por Twitter, Miguel D√≠az Rubio (aka <a href="http://twitter.com/migueldiazrubio">@migueldiazrubio</a>) cometi√≥ la imprudencia de animarme a escribir algo en su blog: <a href="http://www.migueldiazrubio.com">www.migueldiazrubio.com</a>. Obviamente le dije que si, el blog de Miguel junto con el de <a href="http://objective-c.es">Objective-C.es</a> son de lo mejorcito que hay ahora mismo en castellano para aprender Objective-C y Cocoa Touch, las herramientas necesarias para hacer aplicaciones iOS y una oportunidad para ayudar a estos <em>m√°quinas</em> no pod√≠a desperdiciarse.</p>

<!--more-->


<p>Hoy se ha publicado en el blog de Miguel <a href="http://www.migueldiazrubio.com/2013/05/17/desarrollo-ios-primeros-pasos-con-uicollectionview-parte-ii/">mi primera colaboraci√≥n</a> (espero que me deje hacer alguna m√°s), un tutorial sobre como hacer un juego de encontrar las parejas basado en un componente que se presento en iOS 6: UICollectionView. Este era un tutorial que ten√≠a pensado colgar en este blog m√°s pronto o m√°s tarde pero estoy seguro que en el blog de Miguel podr√° ser de utilidad a m√°s gente.</p>

<p>No es un ejemplo que se me haya ocurrido sobre la marcha, llevo trabajando a ratos en una aplicaci√≥n muy parecida a la del tutorial desde hace seis meses. Por esta raz√≥n me ha parecido oportuno escribir esta entrada que explica de donde me vino la inspiraci√≥n.</p>

<p>En diciembre del a√±o pasado mi hija estuvo ingresada un par de d√≠as en el hospital (un sustejo del que afortunadamente se recuper√≥ perfectamente). Un par de d√≠as en los que jugamos a todos los juegos que hab√≠a en el hospital m√°s alguno que llevamos de casa. Su favorito era uno con piezas que hab√≠a que poner boca abajo, e ir dando la vuelta de dos en dos hasta encontrar todas las parejas.  <br/>
Record√© que en la aplicaci√≥n Phytonista hab√≠a un ejemplo que consist√≠a precisamente en un juego como este y que usaba los animales del teclado emoji como personajes del juego.</p>

<blockquote><p>Merece mucho la pena ver el c√≥digo para darse cuenta de la potencia de Python ya que con muy pocas l√≠neas tienes el juego funcionando.</p></blockquote>

<p>El caso es que pens√© en si ser√≠a mucho m√°s complicado hacerlo en Objective-C, sobre todo el grid de tarjetas y en ese momento ca√≠ en la cuenta de que UICollectionView podr√≠a ser un buen candidato ya que se alimenta f√°cilmente con un array y permite definir el tama√±o de las celdas,&#8230;</p>

<p>Una vez recuperados del susto, empece a probar si mi idea era cierta y en seguida vi que si, que UICollectionView era genial para hacer este juego. Desde entonces, a ratos, he ido meti√©ndole funcionalidad para hacer el juego algo m√°s interesante y entretenido. La verdad es que mi hija se lo pone en el iPad sin que yo le diga nada, as√≠ que no debe estar muy mal hecho ;-)</p>

<p>Si alguien est√° interesado en probarlo y no tiene cuenta de desarrollador, que me lo diga, no me vendr√° mal tener m√°s beta-tester.</p>

<p>El c√≥digo fuente pod√©is verlo <a href="https://github.com/jmoreno/Memorion">aqu√≠</a>.</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Helios II. Houston, tenemos un problema.]]></title>
		<link href="http://javimoreno.me/blog/2013/05/02/helios-ii-houston/"/>
		
	  <updated>2013-05-02T03:36:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/05/02/helios-ii-houston</id>
	  
	  <content type="html"><![CDATA[<blockquote><p>- Okay, Houston, we&#8217;ve had a problem here.<br/>- This is Houston. Say again, please!<br/>- Uh, Houston, we&#8217;ve had a problem.</p><footer><strong>CAPCOM Apollo XIII</strong> <cite>Jack Swigert - Jack R. Lousma - James a. Lovell.</cite></footer></blockquote>


<p>Aprovechando que Rafa Aguilar (aka <a href="http://twitter.com/rais38">@rais38</a>) ha publicado en <a href="http://objective-c.es">Objective-C.es</a> un par de entradas sobre las notificaciones Push en iOS he decidido aparcar un par de cosillas que me ten√≠an bastante atareado y continuar con el an√°lisis de <a href="http://helios.io">Helios.io</a> que hab√≠a prometido.</p>

<!--more-->


<p>Yo no me voy a detener a explicar en que consisten las notificaciones Push y que tipos podemos encontrar en iOS ya que Rafa lo ha explicado estupendamente si no que voy a contar como se desarrollar√≠a el ejemplo de la segunda entrada con Ruby en lugar de con PHP. Para ello, usar√© Houston, una gema desarrollada por <a href="http://twitter.com/mattt">@mattt</a>. La versi√≥n actual de Helios (que tiene unas pocas horas) ya incluye Houston de serie as√≠ que Helios y Orbiter nos proporcionan un backend completo para el env√≠o de notificaciones Push.</p>

<p>Os dejo los enlaces a los art√≠culos de Rafa por si los quer√©is consultar antes de empezar:</p>

<p><a href="http://objective-c.es/envio-de-notificaciones-en-ios-parte-1/">Env√≠o de notificaciones en iOS (Parte 1)</a></p>

<p><a href="http://objective-c.es/envio-de-notificaciones-en-ios-parte-2/">Env√≠o de notificaciones en iOS (Parte 2)</a></p>

<h2>Helios y Orbiter. Preparando el CAPCOM.</h2>

<p>Si hab√©is seguido las indicaciones del art√≠culo de Objective-C.es, tendr√©is una aplicaci√≥n instalada en vuestro dispositivo que vuelca al log de Xcode el token que le devuelven los servidores de Apple para las notificaciones Push.
Helios y Orbiter nos proporcionan un sistema para almacenar esos tokens en un servidor, esto nos ser√° √∫til cuando queramos enviar notificaciones desde nuestro servidor a los dispositivos que tengamos vinculados a nuestra aplicaci√≥n. No ser√° necesario pasar siempre el token al servicio si no que podr√≠a bastar con usar el <em>alias</em>.</p>

<p>Para ello, nos descargamos Orbiter de GitHub y lo incorporamos a nuestro proyecto o bien usamos CocoaPods, lo que hagamos habitualmente y modificamos el siguiente m√©todo del AppDelegate:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">application:</span><span class="p">(</span><span class="n">UIApplication</span> <span class="o">*</span><span class="p">)</span><span class="nv">application</span> <span class="nf">didRegisterForRemoteNotificationsWithDeviceToken:</span><span class="p">(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="nv">deviceToken</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">serverURL</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://192.168.1.105:3000&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">NSURLCredential</span> <span class="o">*</span><span class="n">serverCredential</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURLCredential</span> <span class="nl">credentialWithUser:</span><span class="s">@&quot;YourUsername&quot;</span> <span class="nl">password:</span><span class="s">@&quot;YourPassword&quot;</span> <span class="nl">persistence:</span><span class="n">NSURLCredentialPersistencePermanent</span><span class="p">];</span>
</span><span class='line'>    <span class="n">Orbiter</span> <span class="o">*</span><span class="n">orbiter</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Orbiter</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithBaseURL:</span><span class="n">serverURL</span> <span class="nl">credential:</span><span class="n">serverCredential</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">orbiter</span> <span class="nl">registerDeviceToken:</span><span class="n">deviceToken</span> <span class="nl">withAlias:</span><span class="s">@&quot;ApoloXIII&quot;</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Registration Success: %@&quot;</span><span class="p">,</span> <span class="n">responseObject</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Registration Error: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>El servidor que voy a utilizar para almacenar los tokens y enviar las notificaciones es el mismo de la entrada anterior sobre almacenamiento de datos y sincronizaci√≥n. Si record√°is, una de las cosas que hicimos fue poner seguridad por lo que necesitamos pasarle un usuario y una contrase√±a. Orbiter usa NSURLCredential para estos fines.</p>

<p>Si hemos hecho todo correctamente, al arrancar la aplicaci√≥n en el dispositivo obtendremos el siguiente resultado:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>2013-05-01 11:07:01.903 CAPCOM<span class="o">[</span>24399:907<span class="o">]</span> Registration Success: <span class="o">{</span>
</span><span class='line'><span class="nv">device</span> <span class="o">=</span>     <span class="o">{</span>
</span><span class='line'>    <span class="nb">alias</span> <span class="o">=</span> ApoloXIII;
</span><span class='line'>    <span class="nv">badge</span> <span class="o">=</span> 0;
</span><span class='line'>    <span class="nv">id</span> <span class="o">=</span> 1;
</span><span class='line'>    <span class="s2">&quot;ip_address&quot;</span> <span class="o">=</span> <span class="s2">&quot;&lt;null&gt;&quot;</span>;
</span><span class='line'>    <span class="nv">language</span> <span class="o">=</span> es;
</span><span class='line'>    <span class="nv">lat</span> <span class="o">=</span> <span class="s2">&quot;&lt;null&gt;&quot;</span>;
</span><span class='line'>    <span class="nv">lng</span> <span class="o">=</span> <span class="s2">&quot;&lt;null&gt;&quot;</span>;
</span><span class='line'>    <span class="nv">locale</span> <span class="o">=</span> <span class="s2">&quot;es_ES&quot;</span>;
</span><span class='line'>    <span class="nv">tags</span> <span class="o">=</span>         <span class="o">(</span>
</span><span class='line'>        <span class="s2">&quot;iPhone OS 6.1.3&quot;</span>,
</span><span class='line'>        <span class="s2">&quot;v1.0&quot;</span>,
</span><span class='line'>        iPhone
</span><span class='line'>    <span class="o">)</span>;
</span><span class='line'>    <span class="nv">timezone</span> <span class="o">=</span> <span class="s2">&quot;Europe/Madrid&quot;</span>;
</span><span class='line'>    <span class="nv">token</span> <span class="o">=</span> 1F0E7706D1A343BF17615051DB944743F18156C52EFF0F8DD43DDA23F156862A;
</span><span class='line'>    <span class="nv">tsv</span> <span class="o">=</span> <span class="s2">&quot;&#39;1f0e7706d1a343bf17615051db944743f18156c52eff0f8dd43dda23f156862a&#39;:1 &#39;apoloxiii&#39;:2 &#39;es&#39;:3,4 &#39;europe/madrid&#39;:5&quot;</span>;
</span><span class='line'>    <span class="o">}</span>;
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y en el panel de administraci√≥n de Helios veremos lo siguiente:</p>

<p><img src="http://javimoreno.me/images/photos/2013/admin-helios-tokens.png"></p>

<p>Ahora tenemos que preparar nuestro servidor para que realice el env√≠o de notificaciones Push. Como ya hemos comentado al principio, esta funcionalidad no la tra√≠a Helios en su primera versi√≥n y nos obligaba a nosotros a incluir y configurar esta gema. Hace pocas horas han actualizado el repositorio de Helios incluyendo la funcionalidad de env√≠o de mensajes mediante Houston. Como el merge en GitHub es tan reciente, la gema que hay en <a href="http://rubygems.org/gems/helios">RubyGems.org</a> todav√≠a no est√° actualizada as√≠ que para poder usarla en nuestro proyecto Rails he tenido que indicar en el <em>gemfile</em> que tome el fuente de GitHub. Al hacerlo de esta forma, las dependencias no son visibles por el Bundler por lo que, para evitar errores, he indicado tambi√©n que necesitamos la gema <strong>Houston</strong>.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem <span class="s1">&#39;helios&#39;</span>, :git <span class="o">=</span>&gt; <span class="s1">&#39;git://github.com/helios-framework/helios.git&#39;</span>
</span><span class='line'>gem <span class="s1">&#39;houston&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahora tendremos que guardar el certificado para realizar APS en alguna carpeta de nuestro proyecto y decirle a Helios donde est√°. Los pasos que hay que seguir para trabajar con los certificados est√°n en el post de Rafa, lo √∫nico que haremos diferente es el paso de exportaci√≥n del certificado, al que le daremos un nombre m√°s <em>comodo</em> para nuestra configuraci√≥n:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>openssl pkcs12 -in CAPCOMAPNDEV.p12 -out apple_push_notification.pem -nodes -clcerts
</span></code></pre></td></tr></table></div></figure>


<p>El fichero .pem resultante lo dejaremos en la carpeta <em>config</em> de nuestro proyecto (junto al xcdatamodel) y modificaremos la configuraci√≥n de Helios en nuestro <em>application.rb</em> de la siguiente manera:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Using framework Helios as a middleware for our app</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="ss">Helios</span><span class="p">:</span><span class="ss">:Application</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">service</span> <span class="ss">:data</span><span class="p">,</span> <span class="ss">model</span><span class="p">:</span> <span class="s1">&#39;./config/DealerErgoGo.xcdatamodel&#39;</span>
</span><span class='line'>  <span class="n">service</span> <span class="ss">:push_notification</span><span class="p">,</span> <span class="n">apn_certificate</span><span class="p">:</span> <span class="s1">&#39;.config/apple_push_notification.pem&#39;</span><span class="p">,</span> <span class="n">apn_environment</span><span class="p">:</span> <span class="s1">&#39;development&#39;</span>
</span><span class='line'>  <span class="n">service</span> <span class="ss">:in_app_purchase</span>
</span><span class='line'>  <span class="n">service</span> <span class="ss">:passbook</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Para comprobar que todo est√° bien configurado, ejecutamos la siguiente instrucci√≥n desde el terminal (recordad que nuestro servidor tiene configurado usuario y contrase√±a):</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl -X POST --user <span class="s2">&quot;username:password&quot;</span> -d <span class="s1">&#39;payload={&quot;aps&quot;: {&quot;alert&quot;:&quot;Okay, stand by Thirteen, we are looking at it.&quot;,&quot;badge&quot;:&quot;13&quot;,&quot;sound&quot;:&quot;default&quot;}}&#39;</span> http://localhost:3000/message
</span></code></pre></td></tr></table></div></figure>


<p>Listo, parece que ya tenemos comunicaci√≥n con Houston&#8230; o por lo menos recibimos sus mensajes. ;-)</p>

<p><img src="http://javimoreno.me/images/photos/2013/notificacion-iphone.png" width="320" height="480"></p>

<p>Houston incluye una utilidad de terminal a la que le pasamos un token, la ubicaci√≥n del certificado y el mensaje que queremos enviar. Esto no verifica que hayamos configurado correctamente ning√∫n servidor, solo que el certificado y el token sean correctos:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>apn push <span class="s2">&quot;1F0E7706D1A343BF17615051DB944743F18156C52EFF0F8DD43DDA23F156862A&quot;</span> -c <span class="s2">&quot;config/apple_push_notification.pem&quot;</span> -m <span class="s2">&quot;Okay, stand by Thirteen, we&#39;re looking at it.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Siguientes pasos</h2>

<p>Nuevamente vuelvo a tener sentimientos encontrados. Aunque esta vez he terminado m√°s satisfecho de forma general con los resultados obtenidos de Helios, Orbiter y Houston todav√≠a queda mucho por hacer para tener algo que se parezca m√≠nimamente a lo que nos ofrecen Parse o Urban Airship</p>

<p>Hemos almacenado los tokens en nuestro servidor y hemos sido capaces de enviar notificaciones a nuestro dispositivo desde el terminal. Podr√≠amos realizar el env√≠o de mensajes desde la propia aplicaci√≥n con un m√©todo semejante a este:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">useHoustonServiceWithAlert:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">alert</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSURL</span> <span class="o">*</span><span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="s">@&quot;http://localhost:3000&quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="n">AFHTTPClient</span> <span class="o">*</span><span class="n">httpClient</span> <span class="o">=</span> <span class="p">[[</span><span class="n">AFHTTPClient</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithBaseURL:</span><span class="n">url</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">httpClient</span> <span class="nl">setAuthorizationHeaderWithUsername:</span><span class="s">@&quot;GoogleReader&quot;</span> <span class="nl">password:</span><span class="s">@&quot;F0r3v3r&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;aps&quot;</span><span class="o">:</span> <span class="err">@</span><span class="p">{</span><span class="s">@&quot;alert&quot;</span><span class="o">:</span> <span class="n">alert</span><span class="p">,</span> <span class="s">@&quot;sound&quot;</span><span class="o">:</span> <span class="s">@&quot;default&quot;</span><span class="p">}};</span>
</span><span class='line'>    <span class="n">NSData</span> <span class="o">*</span><span class="n">jsonData</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSJSONSerialization</span> <span class="nl">dataWithJSONObject:</span><span class="n">payload</span>
</span><span class='line'>                                                       <span class="nl">options:</span><span class="mi">0</span>
</span><span class='line'>                                                         <span class="nl">error:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">JSONString</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithBytes:</span><span class="p">[</span><span class="n">jsonData</span> <span class="n">bytes</span><span class="p">]</span> <span class="nl">length:</span><span class="p">[</span><span class="n">jsonData</span> <span class="n">length</span><span class="p">]</span> <span class="nl">encoding:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span> <span class="nl">dictionaryWithObjectsAndKeys:</span>
</span><span class='line'>                            <span class="n">JSONString</span><span class="p">,</span> <span class="s">@&quot;payload&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">[</span><span class="n">httpClient</span> <span class="nl">postPath:</span><span class="s">@&quot;/message&quot;</span> <span class="nl">parameters:</span><span class="n">params</span> <span class="nl">success:</span><span class="o">^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="kt">id</span> <span class="n">responseObject</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSString</span> <span class="o">*</span><span class="n">responseStr</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithData:</span><span class="n">responseObject</span> <span class="nl">encoding:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;Request Successful, response &#39;%@&#39;&quot;</span><span class="p">,</span> <span class="n">responseStr</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">failure:</span><span class="o">^</span><span class="p">(</span><span class="n">AFHTTPRequestOperation</span> <span class="o">*</span><span class="n">operation</span><span class="p">,</span> <span class="n">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;[HTTPClient Error]: %@&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">.</span><span class="n">localizedDescription</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pero en realidad este mensaje no se lo estar√≠amos enviando al Apolo XIII solamente si no a toda la misi√≥n Apolo. Si nos atrevemos a mirar el c√≥digo fuente de Helios, el fichero <a href="https://github.com/helios-framework/helios/blob/master/lib/helios/backend/push-notification.rb"><em>push-notification.rb</em></a> es bastante clarificador: no solo admite el par√°metro <em>payload</em>, tambi√©n admite otro par√°metro llamado <em>tokens</em> que es de tipo <em>array</em>. Es decir, si le pasamos un array de tokens el mensaje solo llegar√° a los dispositivos determinados por esos tokens.</p>

<p>Pero los tokens est√°n almacenados en el servidor, hacemos el registro con Orbiter cada vez que un dispositivo en el que instalamos la aplicaci√≥n acepta que le enviemos notificaciones Push. ¬øTenemos que descargarnos el listado completo de tokens al dispositivo y filtrar por los <em>alias</em>? Parece que no.</p>

<p>Si nos fijamos en el mismo fuente de antes, donde se define el m√©todo get devices, vemos que hay algunos par√°metros que se le pueden pasar a dicho m√©todo: pages, per_page, limit, offset y q&#8230; los cuatro primeros son, obviamente, para controlar la paginaci√≥n de los resultados y el quinto parece ser el indicado para hacer una <em>query</em> a la tabla <em>Device</em> pero, ¬øqu√© es <a href="http://www.postgresql.org/docs/9.1/static/textsearch-tables.html"><em>tsquery</em></a>? Pues seg√∫n la documentaci√≥n de PostgreSQL es la forma de hacer b√∫squeda completa de texto dentro de una determinada entidad.</p>

<p>En realidad <em>tsquery</em> devolver√° todas las registros en los que aparezca el <strong>lexema</strong> que estamos buscando, esto es, si queremos buscar el token del Apolo XIII har√≠amos una llamada como la siguiente:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -X GET --user <span class="s2">&quot;GoogleReader:F0r3v3r&quot;</span> http://localhost:3000/devices?q<span class="o">=</span>ApoloXIII
</span></code></pre></td></tr></table></div></figure>


<p>Pero si, por ejemplo, quisi√©ramos buscar el token del Apolo XI:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl -X GET --user <span class="s2">&quot;GoogleReader:F0r3v3r&quot;</span> http://localhost:3000/devices?q<span class="o">=</span>ApoloXI
</span></code></pre></td></tr></table></div></figure>


<p>Recuperariamos los tokens de los Apolos XI, XII, XIII y XIV. Es m√°s, como la b√∫squeda se hace en todos los campos de la entidad Device, pudiera ser que recuper√°ramos alg√∫n otro registro m√°s. Por ejemplo, si en vez de misiones espaciales utiliz√°ramos como <em>alias</em> los nombres de las lunas de Jupiter. Al buscar el token de <em>Europe</em>, la consulta nos devolver√≠a el token del alias <em>Europe</em> y el de todos los registros de dispositivos con <em>timezone</em> europeo.</p>

<p>Para este caso particular, y viendo el funcionamiento de los servicios de Parse y Urban Airship, ser√≠a conveniente ampliar las funcionalidades de push-notification.rb para incluir los alias como par√°metro y buscar sus tokens. Adem√°s ser√≠a conveniente hacer el env√≠o de notificaciones en batch para los casos en los que hubiera muchos tokens. Ser√≠a recomendable que las notificaciones se almacenaran en base de datos y que el env√≠o se hiciera en background&#8230; vamos, que esto es un no parar. :-)</p>

<p>Aun con todo el trabajo que queda por hacer, hemos podido ver lo sencillo que es montar un sistema de notificaciones para nuestras aplicaciones iOS. Si solo lo queremos para enviar, de vez en cuando, un mensajero para que nos compren alguna aplicaci√≥n, con esto tenemos m√°s que suficiente.</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Helios I. Guardando datos]]></title>
		<link href="http://javimoreno.me/blog/2013/04/11/helios-i-guardando-datos/"/>
		
	  <updated>2013-04-11T01:26:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/04/11/helios-i-guardando-datos</id>
	  
	  <content type="html"><![CDATA[<p>Tal y como anticipe que suceder√≠a, durante estos d√≠as he estado probando Helios, el framework de @mattt que nos permite crear un backend para aplicaciones m√≥viles.</p>

<p>Como ya hice un primer an√°lisis del framework en conjunto, ahora me voy a ir centrando en las piezas que lo forman siguiendo el orden, para mi, de mayor a menor importancia. La idea es que en las pr√≥ximas semanas pueda ir sacando art√≠culos sobre cada una de ellas:</p>

<ol>
<li>Sincronizaci√≥n de datos. Core Data Buildpack + AFIncrementalStore</li>
<li>Notificaciones Push. Rack::Push Notification + Orbiter</li>
<li>In-App Purchases. Venice + Cargo Bay</li>
<li>Passbook. Dubai/Rack::Passbook</li>
</ol>


<p>Sigo teniendo sentimientos encontrados con este framework. Por un lado creo que supone un gran avance ya que simplifica enormemente el desarrollo <em>propietario</em> de una serie de servicios indispensables para una aplicaci√≥n m√≥vil actual. Por otro lado creo que frameworks de desarrollo web como Ruby on Rails o Sinatra no son mucho m√°s complicados y las posibilidades que ofrecen son infinitamente mayores.</p>

<p>Empezemos&#8230;</p>

<!--more-->


<h2>Sincronizaci√≥n de datos</h2>

<p>Hace algunos meses, Heroku public√≥ un tutorial en el que mostraba como crear un backend a partir de un proyecto iOS con Core Data. El mismo tutorial propon√≠a realizar la sincronizaci√≥n con AFIncrementalStore, un framework basado en NSIncrmentalStote (una nueva clase no muy conocida) y que usa AFNetworking para las conexiones REST. Seg√∫n el <a href="http://nshipster.com/nsincrementalstore/">articulo de NSHipster sobre NSIncrementalStore</a> con menos de 300 l√≠neas de c√≥digo tenemos una sincronizaci√≥n que nos quitar√° muchos quebraderos de cabeza. &#8220;It just works&#8221;, dice. Unas palabras malditas siempre que se habla de sincronizaci√≥n de datos en la <em>nube</em>.</p>

<p>AFIncrementalStore no funciona bien a d√≠a de hoy. ¬°Anda! igual que iCloud. He estado varios d√≠as intentando hacerlo funcionar pero al final no he conseguido nada. Supongo que es cosa de tiempo ya que hay una enorme comunidad de desarrolladores detr√°s intentando hacerlo funcionar.</p>

<h2>Backend</h2>

<p>Helios usa Core Data Buildpack para generar el modelo REST al arrancar el servidor. Necesita una base de datos PostgreSQL para funcionar y un poquito de configuraci√≥n, pero hacerlo andar con una estructura de tablas por detr√°s es coser y cantar. Ojo con el modelo REST: tendremos todos los endpoints habituales para hacer las operaciones CRUD pero una cosa fundamental como son los filtros, a d√≠a de hoy, no est√°n desarrollados y desconozco si lo estar√°n alg√∫n d√≠a ya que en el <em>roadmap</em> no se habla de ellos. Si por alg√∫n motivo no lo vas a necesitar en tu backend, perfecto, Helios se ajusta al 100% a tu servicio aunque yo creo que lo normal es incluir alg√∫n filtro en el <em>endpoint</em>: un campo de ordenaci√≥n, el n√∫mero de registros por p√°gina, filtrado por usuario. Creo que solo hay algo que se utilice m√°s que la cl√°usula WHERE en SQL&#8230; el operador AND:</p>

<p>Helios puede usarse solo ya que por dentro es una aplicaci√≥n hecha en Sinatra pero tambi√©n pueden integrarse la gema en un proyecto Rails o Sinatra, actuando como middleware. En el repositorio recomiendan que se proteja este middleware con seguridad ya que podr√° contener datos de gran sensibilidad.</p>

<p>En este post, aprovechar√© para explicar muy brevemente como incluir la gema en un proyecto Rails e incorporar una seguridad HTTP b√°sica.</p>

<p>Mi idea era usar Helios para hacer una especie de Google Reader. AFIncrementalStore me ha desinflado un poco la idea pero sigue siendo la base del backend.  <br/>
Supongo que cada uno seguir√° su m√©todo; en mi caso, antes de empezar con la aplicaci√≥n web, lo primero que haremos ser√° crear un proyecto iOS con Core Data donde definiremos el modelo: dos tablas, una para almacenar los feeds a los que estamos suscritos y otra para almacener los elementos descargados de cada feed.</p>

<p>Usaremos el API de Google Reader que se ocupa de descargar los feeds ya que devuelve siempre el mismo resultado, independientemente de que lea de un rss o de un atom. Este API seguro que desaparece el 1 de Julio de 2013 pero de momento nos ayudar√° a tener una buena copia de seguridad de nuestros blogs favoritos.</p>

<h3>Empezamos a desarrollar.</h3>

<p>Una vez que hemos creado un <em>xcdatamodel</em> en Xcode, lo que hacemos es crear una aplicaci√≥n Rails que sirva para contener el backend Helios y adem√°s nos permita crear todo aquello que no nos proporciente este framework, como por ejemplo la securizaci√≥n del repositorio, las cuentas de usuario, etc.</p>

<p>En el terminal escribiremos lo siguiente:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rails new DealerErgoGo -d postgresql
</span></code></pre></td></tr></table></div></figure>


<p>Directamente trabajaremos con PostgreSQL desde desarrollo por lo que tenemos que tener instalado en nuestro equipo este gestor de base de datos. Mi recomendaci√≥n es usar Postgres.app, desarrollada por Mattt (que t√≠o) que funciona muy bien y es f√°cil de instalar (relativamente).</p>

<p>Lo primero que haremos en nuestro proyecto Rails es configurar el acceso a la base de datos, solo cambiamos el usuario y le indicamos el puerto y el host. Creamos las bases de datos y a disfrutar.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake db:create
</span></code></pre></td></tr></table></div></figure>


<p>A continuaci√≥n incluimos todo lo necesario para usar Helios.</p>

<p>Instalamos la gema y creamos la base de datos</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake db:create
</span></code></pre></td></tr></table></div></figure>


<p>Siguiendo las instrucciones del repositorio, configuramos Helios como un middleware en application.rb. Aprovecharemos para incluir el modelo de datos que hemos creado en la aplicaci√≥n iOS dentro de la carpeta de configuraci√≥n de la aplicaci√≥n Rails. En local no es necesario pero cuando hagamos el despliegue en Heroku, tendremos que subir el modelo junto con la aplicaci√≥n.</p>

<figure class='code'><figcaption><span>&#8220;fragmento de c√≥digo en .config/application.rb&#8221;  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Using framework Helios as a middleware for our app</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="ss">Helios</span><span class="p">:</span><span class="ss">:Application</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">service</span> <span class="ss">:data</span><span class="p">,</span> <span class="ss">model</span><span class="p">:</span> <span class="s1">&#39;./config/DealerErgoGo.xcdatamodel&#39;</span>
</span><span class='line'>      <span class="n">service</span> <span class="ss">:push_notification</span>
</span><span class='line'>      <span class="n">service</span> <span class="ss">:in_app_purchase</span>
</span><span class='line'>      <span class="n">service</span> <span class="ss">:passbook</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Securizamos desarrollo y producci√≥n con seguridad HTTP b√°sica</p>

<figure class='code'><figcaption><span>&#8220;fragmento de c√≥digo en .config/environments/development.rb y .config/environments/production.rb&#8221;  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Autenticaci√≥n HTTP B√°sica para no dejar al descubierto los datos de la aplicaci√≥n</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">middleware</span><span class="o">.</span><span class="n">insert_after</span><span class="p">(</span><span class="o">::</span><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Lock</span><span class="p">,</span> <span class="s2">&quot;::Rack::Auth::Basic&quot;</span><span class="p">,</span> <span class="s2">&quot;Who R&#39; U?&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">u</span><span class="p">,</span> <span class="nb">p</span><span class="o">|</span>
</span><span class='line'>    <span class="n">u</span> <span class="o">==</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;USERNAME&quot;</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">p</span> <span class="o">==</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;PASSWORD&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Cargamos las variables de entorno de nuestro fichero</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Load the environment variables at beginning</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">before_configuration</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">env_file</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;local_env.yml&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">))</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
</span><span class='line'>    <span class="no">ENV</span><span class="o">[</span><span class="n">key</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'>    <span class="k">end</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">env_file</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Para terminar, cambiamos el adaptador de postgresql a postgres porque sequel, una dependencia que trae Helios, lo usa. Debido a esto es muy importante configurar y crear la base de datos antes de introducir Helios en la aplicaci√≥n ya que de lo contrario entraremos en un bucle infinito de cambio de adapatores. Tambi√©n cambiamos el usuario de la base de datos ya que, por defecto, PostgreSQL solo tendr√° nuestro usuario local.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">    </span><span class="l-Scalar-Plain">adapter</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">postgres</span>
</span><span class='line'>   <span class="err"> </span><span class="l-Scalar-Plain">encoding</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">unicode</span>
</span><span class='line'>   <span class="err"> </span><span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DealerErgoGo_development</span>
</span><span class='line'>   <span class="err"> </span><span class="l-Scalar-Plain">pool</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'><span class="err">    </span><span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">javi</span>
</span><span class='line'>   <span class="err"> </span><span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="err">    </span><span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">localhost</span>
</span><span class='line'><span class="err">    </span><span class="l-Scalar-Plain">port</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5432</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y con esto ya tendr√≠amos listo el backend. Podr√≠amos probarlo en nuestra m√°quina local o desplegar directamente en Heroku. Para ello solo hay que tener <a href="https://toolbelt.heroku.com">Heroku toolbelt</a> instalado, haber hecho commit de todos los cambios en la rama y principal y desde la carpeta del proyecto en el terminal escribir lo siguiente:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>heroku create
</span></code></pre></td></tr></table></div></figure>


<p>Para crear la aplicaci√≥n y</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git push heroku master
</span></code></pre></td></tr></table></div></figure>


<p>Para desplegar la aplicaci√≥n en Heroku. Listo, ya podemos disfrutar de nuestras 750 horas gratuitas al mes.</p>

<h3>La decepci√≥n</h3>

<p>Nos las promet√≠amos muy felices. El desarrollo y puesta en producci√≥n del backend hab√≠a sido tan sencillo que confi√°bamos en que la creaci√≥n de la aplicaci√≥n iOS fuera igual y en realidad, esto no ha sido as√≠.</p>

<p>Para desarrollar la aplicaci√≥n vamos a seguir <a href="https://devcenter.heroku.com/articles/ios-core-data-buildpack-app">este tutorial de la web de Heroku</a>. Aparentemente no es muy complicado y de hecho no lo es, el problema es que cuando hayamos seguido todos los pasos y tengamos la aplicaci√≥n lista para env√≠ar datos a nuestro flamante servidor veremos que la grabaci√≥n la hace bien pero el retorno de la informaci√≥n no y nuestra aplicaci√≥n empieza a fallar. Llevo toda la semana leyendo las <em>issues</em> del repositorio y buscando en Stackoverflow a ver si doy con el correcto funcionamiento pero hasta ahora no he conseguido nada. Creo que es algo que se me ha pasado por alto en alg√∫n punto ya que es demasiado evidente que no est√° funcionando como para que no haya ninguna queja al respecto. En cualquier caso, yo mismo pondr√© un <em>issue</em> a ver si me pueden echar una mano.</p>

<h2>Conclusiones</h2>

<p>Si tu aplicaci√≥n necesita de subir los datos a un servidor o simplemente leer unos datos sencillos: datos del tiempo, noticias, entradas de un blog, radares m√≥viles,&#8230; Helios te puede ser de una gran ayuda. No recomiendo que uses AFIncrementalStore si no que, de momento, ser√≠a mejor que te hicieras tu propia sincronizaci√≥n con Core Data.</p>

<p>Si ves que Helios se te empieza a quedar peque√±o porque necesitas filtrar los datos en el servidor y no en la propia aplicaci√≥n, no tengas miedo a dar el paso a Ruby on Rails. Llevar√° un poco m√°s de trabajo pero no mucho m√°s y eso ya si que es dar un salto cualitativo en la creaci√≥n de tu propio backend ya que tendr√°s mucho m√°s control sobre el mismo.</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Helios: el sol Vs. la 'iNube']]></title>
		<link href="http://javimoreno.me/blog/2013/04/04/helios-el-sol-vs-la-inube/"/>
		
	  <updated>2013-04-04T02:31:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/04/04/helios-el-sol-vs-la-inube</id>
	  
	  <content type="html"><![CDATA[<blockquote><p>There&#8217;s a lady who&#8217;s sure all that glitters is gold<br/>And she&#8217;s buying a stairway to heaven.</p><footer><strong>Led Zeppelin</strong> <cite>Stairway to Heaven.</cite></footer></blockquote>


<p>Son tiempos convulsos para la sincronizaci√≥n de datos entre aplicaciones. Si segu√≠s al mismo tipo de personas que yo en Twitter habr√©is visto como el nivel de indignaci√≥n con iCloud por la sincronizaci√≥n por Core Data ha llegado a niveles casi de disturbios. <a href="http://rms2.tumblr.com/post/46505165521/the-gathering-storm-our-travails-with-icloud-sync">Este post</a> de los desarrolladores de Yojimbo es un buen resumen.
Para echar un poco m√°s de le√±a al fuego, Brent Simmons escrib√≠a <a href="http://t.co/U6NFNTDjDR">Why Developers Shouldn‚Äôt Use iCloud Syncing, Even If It Worked</a> unos d√≠as despu√©s.</p>

<!--more-->


<p>Mattt Thompson aprovech√≥ el <em>April Fools¬¥ Day</em> para poner una pizca de humor en el asunto dedicando un <a href="http://nshipster.com/icloud/">NSHipster a iCloud</a>.</p>

<p>La sorpresa lleg√≥ cuando el d√≠a siguiente aparecieron estos dos tweets casi seguidos:</p>

<div class='embed tweet'><blockquote class="twitter-tweet"><p>Helios is an open-source framework that provides essential backend services for iOS apps.&#10;&#10;<a href="http://t.co/GVlV0qF7Ov">http://t.co/GVlV0qF7Ov</a></p>&mdash; Mattt Thompson (@mattt) <a href="https://twitter.com/mattt/statuses/319144081731227649">April 2, 2013</a></blockquote>
<script async src="http://javimoreno.me//platform.twitter.com/widgets.js" charset="utf-8"></script></div>




<div class='embed tweet'><blockquote class="twitter-tweet" lang="es"><p>If you had a laugh at yesterday&#8217;s post about iCloud, you may be interested in this new project: <a href="http://t.co/wNUIHsRMDv" title="http://helios.io">helios.io</a></p>&mdash; NSHipster (@NSHipster) <a href="https://twitter.com/NSHipster/status/319144640592896000">2 de abril de 2013</a></blockquote>
<script async src="http://javimoreno.me//platform.twitter.com/widgets.js" charset="utf-8"></script></div>


<p>A estas alturas creo que no hay que presentar a Mattt Thompson, famoso co-creador de AFNetworking, pero igual si que hay que volver a repasar algunas de las cosas que ha estado haciendo en los √∫ltimos tiempos, desde que abandono Gowalla para entrar a formar parte del equipo de Heroku como Director del √°rea de Mobile:</p>

<ul>
<li>AFNetworking se ha consolidado como el framework de facto para realizar cualquier comunicaci√≥n con servidores, descarga y subida de ficheros, etc.</li>
<li>Bas√°ndose en AFNetworking ha creado AFIncrementalStore, que junto con el servicio Heroku Mobile permite hacer persistencia de Core Data en servidores de forma correcta&#8230; ¬ødardo envenenado a iCloud?</li>
</ul>


<p>Los dos trabajos anteriores son bastante conocidos pero tambi√©n tienen buena reputaci√≥n los siguientes:</p>

<ul>
<li>Cargo Bay es una peque√±a librer√≠a para realizar la verificaci√≥n de las transacciones realizadas por In-App-Purchases.</li>
<li>Orbiter es otra peque√±a librer√≠a que facilita el control de los dispositivos vinculados a notificaciones para poder usar servicios push de terceros como Urban Airship o Parse sin tener que instalar los SDK¬¥s correspondientes.</li>
<li>Rack::PushNotification es un webservice para realizar las notificaciones push desde nuestros propios servidores.</li>
</ul>


<p>Podr√≠amos seguir y seguir con otras muchas peque√±as y grandes utilidades creadas por Mattt: Postgres.app (una cliente standalone para instalar PostgreSQL en el Mac), Induction.app (un cliente de bases de datos tambi√©n para Mac),&#8230; pero creo que esta es una buena representaci√≥n.</p>

<p>Aparte de los IaaS, PaaS y los SaaS, √∫ltimamente empiezan a sonar mucho los BaaS (Backend as a Service) como Parse, Urban Airship, Apigee, Azure o BackBeam.io (que es un desarrollo espa√±ol, ma√±ico para m√°s se√±as). Las ventajas de estos Baas son claras, nos permiten disfrutar de una infraestructura necesaria por la mayor√≠a de las aplicaciones m√≥viles sin tener que desarrollar nada. Normalmente, adem√°s, tienen una tarifa de entrada que suele ser gratuita en la mayor√≠a de los casos. Una vez que superas ese consumo gratuito, empiezas a pagar. Si has dise√±ado un buen plan de negocio para tu aplicaci√≥n, lo normal es que cuando llegues al punto de tener que pagar por usar el Baas ya tengas bastantes ingresos y por tanto te siga compensando seguir utiliz√°ndolo.</p>

<p>Heroku, la empresa donde trabaja Mattt es un Paas (Platform as a Service), lo que ofrece es una plataforma donde es muy sencillo desplegar una aplicaci√≥n. Es decir, el backend lo desarrollamos nosotros y ellos a cambio nos dan facilidades para el despliegue, garant√≠as de escalabilidad y nos liberan del mantenimiento de las m√°quinas en s√≠.  <br/>
Pero si a Heroku le sumamos los desarrollos que ha estado realizando Mattt: un backend para nuestras bases de datos, un backend para los dispositivos que requieren de notificaciones push, le a√±adimos un servicio para realizar la validaci√≥n de los IAP en el servidor y un servicio para generar Passbooks (que empiezan a estar de moda) tenemos casi nuestro propio Parse. Adem√°s, no es necesario un SDK para la parte cliente, Mattt ya tiene un mont√≥n de librer√≠as que se encargan de esto: AFNetworking, AFIncrementalStore, Cargo Bay, Orbiter,&#8230;</p>

<p>Helios no es un sustituto de Parse, Urban Airship, TestFlight, Flurry&#8230; todav√≠a, pero tiempo al tiempo.  <br/>
Con Parse tenemos cubierto pr√°cticamente todo lo que se le puede pedir a un backend: persistencia, cuentas de usuario, notificaciones push, servicios de geolocalizaci√≥n. Urban Airship est√° especializado en notificaciones push, geolocalizaci√≥n y passbook. Flurry tiene m√©tricas de uso y control de errores. Testflight tiene distribuci√≥n de betas, control de uso y gesti√≥n de errores. Crashlitycs solo gesti√≥n de errores. New Relic se mete ahora con monitores de servicios.
Si se nos va la mano, terminamos haciendo una aplicaci√≥n del tiempo con 17 SDK¬¥s diferentes instalados. La idea de Heroku me parece brillante, yo te pongo el hosting y un backend superpersonalizable. Adem√°s te doy clientes modulares para lo que quieras usar. Eres libre de usar tu propio servidor pero que sepas que en Heroku es tan sencillo como escribir &#8220;git push heroku master&#8221; y cuando llegue el momento de pagar, pagar√°s. No es oro todo lo que reluce ya que pasamos de depender de una caja negra como Parse a un conjunto de servicios desarrollados por una √∫nica empresa pero al menos esos servicios son <em>open source</em>, podemos ver el c√≥digo cuando queramos y depender solo de nosostros mismos.</p>

<p>Ya os digo que a Helios le queda mucho camino por andar, pero tiene muy buena pinta. Estoy haciendo pruebas con √©l y quiero ver si es f√°cil de superar las dos principales carencias que le veo ahora mismo: la gesti√≥n de usuarios y las notificaciones push sin recurrir a servicios de terceros. Tambi√©n quiero saber si su uso en Heroku implica directamente coste o si, por el contrario, podemos probarlo de forma gratuita con bastante margen&#8230; creo que Helios va a ser un <em>habitual</em> en mis pr√≥ximos posts&#8230; Stay tuned!</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Una decada]]></title>
		<link href="http://javimoreno.me/blog/2013/03/31/una-decada/"/>
		
	  <updated>2013-03-31T01:18:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/03/31/una-decada</id>
	  
	  <content type="html"><![CDATA[<blockquote><p>Puede que no haya ido a donde quer√≠a ir, pero creo que he terminado donde ten√≠a que estar.</p><footer><strong>Douglas Adams.</strong></footer></blockquote>


<p>Hoy hace diez a√±os que entr√© a trabajar como programador en una empresa de consultor√≠a. Para algunos ser√°n muchos, para otros ser√°n pocos, para mi es una cantidad muy significativa que me permite echar la vista atr√°s y reflexionar sobre como han cambiado las cosas desde entonces.</p>

<!--more-->


<p>Yo no iba a ser programador. Estudi√© (y no me arrepiento) Qu√≠mica porque me gustaba much√≠simo e incluso tuve la suerte de trabajar de becario en la Facultad de Qu√≠micas durante un a√±o y en Repsol durante seis meses. La historia comienza en segundo de carrera, cuando compre mi primer ordenador, un cl√≥nico con Windows 95 original (puedo demostrarlo con fotos) con el que empece a utilizar <a href="http://www.softwarecientifico.com/paginas/origin.htm">Origin</a>, <a href="http://www.hyper.com">Hyperchem</a>, <a href="http://www.mathworks.es/products/matlab/">Matlab</a> y el m√≠tico <a href="http://www.tecnun.es/asignaturas/metmat/Manual_Maple/version5.pdf">Maple V</a>. Creo que esto era a finales del a√±o 1997, para acceder a Internet reserv√°bamos una hora en la sala de inform√°tica de la facultad, no hab√≠a proxy pero una se√±ora de muy mal caracter te abroncaba si buscabas guiones de los Monty Python, la fuente favorita de las paginas web era Times New Roman y usabamos <a href="http://es.wikipedia.org/wiki/AltaVista">Altavista</a> para hacer b√∫squedas.</p>

<p>Desde el primer momento me sent√≠ muy bien con el ordenador. Tuve la certeza de que si hubiera tenido mi primer ordenador (en realidad era el segundo, el primero fu√© un Amstrad CPC 464 en los ochenta) en el bachillerato no habr√≠a elegido Qu√≠mica como carrera pero aun as√≠ continu√© con mi <em>vocaci√≥n</em>. Podr√≠a haberme especializado en Qu√≠mica F√≠sica, una rama de la Qu√≠mica que en aquella √©poca ya ten√≠a un alto contenido computacional: eran unos frikis que usaban linux porque no hab√≠a que apagarlos nunca y as√≠ pod√≠an dejar c√°lculos corriendo durante meses, pero a mi lo que me gustaba era la s√≠ntesis de mol√©culas org√°nicas&#8230; que le vamos a hacer.</p>

<p>El caso es que cuando acab√© la carrera y me puse a buscar trabajo las opciones eran: comercial, profesor de secundaria y programador. Hab√≠a m√°s posibilidades de trabajar como investigador en el extranjero pero por aquella √©poca yo ya era un huev√≥n y no quer√≠a salir de casa as√≠ que empece por la primera opci√≥n, comercial. No me llev√≥ mucho tiempo darme cuenta de que aquello no era lo m√≠o y a los cinco meses estaba haciendo un curso de programaci√≥n en base de datos y echando curriculums en las t√≠picas empresas de consultor√≠a que contrataban a gente sin experiencia en programaci√≥n (no doy nombres pero seguro que se os ocurren muchas). En las navidades de 2002 me seleccionaron para hacer un curso de COBOL/CICS/DB2, dej√© el trabajo de visitador m√©dico y durante un mes y medio estuve aprendiendo las bases para ser un cobolero.</p>

<p>Aunque se dec√≠a que hab√≠a bastante trabajo de programador, las <em>vacas gordas</em> estaban adelgazando. En 2003, la burbuja de las <em>punto com</em> ya hab√≠a estallado, los grandes proyectos de desarrollo COBOL en Espa√±a que hab√≠an sido el efecto 2000 y la transici√≥n de la peseta al euro ya estaban m√°s que acabados, el tr√≠o de las Azores se dispon√≠a a invadir Irak&#8230; en este escenario tan devastador, sin ninguna experiencia como programador y con un gran sentimiento de intrusismo, ser contratado como Codificador Inform√°tico por la importante suma de 10.300‚Ç¨ brutos anuales fue algo maravilloso. &lt;/ironia></p>

<p>Programar me gustaba mucho, tanto, que cuando ya me empezaba a sentir c√≥modo con COBOL y sus adl√°teres le empece a hacer ojillos al lenguaje con el que programaban los <em>t√≠os de al lado</em>, esos que hac√≠an cosas mucho m√°s sofisticadas que nosotros: Java.<br/>
En el a√±o 2003 ya era normal tener internet en casa y aunque en aquella √©poca no hab√≠a tantos recursos para aprender a programar encontr√© un tutorial de Sun para aprender Java mientras desarrollabas un <em>diar√≠o de buceo (Dive Log)</em>. Aunque parezca mentira, rebuscando en la web de Oracle todav√≠a se puede encontrar este <a href="http://www.oracle.com/technetwork/topics/newtojava/divelog-140357.html">pecio</a>.   <br/>
Yo no se nadar, y mucho menos bucear por lo que todo apuntaba a receta para un fracaso y as√≠ fue. Avanc√© bastante con la aplicaci√≥n pero entender los conceptos de orientaci√≥n a objetos, herencia, clases y dem√°s me costaba mucho.</p>

<p>Quiz√° fuera culpa m√≠a, por empe√±arme en aprender con lo que obten√≠a de internet en una √©poca en la que no hab√≠a los recursos para aprender que tenemos ahora, quiz√° por que no fu√≠ m√°s al grano de lo que quer√≠a aprender, quiz√° porque mis conocimientos de programaci√≥n no estaban lo suficientemente asentados, el caso es que finalmente se me quitaron las ganas de aprender Java y cualquier otro lenguaje. En el trabajo segu√≠a haciendo programas en COBOL, aprend√≠a mucho de bases de datos, SQL, normalizaci√≥n, dise√±o de aplicaciones,&#8230; y con eso era suficiente. Aprovechaba mis ratos libres para leer, escuchar m√∫sica, estar con mi novia, mis amigos y hacer de bajista en un par de grupos. De hecho, pocas personas pueden presumir de haber estado en el Sexto encuentro de asociaciones de F√©lix Rodr√≠guez de la Fuente y muchos menos pueden presumir de haber tocado en directo all√≠, en <a href="http://www.iberica2000.org/Es/Articulo.asp?Id=3648">Ruesta, Huesca</a>. Hab√≠a m√°s m√∫sicos que asistentes.</p>

<p>Aunque no dedicaba mi tiempo libre a programar, descubr√≠ MySpace y empece a modificar y mantener el MySpace del grupo en el que estaba. En algo hab√≠a mejorado internet: era mucho m√°s f√°cil encontrar recursos que te explicaran como modificar las hojas de estilos de MySpace e incluso hab√≠a gente que compart√≠a hojas de estilos muy trabajadas de forma desinteresada. Internet hab√≠a cambiado pero mi talento para el dise√±o no as√≠ que pronto me canse de jugar con MySpace. El friki que hab√≠a dentro de mi estaba deseando salir pero todav√≠a faltaba algo&#8230; un <em>totem</em>.</p>

<p>El <em>totem</em> lleg√≥ en 2009 con forma de iPhone 3G, comprado dos semanas antes de que presentaran el 3GS. Eran otros tiempos, nunca hab√≠a o√≠do hablar de los ciclos de vida de los productos de Apple. El caso es que yo estaba muy contento con √©l, lo usaba bastante, probaba apps, hacia fotos, le√≠a el correo, Google Reader y de repente, un d√≠a, mientras esperaba al autob√∫s empece a buscar una aplicaci√≥n para calcular el percentil de un beb√©. Buscaba algo sencillo, que permitiese guardar unos pocos datos del reci√©n nacido y, en cada revisi√≥n, mostrara la evoluci√≥n del percentil. No vi nada que me llamara la atenci√≥n y me dije: &#8220;¬øEsto podr√≠a hacerlo yo?&#8221;.
Lo comente con un compa√±ero de trabajo y empezamos a investigar: hac√≠a falta un Mac, no sab√≠amos si se podr√≠a virtualizar pero descubrimos que hab√≠a algo llamado Hackintosh que podr√≠a valer. Encontramos la web de desarrolladores de Apple que te daban un fil√≥n de documentaci√≥n sin pagar ni un duro. No hab√≠a ni un solo tutorial en castellano pero en ingles hab√≠a ya unas cuantas p√°ginas especializadas que te ense√±aban desde cero.</p>

<p>Vi√©ndolo en perspectiva, de lo √∫nico que me arrepiento de esa √©poca es de haberle dedicado tanto tiempo al Hackintosh. Yo no ten√≠a mucho tiempo libre con mi hija reci√©n nacida (lo de quitarme horas de sue√±o no lo hab√≠a descubierto todav√≠a) y mantener un Hackintosh requiere mucho tiempo. Esas navidades me compre el primer libro de desarrollo de aplicaciones y empece a darle ca√±a por las noches. Lo que m√°s me quemaba (siempre me ha quemado) era conseguir hacer cosas sin terminar de entender del todo lo que estaba pasando. Yo no sab√≠a lo que era la programaci√≥n orientada a objetos, hab√≠a le√≠do sobre ella cuando intente aprender .Net y Java pero nunca termine de tenerlo claro. Ahora estaba empe√±ado en aprender, y ten√≠a que hacerlo con Objective-C.  <br/>
El tiempo iba pasando pero no consegu√≠a producir nada, cada vez iba entendiendo un poco m√°s como funcionaba iPhone OS (as√≠ se llamaba entonces) pero no terminaba las aplicaciones (sigo teniendo una larga lista de aplicaciones inacabadas). El problema era que me costaba mucho enfocarme. Hab√≠a descubierto que pod√≠a aprender mucho por mi cuenta, internet estaba plagada de recursos y por fin ten√≠a paciencia (o pasaba m√°s tiempo en casa) para detenerme a leer, madurar, entender. No hab√≠a hecho ninguna aplicaci√≥n pero estaba convencido de que alg√∫n d√≠a necesitar√≠a de servicios web que alimentaran alguna de mis aplicaciones por lo que tambi√©n tendr√≠a que aprender algo de desarrollo web. Ruby on Rails sonaba bastante pero todo el mundo dec√≠a que Php era muy f√°cil y que el hosting era muy barato&#8230; Aprender, aprender, aprender, me estaba obsesionando, y mucho.</p>

<p>Al final si que llegaron las aplicaciones: la primera, una lista de chistes <em>graciosillos</em> para felicitar la Navidad y el a√±o nuevo sali√≥ a finales de 2010. No gan√≥ ni para pagar la licencia de desarrollador pero nos ense√±o mucho sobre la publicidad, los comentarios y la <em>competencia</em>, sobre todo, de la <em><em>competencia</em></em>.
M√°s tarde, a principios de 2012 sali√≥ TasaTuCoche. De esta si que aprendimos bastante m√°s: identificar un nicho, ver que se pod√≠a mejorar, probar t√©cnicas de posicionamiento en el App Store, etc. Aqu√≠ ya hay necesidad de servicios web por lo que hubo que aprender algo de Php, hostings, redireccionamiento dns, dominios y dem√°s historias. Php est√° bien, y nos permiti√≥ desarrollar el servicio en muy poco tiempo pero aun as√≠ hay algo que no me hace sentir c√≥modo cuando programo en Php, por eso volv√≠ a darle a Ruby On Rails.</p>

<p>Y ah√≠ sigo, saltando de iOS a Ruby on Rails, mirando de reojo a Node.js, comprando libros de OSX para cuando pueda, pasar a la pantalla grande, disfrutando de compartir mi tiempo y mi c√≥digo en GitHub, o en este blog,&#8230;</p>

<p>Diez a√±os para m√≠ son muchos a√±os, se han pasado volando y sobre todo los √∫ltimos cuatro me hubiera gustado exprimirlos m√°s. Es muy dif√≠cil saber en que se traducir√°n las horas de sue√±o que me estoy quitando pero no me pesan nada por que, solo de aprender lo que estoy aprendiendo, ya las doy por bien invertidas y se que marcar√°n lo que pasar√° en los pr√≥ximos diez a√±os. Si estos han sido buenos, los pr√≥ximos espero que sean la ca√±a.</p>

<h3>Nota:</h3>

<p>Esta entrada la empece a escribir el domingo 31 de Marzo pero hasta hoy 2 de Abril no he podido terminarla.</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Variables de entorno en Rails]]></title>
		<link href="http://javimoreno.me/blog/2013/03/25/variables-de-entorno-en-rails/"/>
		
	  <updated>2013-03-25T13:25:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/03/25/variables-de-entorno-en-rails</id>
	  
	  <content type="html"><![CDATA[<p>Cuando termin√© la primera versi√≥n de URLHunter, ten√≠a claro que compartir el c√≥digo fuente del proyecto era b√°sico. Principalmente por dos razones:   <br/>
Primero, porque que se aprende mucho viendo el c√≥digo, quiz√° mas que siguiendo un tutorial.<br/>
Segundo, porque me encantar√≠a que la gente clonara el proyecto, hiciera forks, pull requests y enriqueciera URLHunter con sus aportaciones individuales.</p>

<p>Cuando lo iba a subir a GitHub ca√≠ en la cuenta de que los <em>tokens</em>, <em>consumer_keys</em>, etc de Twitter los iba a poder ver cualquiera que echara un vistazo al fichero <em>twitter.rb</em> y no solo eso, si en el futuro decid√≠a incluir un formulario de contacto, integrar New Relic o Google Analytics los usuarios, contrase√±as, identificadores √∫nicos ser√≠an visibles para todo el mundo. Fue entonces cuando vi la importancia de las <em><em>variables de entorno</em></em> a las que hac√≠an referencia en la documentaci√≥n de la gema de Twitter.</p>

<!--more-->


<p>El caso es que, por no hacerlo de primeras, para subir el repositorio a GitHub tuve que crear una rama nueva, cambiar los ficheros, asegurarme de que la rama principal nunca se sincronizar√≠a con GitHub, etc. El problema a√±adido a esto es que todas los cambios que he ido haciendo al proyecto no los he podido sincronizar con la rama GitHub por falta de tiempo (o pereza, seg√∫n se mire). En fin, que antes de que la cosa se complicar√° m√°s hab√≠a que actuar as√≠ que buscando un poco en internet he encontrado <a href="http://railsapps.github.com/rails-environment-variables.html">este tutorial</a> que es el que voy a seguir para ocultar la informaci√≥n confidencial del proyecto.</p>

<p>La opci√≥n que he decidido desarrollar es la tercera, tiene un poco m√°s de trabajo a la hora de desplegar en Heroku pero no es muy significativo.</p>

<p>Lo primero es crear el fichero <em>local_env.yml</em> e incluirlo en <em>.gitignore</em> para que no lo ve√°is jam√°s. ;-)</p>

<figure class='code'><figcaption><span>/config/local_env.yml  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># Rename this file to local_env.yml</span>
</span><span class='line'><span class="c1"># Add account settings and API keys here.</span>
</span><span class='line'><span class="c1"># This file should be listed in .gitignore to keep your settings secret!</span>
</span><span class='line'><span class="c1"># Each entry gets set as a local environment variable.</span>
</span><span class='line'><span class="c1"># This file overrides ENV variables in the Unix shell.</span>
</span><span class='line'><span class="c1"># For example, setting:</span>
</span><span class='line'><span class="c1"># GMAIL_USERNAME: &#39;Your_Gmail_Username&#39;</span>
</span><span class='line'><span class="c1"># makes &#39;Your_Gmail_Username&#39; available as ENV[&quot;GMAIL_USERNAME&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Twitter Variables</span>
</span><span class='line'><span class="l-Scalar-Plain">CONSUMER_KEY</span><span class="p-Indicator">:</span> <span class="s">&#39;Your_Consumer_Key&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">CONSUMER_SECRET</span><span class="p-Indicator">:</span> <span class="s">&#39;Your_Consumer_Secret&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">OAUTH_TOKEN</span><span class="p-Indicator">:</span> <span class="s">&#39;Your_Oauth_Token&#39;</span>
</span><span class='line'><span class="l-Scalar-Plain">OAUTH_TOKEN_SECRET</span><span class="p-Indicator">:</span> <span class="s">&#39;Your_Oauth_Token_Secret&#39;</span>
</span><span class='line'><span class="c1"># New Relic Parameters</span>
</span><span class='line'><span class="l-Scalar-Plain">NEW_RELIC_LICENSE_KEY</span><span class="p-Indicator">:</span> <span class="s">&#39;Your_New_Relic_License_Key&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>En el fichero pod√©is ver como no solo he creado variables de entorno para Twitter si no tambi√©n para New Relic, eso es porque al margen de los cambios en el estilo de URLHunter, el uso de los Tweets Embeds y algunas mejoras en la cache tambi√©n he incluido New Relic para monitorizar su comportamiento y buscar formas de mejorar el rendimiento.</p>

<p>Ahora hay que incluir las variables de entorno en los ficheros correspondientes. El fichero de configuraci√≥n <em>twitter.rb</em> quedar√° de la siguiente manera:</p>

<figure class='code'><figcaption><span>/config/initializers/twitter.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Twitter</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">consumer_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;CONSUMER_KEY&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">consumer_secret</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;CONSUMER_SECRET&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;OAUTH_TOKEN&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">oauth_token_secret</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;OAUTH_TOKEN_SECRET&quot;</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y en el fichero de configuraci√≥n de New Relic lo √∫nico que hay que tener en cuenta es que hay usar ruby embebido para nombra la variable de entorno:</p>

<figure class='code'><figcaption><span>/config/newrelic.yml  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'>  <span class="c1"># You must specify the license key associated with your New Relic</span>
</span><span class='line'>  <span class="c1"># account.  This key binds your Agent&#39;s data to your account in the</span>
</span><span class='line'>  <span class="c1"># New Relic service.</span>
</span><span class='line'>  <span class="l-Scalar-Plain">license_key</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">&lt;%= ENV[&#39;NEW_RELIC_LICENSE_KEY&#39;] %&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Cargando las variables de entorno.</h2>

<p>Para que la aplicaci√≥n cargue las variables de entorno, tendremos que indicarle en el fichero de configuraci√≥n que lo primero que tiene que hacer, antes que configurar cualquier otro ajuste es cargar las variables de nuestro fichero. Esto lo tendremos que hacer en el fichero <em>application.rb</em>:</p>

<figure class='code'><figcaption><span>/config/application.rb  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>    <span class="c1"># Load the environment variables at beginning</span>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">before_configuration</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">env_file</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;local_env.yml&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="no">YAML</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">env_file</span><span class="p">))</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
</span><span class='line'>        <span class="no">ENV</span><span class="o">[</span><span class="n">key</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span class='line'>      <span class="k">end</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">env_file</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Si hemos hecho todo esto correctamente, al ejecutar la aplicaci√≥n en local todo deber√≠a funcionar perfectamente. El problema nos lo vamos a encontrar cuando despleguemos en Heroku. Heroku se apoya en el fichero git de nuestro proyecto para tomar toda la informaci√≥n. Del mismo modo que el fichero donde hemos incluido las variables de entorno no es visible en el repositorio (GitHub, Bitbucket,&#8230;) tampoco lo es para Heroku por lo que las variables de entorno nunca se cargar√°n al iniciar la aplicaci√≥n. Hemos de cargar estas variables de forma manual.</p>

<figure class='code'><figcaption><span>Carga de variables de entorno en Heroku  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>heroku config:add <span class="nv">CONSUMER_KEY</span><span class="o">=</span><span class="s1">&#39;Your_Consumer_Key&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Podemos hacer un fichero bash que ejecutaremos despu√©s de hacer el despliegue en heroku. Este script tendr√≠a la siguiente estructura:</p>

<figure class='code'><figcaption><span>Script para cargar variables de entorno en Heroku heroku.sh  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>heroku config:add <span class="nv">CONSUMER_KEY</span><span class="o">=</span><span class="s1">&#39;Your_Consumer_Key&#39;</span> <span class="nv">CONSUMER_SECRET</span><span class="o">=</span><span class="s1">&#39;Your_Consumer_Secret&#39;</span> <span class="nv">OAUTH_TOKEN</span><span class="o">=</span><span class="s1">&#39;Your_Oauth_Token&#39;</span> <span class="nv">OAUTH_TOKEN_SECRET</span><span class="o">=</span><span class="s1">&#39;Your_Oauth_Token_Secret&#39;</span> <span class="nv">NEW_RELIC_LICENSE_KEY</span><span class="o">=</span><span class="s1">&#39;Your_New_Relic_License_Key&#39;</span>;
</span><span class='line'>heroku info --app urlhunter-314159;
</span></code></pre></td></tr></table></div></figure>


<p>Y lo ejecutamos escribiendo en el terminal:</p>

<figure class='code'><figcaption><span>Script para cargar variables de entorno en Heroku  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sh heroku.sh
</span></code></pre></td></tr></table></div></figure>


<p>Listo. Ya podemos compartir el c√≥digo fuente del proyecto sin temor a que nadie pueda hacer uso de nuestras claves de terceros.</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Send to kindle para Octopress]]></title>
		<link href="http://javimoreno.me/blog/2013/03/22/send-to-kindle-para-octopress/"/>
		
	  <updated>2013-03-22T00:35:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/03/22/send-to-kindle-para-octopress</id>
	  
	  <content type="html"><![CDATA[<p>Cuando escrib√≠ la <a href="http://javimoreno.me/blog/2013/03/08/como-mola-octopress/"><em>oda</em> a Octopress</a> coment√© que me sent√≠a m√°s comodo con Ruby para tocar diversas partes del c√≥digo del blog, como por ejemplo los plugins. En esta entrada voy a aprovechar la noticia del bot√≥n de <a href="http://www.genbeta.com/web/amazon-lanza-su-boton-para-enviar-contenido-al-kindle-desde-un-sitio-web">enviar a kindle</a> para que ve√°is lo f√°cil que es hacer un plugin.</p>

<!--more-->


<p>En primer lugar, vamos a ir a la p√°gina de Amazon donde <a href="http://www.amazon.com/gp/sendtokindle/developers/button">configuramos el bot√≥n</a> a nuestro gusto y generamos el widget. Seg√∫n esta p√°gina, tendr√≠amos que seguir dos sencillos pasos para poner el bot√≥n en nuestra web:</p>

<ol>
<li>Insertar un script antes del cierre de la etiqueta <em>body</em>.</li>
<li>Insertar un trozo de HTML en el lugar donde queremos que aparezca el bot√≥n.</li>
</ol>


<p>Lo que nosotros queremos es que el bot√≥n aparezca al final de nuestras entradas, junto con los botones de Karmacracy, Twitter, Facebook y Google+. En primer lugar, crearemos una variable <em>send_to_kindle</em> en el fichero _config.yml.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># Send To Kindle Button</span>
</span><span class='line'><span class="l-Scalar-Plain">send_to_kindle</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>De esta forma, podremos elegir poner o no el bot√≥n en nuestro blog.</p>

<p>Octopress viene de serie con opciones para compartir en Twitter, Facebook, Google+, etc. El fichero donde est√°n recogidas las diferentes opciones se llama <em>sharing.html</em> y se encuentra en source/_includes/post/sharing.html. En este fichero es donde insertaremos el fragmento HTML del paso 2:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{ % if site.send_to_kindle %}
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;kindleWidget&quot;</span> <span class="na">style=</span><span class="s">&quot;display:inline-block;padding:3px;cursor:pointer;font-size:11px;font-family:Arial;border-radius:3px;border:#ccc thin solid;color:black;background:transparent url(&#39;https://d1xnn692s7u6t6.cloudfront.net/button-gradient.png&#39;) repeat-x;background-size:contain;&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;img</span> <span class="na">style=</span><span class="s">&quot;vertical-align:middle;&quot;</span> <span class="na">src=</span><span class="s">&quot;https://d1xnn692s7u6t6.cloudfront.net/black-15.png&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;span</span> <span class="na">style=</span><span class="s">&quot;vertical-align:middle;margin-left:3px;&quot;</span><span class="nt">&gt;</span>Send to Kindle<span class="nt">&lt;/span&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>{ % endif %}
</span></code></pre></td></tr></table></div></figure>


<p>Creo que lo que est√° pasando aqu√≠ es f√°cil de entender: solo si la variable global <em>send_to_kindle</em> esta configurada como true, se inyectar√° el fragmento HTML.</p>

<blockquote><p>Una aclaraci√≥n. El uso de variables, condiciones, etc en Jekyll se realiza encerrando los trozos de c√≥digo entre llave-porcentaje y porcentaje-llave. En el snippet anterior he escrito { % para que pudierais verlo porque de lo contrario, al generar esta entrada Jekyll habr√≠a interpretado que estaba intentando evaluar alguna condici√≥n y no lo habr√≠a mostrado. Si lo v√°is a copiar y pegar, acordaros de quitar el espacio entre { y %.</p></blockquote>

<p>Bueno, ya solo nos falta incluir el script al final del body de nuestra p√°gina. Ahora vamos a ver lo bien organizado que est√° todo en Octopress: en la carpeta source/_includes hay un archivo que se llama <em>after_footer.html</em>. Cuando lo editamos vemos que contiene <em>includes</em> de ficheros llamados google_plus_one.html, twitter_sharing.html, etc. Estos ficheros est√°n en la misma carpeta y al abrirlos podemos ver que contienen los scripts necesarios para los bot√≥nes de Google+, Twitter, etc.
Vamos a crear un nuevo fichero en esta misma carpeta llamado send_to_kindle.html y en el incluiremos el script que nos indican en Amazon que hay que poner al final del body. Nuevamente, evaluaremos si la variable para incluir el bot√≥n est√° a true:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{ % if site.send_to_kindle %}
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;https://d1xnn692s7u6t6.cloudfront.net/widget.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span><span class="p">(</span><span class="kd">function</span> <span class="nx">k</span><span class="p">(){</span><span class="nb">window</span><span class="p">.</span><span class="nx">$SendToKindle</span><span class="o">&amp;&amp;</span><span class="nb">window</span><span class="p">.</span><span class="nx">$SendToKindle</span><span class="p">.</span><span class="nx">Widget</span><span class="o">?</span><span class="nx">$SendToKindle</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">init</span><span class="p">({})</span><span class="o">:</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span><span class="mi">500</span><span class="p">);})();</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>{ % endif %}
</span></code></pre></td></tr></table></div></figure>


<p>Y en el archivo <em>after_footer.html</em> incluiremos el nuevo html que acabamos de crear:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>{ % include send_to_kindle.html %}
</span></code></pre></td></tr></table></div></figure>


<p>Listo, si ahora generamos y previsualizamos nuestro blog podremos ver un bot√≥n al final de cada art√≠culo para enviar el contenido al kindle.</p>

<p>Como v√©is, todo es muy intuitivo. Con un poco de sentido com√∫n y navegando por las carpetas del blog para ver como funcionan los plugins que vienen de serie podemos ir dejando Octopress a nuestro gusto.</p>

<p>Pd: No me gusta como queda el bot√≥n, sale m√°s alto de lo que se previsualiza en el sitio de Amaz√≥n. Mis conocimientos de css, javascript y html son bastante limitados por lo que no estoy seguro de si es algo que podamos corregir o si por el contrario est√° as√≠ en el widget.js y no podemos hacer nada. Tampoco me gusta que el bot√≥n de Karmacracy salga en una linea aparte pero son esas cosas que no he conseguido arreglar. Si vosotros hab√©is conseguido dejarlo mejor&#8230; decidme como!!!!</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Resac√≥n en Heroku]]></title>
		<link href="http://javimoreno.me/blog/2013/03/12/resacon-en-heroku/"/>
		
	  <updated>2013-03-12T02:15:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/03/12/resacon-en-heroku</id>
	  
	  <content type="html"><![CDATA[<p>Como era de esperar, el debut de <a href="http://urlhunter-314159.herokuapp.com">URLHunter</a> ha tenido alguna incidencia. <br/>
En un primer momento pens√© que todo era provocado por unos cambios de ultima hora que tuve que hacer en los tipos de campo de la entidad <em>Tweetlinks</em> al pasar de SQLite a PostgreSQL pero no, el problema ha sido de programador despistado.</p>

<!--more-->


<p>Este es el m√©todo que se encarga de la grabaci√≥n de los tweets en el modelo. Seg√∫n el API de Twitter, cada tweet retweeteado estar√° contenido dentro de otro tweet. El tweet <em>padre</em> siempre pertenecer√° al usuario que hace el retweet mientras que la informaci√≥n original estar√° en el anidado. Esta es la raz√≥n por la que al preguntar si el tweet es en realidad un retweet hay que hacer una sustituci√≥n del objeto <em>tweet</em>. El problema ha sido que la comprobaci√≥n de que el tweet_id no existe en la tabla se hac√≠a antes del cambio por lo que, en realidad, el que se terminaba grabando siempre era otro.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">insert_tweet</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
</span><span class='line'> <span class="k">unless</span> <span class="n">exists?</span><span class="p">(</span><span class="n">tweet_id</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>   <span class="k">if</span> <span class="n">tweet</span><span class="o">.</span><span class="n">retweet?</span>
</span><span class='line'>     <span class="n">tweet</span> <span class="o">=</span> <span class="n">tweet</span><span class="o">.</span><span class="n">retweeted_status</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>   <span class="k">if</span> <span class="n">tweet</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>     <span class="n">create!</span><span class="p">(</span>
</span><span class='line'>         <span class="n">tweet_id</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">content</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
</span><span class='line'>         <span class="n">screen_name</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name</span><span class="p">,</span>
</span><span class='line'>         <span class="n">profile_image</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile_image_url</span><span class="p">,</span>
</span><span class='line'>         <span class="n">tweet_created_at</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
</span><span class='line'>     <span class="p">)</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Este ser√≠a el c√≥digo correcto:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">insert_tweet</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
</span><span class='line'> <span class="k">if</span> <span class="n">tweet</span><span class="o">.</span><span class="n">retweet?</span>
</span><span class='line'>   <span class="n">tweet</span> <span class="o">=</span> <span class="n">tweet</span><span class="o">.</span><span class="n">retweeted_status</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'> <span class="k">unless</span> <span class="n">exists?</span><span class="p">(</span><span class="n">tweet_id</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>   <span class="k">if</span> <span class="n">tweet</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>     <span class="n">create!</span><span class="p">(</span>
</span><span class='line'>         <span class="n">tweet_id</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">content</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
</span><span class='line'>         <span class="n">screen_name</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name</span><span class="p">,</span>
</span><span class='line'>         <span class="n">profile_image</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile_image_url</span><span class="p">,</span>
</span><span class='line'>         <span class="n">tweet_created_at</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
</span><span class='line'>     <span class="p">)</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'> <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>A veces sucede que un error compensa a otro error y esto es lo que ha pasado esta vez. Al incluir la paginaci√≥n, se me olvido incluir un criterio de ordenaci√≥n en la query correspondiente. Debido a esto, el orden de presentaci√≥n era por inserci√≥n (ascendente). En la carga inicial se recuperan 200 tweets pero se empiezan a insertar de m√°s reciente a m√°s antiguo. Posteriormente, cada llamada a la p√°gina recupera los nuevos tweets y si corresponde insertarlos los inserta.   <br/>
A lo largo de la ma√±ana se pod√≠a ver como el n√∫mero de p√°ginas iba subiendo de seis hasta once que es a lo que ha llegado hasta que he podido hacer un peque√±o arreglo en Heroku. B√°sicamente las cinco nuevas p√°ginas conten√≠an el mismo tweet, en concreto el RT de mi tweet de presentaci√≥n&#8230; vamos un debut lamentable ;-)</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">home</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@tweetlinks</span> <span class="o">=</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@tweetlinks</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">first_time</span> <span class="p">:</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">pull_tweets</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="c1"># index.html.erb</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="vi">@tweetlinks</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Este ser√≠a la forma correcta:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">home</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@tweetlinks</span> <span class="o">=</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;tweet_id DESC&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@tweetlinks</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">first_time</span> <span class="p">:</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">pull_tweets</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="c1"># index.html.erb</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="vi">@tweetlinks</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>¬øC√≥mo lo he podido arreglar sin tocar el c√≥digo?</h2>

<p>Una vez identificado el problema, y viendo que los amigos de <a href="http://twitter.com/ObjectiveC_es">@ObjectiveC_es</a> hab√≠an tweeteado alg√∫n enlace m√°s lo √∫nico que hab√≠a que hacer era hacer un rollback de la base de datos, borrarla completamente y volverla a crear. La primera carga de la base de datos recuperar√≠a hasta un tweet normal y mientras no hicieran otro retweet de un enlace no se volver√≠a a producir el problema.</p>

<p>Por los pelos, la pr√≥xima vez ser√© m√°s prudente y hare una beta. :-)</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Como se hizo URLHunter]]></title>
		<link href="http://javimoreno.me/blog/2013/03/11/como-se-hizo-urlhunter/"/>
		
	  <updated>2013-03-11T02:43:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/03/11/como-se-hizo-urlhunter</id>
	  
	  <content type="html"><![CDATA[<p>Vamos a demostrar que no hace falta ser un figura para hacer algo muy util y aparente. Vaya por delante que, si somos capaces de hacer esto es porque existen p√°ginas como las de <a href="http://railscasts.com" title="Railscasts">Railscasts</a>.<br/>
Lo primero que hacemos despu√©s de crear nuestro nuevo proyecto Rails es instalar las gemas necesarias para trabajar con Twitter Bootstrap, del que somos fans.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;therubyracer&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;less-rails&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;twitter-bootstrap-rails&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<p>Despu√©s de cargar las gemas en nuestro proyecto con Bundle Install, terminamos de instalar Bootstrap en nuestro proyecto con la siguiente instrucci√≥n:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rake</span> <span class="n">g</span> <span class="ss">bootstrap</span><span class="p">:</span><span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<p>El prop√≥sito de nuestra aplicaci√≥n es mostrar un listado de los tweets de <a href="http://twitter.com/objectivec_es" title="@ObjectiveC_es">@objectivec_es</a> que contienen una url. De esta forma tendremos agrupados en una web toda esa informaci√≥n tan interesante que van soltando a nuestro timeline y que muchas veces perdemos por no hacer un favorito a tiempo. Dicho esto, de primeras lo que vamos a necesitar es una p√°gina en la que mostraremos informaci√≥n procedente del API de Twitter.</p>

<p>Creamos un controlador para las p√°ginas de contenido est√°tico:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">rake</span> <span class="n">g</span> <span class="n">controller</span> <span class="no">StaticPages</span> <span class="n">home</span> <span class="n">help</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y hacemos algunos ajuste en el <em>layout</em> general para empezar a beneficiarnos de Twitter Bootstrap</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;title&gt;</span>URLHunter<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>  <span class="c">&lt;!--[if lt IE 9]&gt;</span>
</span><span class='line'><span class="c">  &lt;script src=&quot;http://html5shim.googlecode.com/svn/trunk/html5.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="c">  &lt;![endif]--&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>%= stylesheet_link_tag    &quot;application&quot;, :media =&gt; &quot;all&quot; %&gt;
</span><span class='line'>  <span class="err">&lt;</span>%= javascript_include_tag &quot;application&quot; %&gt;
</span><span class='line'>  <span class="err">&lt;</span>%= csrf_meta_tags %&gt;
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span9&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= yield %&gt;<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span3&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h2&gt;</span>¬øPor qu√©?<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>      <span class="nt">&lt;p&gt;</span>Porque alguien ten√≠a que hacerlo. Si no, Twitter volver√≠a a cambiar su API para eliminar la funcionalidad de favoritos.<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Accediendo al API de Twitter</h2>

<p>Para recuperar el timelime de nuestra &#8220;presa&#8221; podemos desarrollar las llamadas que necesitemos o utilizar la gema &#8220;Twitter&#8221;. Siguiendo la filosf√≠a DRY y como hay otras cosas mucho mejores que hacer, nosotros nos decantamos por la gema.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;twitter&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Antiguamente ya podr√≠amos hacer algunas pruebas con la consola pero en los tiempos que corren hay que autenticarse. Para ello, siguiendo la documentaci√≥n de la gema, hay que crear un fichero de inicializaci√≥n en /config/initializers llamado twitter.rb:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Twitter</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">consumer_key</span> <span class="o">=</span> <span class="no">YOUR_CONSUMER_KEY</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">consumer_secret</span> <span class="o">=</span> <span class="no">YOUR_CONSUMER_SECRET</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">oauth_token</span> <span class="o">=</span> <span class="no">YOUR_OAUTH_TOKEN</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">oauth_token_secret</span> <span class="o">=</span> <span class="no">YOUR_OAUTH_TOKEN_SECRET</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Una vez hayamos reemplazado los valores aplantillados con los que podemos encontrar en la secci√≥n de &#8220;Mis applicaciones&#8221; de la web de desarrolladores de Twitter ya estaremos en condiciones de empezar a consumir datos de Twitter.</p>

<p>Inicialmente, vamos a probar que tal funciona todo incluyendo lo siguiente en el home.html.erb:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;h1&gt;</span>Todos los links de @objectivec_es<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;tweets-with-links&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>% Twitter.user_timeline(&quot;objectivec_es&quot;, :count =&gt; 10, :exclude_replies =&gt; true).each do |tweet| %&gt;
</span><span class='line'>    <span class="nt">&lt;blockquote&gt;</span> <span class="err">&lt;</span>%= tweet.text %&gt; <span class="nt">&lt;/blockquote&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>% end %&gt;
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>¬øIgualito que en iOS, eh? Bueno, cada uno tiene sus virtudes. En cualquier caso, aunque hemos obtenido rapidos resultados no podemos decir que sean <em>bonitos</em>. Lo suyo ser√≠a que los hashtags, las menciones y los links tuvieran los vinculos correspondientes. Para eso vamos a utilizar otra gema.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>gem <span class="s1">&#39;twitter-text&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Seg√∫n la documentaci√≥n de la gema, para <em>autolinkar</em> las entidades lo √∫nico que tenemos que hacer es lo siguiente:</p>

<p>A <em>app/helpers/application_helper.rb</em> lo dejaremos de esta forma</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ApplicationHelper</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Twitter</span><span class="p">:</span><span class="ss">:Autolink</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y en <em>home.html.erb</em> cambiaremos el contenido de la cita por lo siguiente:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;blockquote&gt;</span> <span class="nt">&lt;p&gt;</span><span class="err">&lt;</span>%= auto_link(tweetlink.content).html_safe %&gt;<span class="nt">&lt;/p&gt;</span> <span class="nt">&lt;/blockquote&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Es necesario poner html_safe al final para que Rails interprete que le estamos pasando un texto que contiene etiquetas HTML, si no lo hicieramos las etiquetas se pintar√≠an como si fuera texto plano.</p></blockquote>

<p>Si recargamos ahora la p√°gina veremos todos los tweets con enlaces a los usuarios mencionados, a los hasgtags&#8230; Como dir√≠a Duke Nukem: &#8220;Ah!, much better!!!&#8221;</p>

<p>Lo siguiente que vamos a hacer es almacenar los tweets en base de datos. ¬øPor qu√©?, pues por varios motivos:</p>

<ul>
<li>No queremos perder ni una sola de estas p√≠ldoras de informaci√≥n</li>
<li>Ahora no son muchos pero cuando los chicos de <a href="http://twitter.com/objectivec_es" title="@ObjectiveC_es">@ObjectiveC_es</a> vayan por los 3000 tweets esta web tardar√° bastante m√°s en cargar</li>
<li>En esta vida, no eres nadie si no haces un poco de persistencia.</li>
</ul>


<p>As√≠ que crearemos un modelo para almacenar algunos datos. Inicialmente ser√° muy sencillo, ya lo complicaremos m√°s adelante:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>rails g model tweetlink tweet_id screen_name content:text profile_image tweet_created_at
</span></code></pre></td></tr></table></div></figure>


<p>e incluiremos algunos m√©todos de conveniencia en la nueva clase:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Tweetlink</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:screen_name</span><span class="p">,</span> <span class="ss">:tweet_id</span><span class="p">,</span> <span class="ss">:profile_image</span><span class="p">,</span> <span class="ss">:tweet_created_at</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">first_time</span>
</span><span class='line'>    <span class="no">Twitter</span><span class="o">.</span><span class="n">user_timeline</span><span class="p">(</span><span class="s2">&quot;objectivec_es&quot;</span><span class="p">,</span> <span class="ss">:count</span> <span class="o">=&gt;</span> <span class="mi">3200</span><span class="p">,</span> <span class="ss">:exclude_replies</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">tweet</span><span class="o">|</span>
</span><span class='line'>      <span class="n">insert_tweet</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">pull_tweets</span>
</span><span class='line'>    <span class="no">Twitter</span><span class="o">.</span><span class="n">user_timeline</span><span class="p">(</span><span class="s2">&quot;objectivec_es&quot;</span><span class="p">,</span> <span class="ss">:count</span> <span class="o">=&gt;</span> <span class="mi">200</span><span class="p">,</span> <span class="ss">:exclude_replies</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:since_id</span> <span class="o">=&gt;</span> <span class="n">maximum</span><span class="p">(</span><span class="ss">:tweet_id</span><span class="p">))</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">tweet</span><span class="o">|</span>
</span><span class='line'>      <span class="n">insert_tweet</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">insert_tweet</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span>
</span><span class='line'>   <span class="k">unless</span> <span class="n">exists?</span><span class="p">(</span><span class="n">tweet_id</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>     <span class="k">if</span> <span class="n">tweet</span><span class="o">.</span><span class="n">retweet?</span>
</span><span class='line'>       <span class="n">tweet</span> <span class="o">=</span> <span class="n">tweet</span><span class="o">.</span><span class="n">retweeted_status</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>     <span class="k">if</span> <span class="n">tweet</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>       <span class="n">create!</span><span class="p">(</span>
</span><span class='line'>           <span class="n">tweet_id</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span class='line'>           <span class="ss">content</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
</span><span class='line'>           <span class="n">screen_name</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">screen_name</span><span class="p">,</span>
</span><span class='line'>           <span class="n">profile_image</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">profile_image_url</span><span class="p">,</span>
</span><span class='line'>           <span class="n">tweet_created_at</span><span class="p">:</span> <span class="n">tweet</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
</span><span class='line'>       <span class="p">)</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>A continuaci√≥n, tendremos que cambiar el controlador y la vista ya que ahora mismo todav√≠a est√°n recuperando la informaci√≥n directamente desde el API.</p>

<p>El metodo <em>home</em> quedar√° de la siguiente manera:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">home</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@tweetlinks</span> <span class="o">=</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@tweetlinks</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">first_time</span> <span class="p">:</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">pull_tweets</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="c1"># index.html.erb</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="vi">@tweetlinks</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Y la vista de esta otra forma:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;h1&gt;</span>Todos los links de @objectivec_es<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;tweets-with-links&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>% @tweetlinks.each do |tweetlink| %&gt;
</span><span class='line'>    <span class="nt">&lt;blockquote&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= image_tag tweetlink.profile_image %&gt;
</span><span class='line'>      <span class="err">&lt;</span>%= tweetlink.screen_name %&gt; wrote at
</span><span class='line'>      <span class="err">&lt;</span>%= l DateTime.parse(tweetlink.tweet_created_at), :format =&gt; :long %&gt;
</span><span class='line'>      <span class="nt">&lt;p&gt;</span><span class="err">&lt;</span>%= auto_link(tweetlink.content).html_safe %&gt;<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/blockquote&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>% end %&gt;
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Para terminar vamos a incluir paginaci√≥n, esto reducir√° el tiempo de carga de la p√°gina y mejorar√° la usabilidad. Otra vez m√°s, podriamos escribir todo el c√≥digo necesario para montar una paginaci√≥n pero con un par de gemas lo podemos dejar solucionado:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;bootstrap-will_paginate&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>La gema <em>will_paginate</em> es la que se encarga de la gesti√≥n de la paginaci√≥n. Lo √∫nico que tendremos que hacer es cambiar el n√∫mero de registros que recuperamos de la clase Tweetlink en el controlador. En lugar de <em>all</em> usaremos <em>paginate</em>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">home</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@tweetlinks</span> <span class="o">=</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">page</span><span class="p">:</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="vi">@tweetlinks</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">first_time</span> <span class="p">:</span> <span class="no">Tweetlink</span><span class="o">.</span><span class="n">pull_tweets</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="c1"># index.html.erb</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="vi">@tweetlinks</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>En el layout, indicaremos donde queremos que aparezca el componente de paginaci√≥n. La gema <em>bootstrap-will_paginate</em> aplica los estilos de Twitter Bootstrap a paginaci√≥n.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;h1&gt;</span>Todos los links de @objectivec_es<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'><span class="err">&lt;</span>%= will_paginate @tweetlinks %&gt;
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>% @tweetlinks.each do |tweetlink| %&gt;
</span><span class='line'>    <span class="nt">&lt;blockquote&gt;</span>
</span><span class='line'>      <span class="err">&lt;</span>%= image_tag tweetlink.profile_image %&gt;
</span><span class='line'>      <span class="err">&lt;</span>%= tweetlink.screen_name %&gt; wrote at
</span><span class='line'>      <span class="err">&lt;</span>%= l DateTime.parse(tweetlink.tweet_created_at), :format =&gt; :long %&gt;
</span><span class='line'>      <span class="nt">&lt;p&gt;</span><span class="err">&lt;</span>%= auto_link(tweetlink.content).html_safe %&gt;<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/blockquote&gt;</span>
</span><span class='line'>  <span class="err">&lt;</span>% end %&gt;
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="err">&lt;</span>%= will_paginate @tweetlinks %&gt;
</span></code></pre></td></tr></table></div></figure>


<p>Y listo, podr√≠amos seguir incluyendo muchas mejoras y posiblemente es lo que haga en los pr√≥ximos d√≠as pero por el momento&#8230; esto es todo.</p>

<p>El c√≥digo fuente lo puedes encontrar en <a href="https://github.com/jmoreno/URLHunter/tree/GitHub">Github</a></p>

<h2>ACTUALIZACI√ìN 12/03/2013</h2>

<p>He corregido los fragmentos de c√≥digo que er√°n err√≥neos. En la siguiente entrada ten√©is una explicaci√≥n de los errores. Disculpad las molestias.</p>
]]></content>
		
	</entry>
  
	<entry>
	  
		<title type="html"><![CDATA[Como mola Octopress]]></title>
		<link href="http://javimoreno.me/blog/2013/03/08/como-mola-octopress/"/>
		
	  <updated>2013-03-08T02:10:00+00:00</updated>
	  <id>http://javimoreno.me/blog/2013/03/08/como-mola-octopress</id>
	  
	  <content type="html"><![CDATA[<p>Estoy disfrutando como un enano con <a href="http://octopress.org">Octopress</a>. Como ya cont√© en el anterior post, he probado unos cuantos servicios para publicar blogs y a grandes rasgos todos me han parecido iguales: un men√∫ de configuraci√≥n en el que puedes tocar cuatro cosas, la promesa de que a trav√©s de CSS te lo puedes configurar a tu gusto y en ocasiones una oferta de plugins que nunca terminan de hacer lo que crees que deben hacer.</p>

<p>Si analizamos lo que ofrece Octopress, posiblemente Wordpress sea el que m√°s se le parezca (no creo que el nombre sea casualidad). Se puede descargar toda el proyecto del blog desde la p√°gina de <a href="http://wordpress.org">wordpress.org</a>, se configura un MySQL, se tocan un par de ficheros, se sube a un hosting de php y a disfrutar del blog&#8230; todo un mundo de maravillosos plugins y temas est√° a tu disposici√≥n. <br/>
El problema es que php y yo no terminamos de llevarnos bien.</p>

<!--more-->


<p>No tengo nada en contra de PHP, es un lenguaje muy extendido, con muchisima documentaci√≥n a lo largo y ancho de internet, con el que se pueden hacer muchisimas cosas, f√°cil de aprender y con una gran oferta de hosting. Durante casi un a√±o he tenido un blog wordpress instalado en un hosting gratuito. En todo este a√±o podr√≠a haber creado p√°ginas, modificado los plugins que no hac√≠an lo que yo quer√≠a, cambiado los estilos,&#8230; pero el caso es que no lo he hecho.</p>

<p>Sin embargo, en los poco menos de un mes que llevo con octopress he creado p√°ginas, cambiado estilos, modificado plugins e incluso creando alguno nuevo pero lo m√°s importante es que&#8230; <strong>TENGO GANAS DE ESCRIBIR</strong></p>

<h2>¬øQu√© es Octopress?</h2>

<p>Octopress est√° basado en Jekyll, un generador de blogs est√°ticos. Jekyll propone una estructura de carpetas para el sitio web, las p√°ginas se escriben en formato Textile, Markdown o Liquid y Jekyll se encarga de generar el contenido web est√°tico en HTML. Octopress a√±ade a Jekyll unas plantillas para entradas de blog y p√°ginas, un tema por defecto que se adapta a cualquier pantalla y es HTML5, la automatizaci√≥n con Rake de determinadas tareas como la creaci√≥n de entradas, el generado del blog, la previsualizaci√≥n del blog, el despliegue en Github (y tambi√©n en Heroku y en Rsync), la limpieza de la cache&#8230; En muchos aspectos me recuerda a Rails.</p>

<p>Adem√°s, a mi me esta viniendo muy bien para practicar Git. Mi flujo de trabajo ser√≠a el siguiente:
- Creo una nueva rama cuando voy a escribir o probar alguna cosa.
- Hago lo que tenga que hacer en la nueva rama
- Si todo esta bien o he terminado de escribir la entrada hago el merge a la rama <em>source</em>
- G√©nero el blog, lo despliego y hago push al repositorio de GitHub.</p>

<p>A muchos les parecer√° una vuelta al pasado, a mi es lo que m√°s me gusta: la sensaci√≥n de que mi blog es una aplicaci√≥n desarrollada por mi y de la que yo controlo hasta el √∫ltimo detalle. El hecho de que el contenido ya no sea din√°mico (aunque esto no es del todo cierto ya que hay determinadas partes del blog que est√°n hechas en javascript, precisamente para darle dinamismo) resulta chocante al principio pero buscando un poco por internet encuentras grandes defensores de este tipo de sitios sobre todo en casos en los que el blog est√° alojado en un servidor personal y una alta demanda pod√≠a provocar discontinuidades en el servicio. Dudo mucho de que este vaya a ser mi caso, pero no est√° de m√°s tomar alguna medida. :-)</p>

<h2>Editando el blog</h2>

<p>En mi caso, la edici√≥n del blog la hago con Sublime Text. Una de las cosas que m√°s echar√°n en falta los que tengan Wordpress es que no hay una aplicaci√≥n nativa con la que puedas gestionar tu blog en cualquier momento y situaci√≥n pero es lo que tiene <em>compilar</em> un blog, que necesitas tu equipo del d√≠a a d√≠a para hacer alguna correci√≥n o para publicar una nueva entrada. Creo que la aparaci√≥n en el App Store de programas como <a href="https://itunes.apple.com/es/app/pythonista/id528579881">Pythonista</a> acabar√°n trayendo la posibilidad de generar y desplegar el blog desde un iPad o un iPhone pero de momento, lo √∫nico que se puede hacer desde un dispositivo m√≥vil es ir escribiendo alguna entrada que otra. En mi caso utilizo <a href="https://itunes.apple.com/us/app/ia-writer/id392502056?l=es&amp;mt=8">iA Writer</a> y la sincronizaci√≥n con Dropbox.   <br/>
Para que os hag√°is una idea, est√° entrada se empezo a escribir en el mac, la parte central la escribi en el metro mientras iba a trabajar y estoy terminando de escribirla ahora otra vez en el mac. El paso de creaci√≥n de entrada hay que hacerlo con <em>rake</em> pero puedes ir empezando a escribir lo que tengas pensado en cualquier sitio, para eso se invento el corta-pega.</p>

<p>Otro d√≠a hablar√© un poco m√°s de los plugins, de las plantillas Liquid y cosas as√≠. No hace falta ser un experto para tocar un par de scripts o buscar alguna cosa en internet y hacerte la vida un poco m√°s f√°cil.</p>
]]></content>
		
	</entry>
  
</feed>
